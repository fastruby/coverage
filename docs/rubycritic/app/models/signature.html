<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../overview.html"><img src="../../assets/images/logo.png" alt="Ruby Critic Logo" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
      
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2019-07-18 15:50:31 +0100'>2019-07-18 15:50:31 +0100</time>
        
      </span>
    </div>
    <div>
      <h3><small>app/models /</small> signature.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">782</span><small> lines of codes</small></div>
              <div><span class="metric">104</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">8.9</span><small> complexity/method</small></div>
              <div><span class="metric">139</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">929.64</span><small> complexity</small></div>
              <div><span class="metric">278</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                58
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;active_support/core_ext/digest/uuid&#39;
require &#39;postcode_sanitizer&#39;
require &#39;ipaddr&#39;

class Signature &lt; ActiveRecord::Base<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Signature assumes too much for instance variable '@just_validated'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Signature has no descriptive comment</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Constants.md" target="_blank"><b>TooManyConstants</b></a>        </span>      </div>      <span>Signature has 7 constants</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Methods.md" target="_blank"><b>TooManyMethods</b></a>        </span>      </div>      <span>Signature has at least 104 methods</span>          </div>  </li></ol>
  include PerishableTokenGenerator
  include GeoipLookup

  has_perishable_token
  has_perishable_token called: &#39;signed_token&#39;
  has_perishable_token called: &#39;unsubscribe_token&#39;

  ISO8601_TIMESTAMP = /\A\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z\z/

  PENDING_STATE = &#39;pending&#39;
  FRAUDULENT_STATE = &#39;fraudulent&#39;
  VALIDATED_STATE = &#39;validated&#39;
  INVALIDATED_STATE = &#39;invalidated&#39;

  STATES = [
    PENDING_STATE, FRAUDULENT_STATE,
    VALIDATED_STATE, INVALIDATED_STATE
  ]

  TIMESTAMPS = {
    &#39;government_response&#39; =&gt; :government_response_email_at,
    &#39;debate_scheduled&#39;    =&gt; :debate_scheduled_email_at,
    &#39;debate_outcome&#39;      =&gt; :debate_outcome_email_at,
    &#39;petition_email&#39;      =&gt; :petition_email_at
  }

  belongs_to :petition
  belongs_to :invalidation

  validates :state, inclusion: { in: STATES }
  validates :name, presence: true, length: { maximum: 255 }
  validates :email, presence: true, email: { allow_blank: true }, on: :create
  validates :location_code, presence: true
  validates :postcode, presence: true, postcode: true, if: :united_kingdom?
  validates :postcode, length: { maximum: 255 }, allow_blank: true
  validates :uk_citizenship, acceptance: true, unless: :persisted?, allow_nil: false
  validates :constituency_id, length: { maximum: 255 }

  attr_readonly :sponsor, :creator

  before_create if: :email? do
    self.uuid = generate_uuid
    self.canonical_email = Domain.normalize(email)

    if find_duplicate
      raise ActiveRecord::RecordNotUnique, &quot;Signature is not unique: #{name}, #{email}, #{postcode}&quot;
    end

    if find_similar
      raise ActiveRecord::RecordNotUnique, &quot;Signature is not unique: #{name}, #{email}, #{postcode}&quot;
    end
  end

  before_destroy do
    !creator?
  end

  after_destroy do
    if validated?
      now = Time.current
      ConstituencyPetitionJournal.invalidate_signature_for(self, now)
      CountryPetitionJournal.invalidate_signature_for(self, now)
      petition.decrement_signature_count!(now)
    end
  end

  class &lt;&lt; self
    def batch(id = 0, limit: 1000)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/signature.html#L45" class="js-smell-location">0</a>                  <a href="signature.html#L73" class="js-smell-location">1</a>                  </div>  </li></ol>
      where(arel_table[:id].gt(id)).order(id: :asc).limit(limit)
    end

    def by_most_recent
      order(created_at: :desc)
    end

    def column_name_for(timestamp)
      TIMESTAMPS.fetch(timestamp)
    rescue KeyError =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Signature#column_name_for has the variable name 'e'</span>          </div>  </li></ol>
      raise ArgumentError, &quot;Unknown petition email timestamp: #{timestamp.inspect}&quot;
    end

    def destroy!(signature_ids)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Signature has missing safe method 'destroy!'</span>          </div>  </li></ol>
      signatures = find(signature_ids)

      transaction do
        signatures.each do |signature|
          signature.destroy!
        end
      end
    end

    def duplicate(id, email)
      where(arel_table[:id].not_eq(id).and(arel_table[:email].eq(email)))
    end

    def duplicate_emails<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Signature::duplicate_emails has a flog score of 28</span>          </div>  </li></ol>
      unscoped.from(validated.select(:uuid).group(:uuid).having(arel_table[Arel.star].count.gt(1))).count
    end

    def pending_rate
      (Rational(pending.count, total.count) * 100).to_d(2)
    end

    def similar(id, email)
      where(canonical_email: email).where.not(id: id)
    end

    def for_domain(domain)
      where(&quot;SUBSTRING(email FROM POSITION(&#39;@&#39; IN email) + 1) = ?&quot;, domain[1..-1])
    end

    def for_email(email)
      where(&quot;(REGEXP_REPLACE(LEFT(email, POSITION(&#39;@&#39; IN email) - 1), &#39;\\.|\\+.+&#39;, &#39;&#39;, &#39;g&#39;) || SUBSTRING(email FROM POSITION(&#39;@&#39; IN email)) = ?)&quot;, normalize_email(email))
    end

    def for_invalidating
      where(state: [PENDING_STATE, VALIDATED_STATE])
    end

    def for_ip(ip)
      where(&quot;inet(ip_address) &lt;&lt;= inet(?)&quot;, ip)
    end

    def for_name(name)
      where(arel_table[:name].lower.eq(name.downcase))
    end

    def for_petition(id)
      where(petition_id: id)
    end

    def for_postcode(postcode)
      where(postcode: PostcodeSanitizer.call(postcode))
    end

    def for_sector(postcode)
      where(&quot;LEFT(postcode, -3) = ?&quot;, PostcodeSanitizer.call(postcode)[0..-4])
    end

    def for_timestamp(timestamp, since:)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/signature.html#L97" class="js-smell-location">0</a>                  <a href="signature.html#L145" class="js-smell-location">1</a>                  </div>  </li></ol>
      column = arel_table[column_name_for(timestamp)]
      where(column.eq(nil).or(column.lt(since)))
    end

    def fraudulent
      where(state: FRAUDULENT_STATE)
    end

    def fraudulent_domains
      where(state: FRAUDULENT_STATE).
      select(&quot;SUBSTRING(email FROM POSITION(&#39;@&#39; IN email) + 1) AS domain&quot;).
      group(&quot;SUBSTRING(email FROM POSITION(&#39;@&#39; IN email) + 1)&quot;).
      order(&quot;COUNT(*) DESC&quot;).
      count(:all)
    end

    def invalidate!(signature_ids, now = Time.current, invalidation_id = nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Signature has missing safe method 'invalidate!'</span>          </div>  </li></ol>
      signatures = find(signature_ids)

      transaction do
        signatures.each do |signature|
          signature.invalidate!(now, invalidation_id)
        end
      end
    end

    def invalidated
      where(state: INVALIDATED_STATE)
    end

    def missing_constituency_id(since: nil)
      if since
        uk.validated(since: since).where(constituency_id: nil)
      else
        uk.validated.where(constituency_id: nil)
      end
    end

    def need_emailing_for(timestamp, since:)
      validated.subscribed.for_timestamp(timestamp, since: since)
    end

    def pending
      where(state: PENDING_STATE)
    end

    def total
      where(state: [PENDING_STATE, VALIDATED_STATE])
    end

    def petition_ids_signed_since(timestamp)
      validated(since: timestamp).distinct.pluck(:petition_id)
    end

    def search(query, options = {})<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Signature::search has a flog score of 78</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Signature#search has approx 20 statements</span>          </div>  </li></ol>
      query  = query.to_s
      state  = options[:state]
      window = options[:window]
      page   = [options[:page].to_i, 1].max
      scope  = preload(:petition).by_most_recent

      if state.in?(STATES)
        scope = scope.where(state: state)
      end

      if window.present?
        if window =~ ISO8601_TIMESTAMP
          starts_at = window.in_time_zone.at_beginning_of_hour<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/signature.html#L134" class="js-smell-location">0</a>                  <a href="signature.html#L213" class="js-smell-location">1</a>                  </div>  </li></ol>
          ends_at = starts_at.advance(hours: 1)
          scope = scope.where(created_at: starts_at..ends_at)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Signature#search calls 'scope.where(created_at: starts_at..ends_at)' 2 times</span>              <span>Locations:</span>                  <a href="signature.html#L215" class="js-smell-location">0</a>                  <a href="signature.html#L219" class="js-smell-location">1</a>                  </div>  </li></ol>
        elsif window =~ /\A\d+\z/
          starts_at = window.to_i.seconds.ago
          ends_at = Time.current
          scope = scope.where(created_at: starts_at..ends_at)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Signature#search calls 'scope.where(created_at: starts_at..ends_at)' 2 times</span>              <span>Locations:</span>                  <a href="signature.html#L215" class="js-smell-location">0</a>                  <a href="signature.html#L219" class="js-smell-location">1</a>                  </div>  </li></ol>
        end<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/signature.html#L141" class="js-smell-location">0</a>                  <a href="signature.html#L220" class="js-smell-location">1</a>                  </div>  </li></ol>
      end

      if ip_search?(query)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/signature.html#L143" class="js-smell-location">0</a>                  <a href="signature.html#L223" class="js-smell-location">1</a>                  </div>  </li></ol>
        scope = scope.for_ip(query)
      elsif domain_search?(query)
        scope = scope.for_domain(query)
      elsif email_search?(query)
        scope = scope.for_email(query)
      elsif petition_search?(query)
        scope = scope.for_petition(query)
      elsif postcode_search?(query)
        scope = scope.for_postcode(query)
      elsif sector_search?(query)
        scope = scope.for_sector(query)
      else
        scope = scope.for_name(query)
      end

      scope.paginate(page: page, per_page: 50)
    end

    def creator
      where(arel_table[:creator].eq(true))
    end

    def sponsors
      where(arel_table[:sponsor].eq(true))
    end

    def subscribed
      where(notify_by_email: true)
    end

    def fraudulent_domains(since: 1.hour.ago, limit: 20)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Signature::fraudulent_domains has a flog score of 39</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Signature takes parameters ['limit', 'since'] to 4 methods</span>              <span>Locations:</span>                  <a href="signature.html#L254" class="js-smell-location">0</a>                  <a href="signature.html#L264" class="js-smell-location">1</a>                  <a href="signature.html#L274" class="js-smell-location">2</a>                  <a href="signature.html#L284" class="js-smell-location">3</a>                  </div>  </li></ol>
      select(&quot;SUBSTRING(email FROM POSITION(&#39;@&#39; IN email) + 1) AS domain&quot;).
      where(arel_table[:created_at].gt(since)).
      where(state: FRAUDULENT_STATE).
      group(&quot;SUBSTRING(email FROM POSITION(&#39;@&#39; IN email) + 1)&quot;).
      order(&quot;COUNT(*) DESC&quot;).
      limit(limit).
      count(:all)
    end

    def fraudulent_ips(since: 1.hour.ago, limit: 20)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Signature::fraudulent_ips has a flog score of 29</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Signature takes parameters ['limit', 'since'] to 4 methods</span>              <span>Locations:</span>                  <a href="signature.html#L254" class="js-smell-location">0</a>                  <a href="signature.html#L264" class="js-smell-location">1</a>                  <a href="signature.html#L274" class="js-smell-location">2</a>                  <a href="signature.html#L284" class="js-smell-location">3</a>                  </div>  </li></ol>
      select(:ip_address).
      where(arel_table[:created_at].gt(since)).
      where(state: FRAUDULENT_STATE).
      group(:ip_address).
      order(&quot;COUNT(*) DESC&quot;).
      limit(limit).
      count(:all)
    end

    def trending_domains(since: 1.hour.ago, limit: 20)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Signature::trending_domains has a flog score of 37</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Signature takes parameters ['limit', 'since'] to 4 methods</span>              <span>Locations:</span>                  <a href="signature.html#L254" class="js-smell-location">0</a>                  <a href="signature.html#L264" class="js-smell-location">1</a>                  <a href="signature.html#L274" class="js-smell-location">2</a>                  <a href="signature.html#L284" class="js-smell-location">3</a>                  </div>  </li></ol>
      select(&quot;SUBSTRING(email FROM POSITION(&#39;@&#39; IN email) + 1) AS domain&quot;).
      where(arel_table[:validated_at].gt(since)).
      where(arel_table[:invalidated_at].eq(nil)).
      group(&quot;SUBSTRING(email FROM POSITION(&#39;@&#39; IN email) + 1)&quot;).
      order(&quot;COUNT(*) DESC&quot;).
      limit(limit).
      count(:all)
    end

    def trending_ips(since: 1.hour.ago, limit: 20)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Signature::trending_ips has a flog score of 37</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Signature takes parameters ['limit', 'since'] to 4 methods</span>              <span>Locations:</span>                  <a href="signature.html#L254" class="js-smell-location">0</a>                  <a href="signature.html#L264" class="js-smell-location">1</a>                  <a href="signature.html#L274" class="js-smell-location">2</a>                  <a href="signature.html#L284" class="js-smell-location">3</a>                  </div>  </li></ol>
      select(:ip_address).
      where(arel_table[:validated_at].gt(since)).
      where(arel_table[:invalidated_at].eq(nil)).
      group(:ip_address).
      order(&quot;COUNT(*) DESC&quot;).
      limit(limit).
      count(:all)
    end

    def trending_domains_by_petition(window, threshold = 5)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Signature::trending_domains_by_petition has a flog score of 34</span>          </div>  </li></ol>
      trending_domains = Hash.new { |h, k| h[k] = {} }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Signature#trending_domains_by_petition has the variable name 'h'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Signature#trending_domains_by_petition has the variable name 'k'</span>          </div>  </li></ol>
      domain = &quot;SUBSTRING(email FROM POSITION(&#39;@&#39; IN email) + 1)&quot;

      where(validated_at: window)
        .group(:petition_id, domain)
        .having(count_star.gteq(threshold))
        .order(:petition_id, count_star.desc)
        .pluck(:petition_id, domain, count_star.to_sql)
        .each_with_object(trending_domains) do |(petition_id, domain, count), hash|
          hash[petition_id][domain] = count
        end
    end

    def trending_ips_by_petition(window, threshold = 5, ignored_domains = [])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Signature::trending_ips_by_petition has a flog score of 38</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Signature#trending_ips_by_petition has approx 7 statements</span>          </div>  </li></ol>
      trending_ips = Hash.new { |h, k| h[k] = {} }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Signature#trending_ips_by_petition has the variable name 'h'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Signature#trending_ips_by_petition has the variable name 'k'</span>          </div>  </li></ol>
      domain_not_in = &quot;SUBSTRING(email FROM POSITION(&#39;@&#39; IN email) + 1) NOT IN (?)&quot;

      scope = where(validated_at: window)

      unless ignored_domains.empty?
        scope = scope.where(domain_not_in, ignored_domains)
      end

      scope
        .group(:petition_id, :ip_address)
        .having(count_star.gteq(threshold))
        .order(:petition_id, count_star.desc)
        .pluck(:petition_id, :ip_address, count_star.to_sql)
        .each_with_object(trending_ips) do |(petition_id, ip_address, count), hash|
          hash[petition_id][ip_address] = count
        end
    end

    def uk
      where(location_code: &quot;GB&quot;)
    end

    def unarchived
      where(archived_at: nil)
    end

    def subscribe!(signature_ids)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/signature.html#L162" class="js-smell-location">0</a>                  <a href="signature.html#L336" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Signature has missing safe method 'subscribe!'</span>          </div>  </li></ol>
      signatures = find(signature_ids)

      transaction do
        signatures.each do |signature|
          signature.update!(notify_by_email: true)
        end
      end
    end

    def unsubscribe!(signature_ids)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/signature.html#L172" class="js-smell-location">0</a>                  <a href="signature.html#L346" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Signature has missing safe method 'unsubscribe!'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Signature#unsubscribe! has approx 6 statements</span>          </div>  </li></ol>
      signatures = find(signature_ids)

      transaction do
        signatures.each do |signature|
          if signature.creator?
            raise RuntimeError, &quot;Can&#39;t unsubscribe the creator signature&quot;
          elsif signature.pending?
            raise RuntimeError, &quot;Can&#39;t unsubscribe a pending signature&quot;
          else
            signature.update!(notify_by_email: false)
          end
        end
      end
    end

    def validate!(signature_ids, now = Time.current, force: false, request: nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Boolean-Parameter.md" target="_blank"><b>BooleanParameter</b></a>        </span>      </div>      <span>Signature#validate! has boolean parameter 'force'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Long-Parameter-List.md" target="_blank"><b>LongParameterList</b></a>        </span>      </div>      <span>Signature#validate! has 4 parameters</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Signature has missing safe method 'validate!'</span>          </div>  </li></ol>
      signatures = find(signature_ids)

      transaction do
        signatures.each do |signature|
          signature.validate!(now, force: force, request: request)
        end
      end
    end

    def validated(since: nil, upto: nil)
      scope = where(state: VALIDATED_STATE)
      scope = scope.where(validated_at.gt(since)) if since
      scope = scope.where(validated_at.lteq(upto)) if upto
      scope
    end

    def validated_count(timestamp, upto)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Signature takes parameters ['timestamp', 'upto'] to 3 methods</span>              <span>Locations:</span>                  <a href="signature.html#L379" class="js-smell-location">0</a>                  <a href="signature.html#L383" class="js-smell-location">1</a>                  <a href="signature.html#L387" class="js-smell-location">2</a>                  </div>  </li></ol>
      validated(since: timestamp, upto: upto).pluck(count_star.to_sql).first
    end

    def validated_count_by_location_code(timestamp, upto)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Signature takes parameters ['timestamp', 'upto'] to 3 methods</span>              <span>Locations:</span>                  <a href="signature.html#L379" class="js-smell-location">0</a>                  <a href="signature.html#L383" class="js-smell-location">1</a>                  <a href="signature.html#L387" class="js-smell-location">2</a>                  </div>  </li></ol>
      validated(since: timestamp, upto: upto).group(:location_code).pluck(:location_code, count_star.to_sql)
    end

    def validated_count_by_constituency_id(timestamp, upto)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Signature takes parameters ['timestamp', 'upto'] to 3 methods</span>              <span>Locations:</span>                  <a href="signature.html#L379" class="js-smell-location">0</a>                  <a href="signature.html#L383" class="js-smell-location">1</a>                  <a href="signature.html#L387" class="js-smell-location">2</a>                  </div>  </li></ol>
      validated(since: timestamp, upto: upto).group(:constituency_id).pluck(:constituency_id, count_star.to_sql)
    end

    def validated?(id)
      where(id: id).where(validated_at.not_eq(nil)).exists?
    end

    private

    def ip_search?(query)
      IPAddr.new(query)
    rescue IPAddr::InvalidAddressError =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Signature#ip_search? has the variable name 'e'</span>          </div>  </li></ol>
      false
    end

    def domain_search?(query)
      query.starts_with?(&#39;@&#39;)
    end

    def email_search?(query)
      query.include?(&#39;@&#39;)
    end

    def petition_search?(query)
      query =~ /\A\d+\z/
    end

    def postcode_search?(query)
      PostcodeSanitizer.call(query) =~ PostcodeValidator::PATTERN
    end

    def sector_search?(query)
      PostcodeSanitizer.call(query) =~ /\A[A-Z]{1,2}[0-9][0-9A-Z]?XXX\z/
    end

    def validated_at
      arel_table[:validated_at]
    end

    def count_star
      arel_table[Arel.star].count
    end

    def max_validated_at
      arel_table[:validated_at].maximum.to_sql
    end

    def normalize_email(email)
      &quot;#{normalize_user(email)}@#{normalize_domain(email)}&quot;
    end

    def normalize_user(email)
      email.split(&quot;@&quot;).first.split(&quot;+&quot;).first.tr(&quot;.&quot;, &quot;&quot;).downcase
    end

    def normalize_domain(email)
      email.split(&quot;@&quot;).last.downcase
    end
  end

  attr_accessor :uk_citizenship<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Signature#uk_citizenship is a writable attribute</span>          </div>  </li></ol>

  def find_duplicate<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature.html#L450" class="js-smell-location">0</a>                  <a href="signature.html#L469" class="js-smell-location">1</a>                  </div>  </li></ol>
    return nil unless petition

    signatures = petition.signatures.duplicate(id, email)
    return signatures.first if signatures.many?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Signature#find_duplicate calls 'signatures.first' 2 times</span>              <span>Locations:</span>                  <a href="signature.html#L454" class="js-smell-location">0</a>                  <a href="signature.html#L456" class="js-smell-location">1</a>                  </div>  </li></ol>

    if signature = signatures.first<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Signature#find_duplicate calls 'signatures.first' 2 times</span>              <span>Locations:</span>                  <a href="signature.html#L454" class="js-smell-location">0</a>                  <a href="signature.html#L456" class="js-smell-location">1</a>                  </div>  </li></ol>
      if sanitized_name == signature.sanitized_name
        signature
      elsif postcode != signature.postcode
        signature
      end
    end
  end

  def find_duplicate!
    find_duplicate || find_similar || (raise ActiveRecord::RecordNotFound, &quot;Signature not found: #{name}, #{email}, #{postcode}&quot;)
  end

  def find_similar<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature.html#L450" class="js-smell-location">0</a>                  <a href="signature.html#L469" class="js-smell-location">1</a>                  </div>  </li></ol>
    return nil unless petition

    signatures = petition.signatures.similar(id, canonical_email)
    return signatures.first if signatures.many?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Signature#find_similar calls 'signatures.first' 2 times</span>              <span>Locations:</span>                  <a href="signature.html#L473" class="js-smell-location">0</a>                  <a href="signature.html#L475" class="js-smell-location">1</a>                  </div>  </li></ol>

    if signature = signatures.first<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Signature#find_similar calls 'signatures.first' 2 times</span>              <span>Locations:</span>                  <a href="signature.html#L473" class="js-smell-location">0</a>                  <a href="signature.html#L475" class="js-smell-location">1</a>                  </div>  </li></ol>
      if sanitized_name == signature.sanitized_name
        signature
      elsif postcode != signature.postcode
        signature
      end
    end
  end

  def name=(value)
    super(value.to_s.strip)
  end

  def email=(value)
    super(value.to_s.strip.downcase)
  end

  def postcode=(value)
    super(PostcodeSanitizer.call(value))
  end

  def sanitized_name
    name.to_s.parameterize
  end

  def pending?
    state == PENDING_STATE
  end

  def fraudulent?
    state == FRAUDULENT_STATE
  end

  def validated?
    state == VALIDATED_STATE
  end

  def invalidated?
    state == INVALIDATED_STATE
  end

  def subscribed?
    validated? &amp;&amp; !unsubscribed?
  end

  def unsubscribed?
    notify_by_email == false
  end

  def fraudulent!(now = Time.current)
    retry_lock do
      if pending?
        update_columns(state: FRAUDULENT_STATE, updated_at: now)
      end
    end
  end

  def validate!(now = Time.current, force: false, request: nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Signature#validate! has a flog score of 44</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Boolean-Parameter.md" target="_blank"><b>BooleanParameter</b></a>        </span>      </div>      <span>Signature#validate! has boolean parameter 'force'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Signature has missing safe method 'validate!'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Signature#validate! has approx 16 statements</span>          </div>  </li></ol>
    update_signature_counts = false
    new_constituency_id = nil

    unless constituency_id?
      if united_kingdom? &amp;&amp; postcode?
        new_constituency_id = constituency.try(:external_id)
      end
    end

    retry_lock do
      if force || pending?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Control-Parameter.md" target="_blank"><b>ControlParameter</b></a>        </span>      </div>      <span>Signature#validate! is controlled by argument 'force'</span>          </div>  </li></ol>
        update_signature_counts = true
        petition.validate_creator!(now) unless creator?

        attributes = {
          number:       petition.signature_count + 1,
          state:        VALIDATED_STATE,
          validated_at: now,
          invalidation_id: nil,
          invalidated_at:  nil,
          updated_at:   now
        }

        if request
          attributes[:validated_ip] = request.remote_ip
        end

        if new_constituency_id
          attributes[:constituency_id] = new_constituency_id
        end

        unless signed_token?
          attributes[:signed_token] = Authlogic::Random.friendly_token
        end

        update_columns(attributes)
      end
    end

    if update_signature_counts
      @just_validated = true
    end

    if inline_updates? &amp;&amp; update_signature_counts
      last_signed_at = petition.last_signed_at
      petition.increment_signature_count!(now)

      ConstituencyPetitionJournal.increment_signature_counts_for(petition, last_signed_at)
      CountryPetitionJournal.increment_signature_counts_for(petition, last_signed_at)
    end
  end

  def just_validated?
    defined?(@just_validated) ? @just_validated : false
  end

  def validated_before?(timestamp)
    validated? &amp;&amp; validated_at &lt; timestamp
  end

  def reload(*)
    super.tap { @just_validated = false }
  end

  def invalidate!(now = Time.current, invalidation_id = nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Signature has missing safe method 'invalidate!'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Signature#invalidate! has approx 7 statements</span>          </div>  </li></ol>
    update_signature_counts = false

    retry_lock do
      if validated?
        update_signature_counts = true
      end

      update_columns(
        state:           INVALIDATED_STATE,
        notify_by_email: false,
        invalidation_id: invalidation_id,
        invalidated_at:  now,
        updated_at:      now
      )
    end

    if update_signature_counts
      ConstituencyPetitionJournal.invalidate_signature_for(self, now)
      CountryPetitionJournal.invalidate_signature_for(self, now)
      petition.decrement_signature_count!(now)
    end
  end

  def mark_seen_signed_confirmation_page!<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Signature has missing safe method 'mark_seen_signed_confirmation_page!'</span>          </div>  </li></ol>
    update seen_signed_confirmation_page: true
  end

  def save(*args)
    super
  rescue ActiveRecord::RecordNotUnique =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Signature#save has the variable name 'e'</span>          </div>  </li></ol>
    if creator?
      errors.add(:name, :already_signed, name: name, email: email) and return false
    else
      raise e
    end
  end

  def unsubscribe!(token)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/signature.html#L261" class="js-smell-location">0</a>                  <a href="signature.html#L635" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Signature has missing safe method 'unsubscribe!'</span>          </div>  </li></ol>
    if unsubscribed?
      errors.add(:base, &quot;Already Unsubscribed&quot;)
    elsif unsubscribe_token != token<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Control-Parameter.md" target="_blank"><b>ControlParameter</b></a>        </span>      </div>      <span>Signature#unsubscribe! is controlled by argument 'token'</span>          </div>  </li></ol>
      errors.add(:base, &quot;Invalid Unsubscribe Token&quot;)
    else
      update(notify_by_email: false)
    end
  end

  def already_unsubscribed?
    errors[:base].include?(&quot;Already Unsubscribed&quot;)
  end

  def invalid_unsubscribe_token?
    errors[:base].include?(&quot;Invalid Unsubscribe Token&quot;)
  end

  def constituency
    if constituency_id?
      @constituency ||= Constituency.find_by_external_id(constituency_id)
    elsif united_kingdom?
      @constituency ||= Constituency.find_by_postcode(postcode)
    end
  end

  def signed_token
    super || generate_and_save_signed_token
  end

  def get_email_sent_at_for(timestamp)
    self[column_name_for(timestamp)]
  end

  def set_email_sent_at_for(timestamp, to: Time.current)
    update_column(column_name_for(timestamp), to)
  end

  def account
    Mail::Address.new(email).local
  rescue Mail::Field::ParseError
    nil
  end

  def domain
    Mail::Address.new(email).domain
  rescue Mail::Field::ParseError
    nil
  end

  def rate(window = 5.minutes)
    period = Range.new(created_at - window, created_at)
    petition.signatures.where(ip_address: ip_address, created_at: period).count
  end

  def update_uuid
    update_column(:uuid, generate_uuid)
  end

  def update_canonical_email
    update_column(:canonical_email, Domain.normalize(email))
  end

  def number
    super || petition.signature_count + 1
  end

  def email_threshold_reached?
    email_count &gt;= 5
  end

  def united_kingdom?
    location_code == &#39;GB&#39;
  end
  alias_method :uk?, :united_kingdom?

  def update_all(updates)
    self.class.unscoped.where(id: id).update_all(updates)
  end

  def location
    if postcode?
      &quot;#{formatted_postcode}, #{location_code}&quot;
    else
      location_code
    end
  end

  def form_duration
    form_requested_at? ? created_at - form_requested_at : 0
  end

  def form_token_reused?
    self.class.where(form_token: form_token).count &gt; 1
  end

  private

  def formatted_postcode
    if united_kingdom?
      postcode.gsub(/\A([A-Z0-9]+?)([A-Z0-9]{3})\z/, &quot;\\1 \\2&quot;)
    else
      postcode
    end
  end

  def inline_updates?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Signature#inline_updates? doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV[&quot;INLINE_UPDATES&quot;] == &quot;true&quot;
  end

  def generate_uuid
    Digest::UUID.uuid_v5(Digest::UUID::URL_NAMESPACE, &quot;mailto:#{email}&quot;)
  end

  def generate_and_save_signed_token
    token = Authlogic::Random.friendly_token

    retry_lock do
      if signed_token?
        token = read_attribute(:signed_token)
      else
        update_column(:signed_token, token)
      end
    end

    token
  end

  def column_name_for(timestamp)
    self.class.column_name_for(timestamp)
  end

  def retry_lock<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature.html#L767" class="js-smell-location">0</a>                  <a href="task.html#L35" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Signature#retry_lock has approx 8 statements</span>          </div>  </li></ol>
    retried = false

    begin
      with_lock { yield }
    rescue PG::InFailedSqlTransaction =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Signature#retry_lock has the variable name 'e'</span>          </div>  </li></ol>
      if retried
        raise e
      else
        retried = true
        self.class.connection.clear_cache!
        retry
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- JavaScripts -->
    <script src='../../assets/javascripts/jquery.min.js'></script>
    <script src='../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../assets/javascripts/prettify.js'></script>
    <script src='../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../assets/javascripts/application.js'></script>
    <script src='../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>

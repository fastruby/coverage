<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../overview.html"><img src="../../assets/images/logo.png" alt="Ruby Critic Logo" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
      
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2019-03-27 03:58:07 +0000'>2019-03-27 03:58:07 +0000</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/models /</small> invalidation_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">1025</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">6</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">3060.94</span><small> complexity</small></div>
              <div><span class="metric">1504</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                25
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;rails_helper&#39;

RSpec.describe Invalidation, type: :model do
  subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;) }

  it &quot;has a valid factory&quot; do
    expect(FactoryBot.build(:invalidation, name: &quot;Joe Bloggs&quot;)).to be_valid
  end

  describe &quot;associations&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L10" class="js-smell-location">0</a>                  <a href="signature_spec.html#L80" class="js-smell-location">1</a>                  </div>  </li></ol>
    it { is_expected.to belong_to(:petition) }
    it { is_expected.to have_many(:signatures) }
  end

  describe &quot;indexes&quot; do
    it { is_expected.to have_db_index(:petition_id) }
  end

  describe &quot;callbacks&quot; do
    context &quot;when an invalidation hasn&#39;t started&quot; do
      let!(:invalidation) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;) }

      it &quot;can be deleted&quot; do
        expect(invalidation.destroy).to be_truthy
      end
    end

    context &quot;when an invalidation has started&quot; do
      let!(:invalidation) { FactoryBot.create(:invalidation, :started, name: &quot;Joe Bloggs&quot;) }

      it &quot;can&#39;t be deleted&quot; do
        expect(invalidation.destroy).to be_falsey
      end
    end
  end

  describe &quot;validations&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe#validations has a flog score of 114</span>          </div>  </li></ol>
    it { is_expected.to validate_presence_of(:summary) }
    it { is_expected.to validate_length_of(:summary).is_at_most(255) }
    it { is_expected.to validate_length_of(:details).is_at_most(10000) }
    it { is_expected.to validate_numericality_of(:petition_id).only_integer.is_greater_than_or_equal_to(100000) }
    it { is_expected.to validate_length_of(:name).is_at_most(255) }
    it { is_expected.to validate_length_of(:postcode).is_at_most(255) }
    it { is_expected.to validate_length_of(:ip_address).is_at_most(20) }
    it { is_expected.to validate_length_of(:email).is_at_most(255) }
    it { is_expected.to validate_length_of(:domain).is_at_most(255) }
    it { is_expected.to validate_length_of(:constituency_id).is_at_most(30) }
    it { is_expected.to validate_length_of(:location_code).is_at_most(30) }

    it { is_expected.not_to allow_value(&quot;foo&quot;).for(:ip_address) }
    it { is_expected.to allow_value(&quot;123.123.123.123&quot;).for(:ip_address) }

    context &quot;when there are no conditions&quot; do
      subject { FactoryBot.build(:invalidation) }

      before do
        subject.valid?
      end

      it &quot;adds an error to :petition_id&quot; do
        expect(subject.errors[:petition_id]).to include(&quot;Please select some conditions, otherwise all signatures will be invalidated&quot;)
      end
    end

    context &quot;when a petition doesn&#39;t exist&quot; do
      subject { FactoryBot.build(:invalidation, petition_id: 123456) }

      before do
        subject.valid?
      end

      it &quot;adds an error to :petition_id&quot; do
        expect(subject.errors[:petition_id]).to include(&quot;Petition doesn&#39;t exist&quot;)
      end
    end

    context &quot;when a constituency doesn&#39;t exist&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L77" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L89" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L101" class="js-smell-location">2</a>                  </div>  </li></ol>
      subject { FactoryBot.build(:invalidation, constituency_id: &quot;1234&quot;) }

      before do
        subject.valid?
      end

      it &quot;adds an error to :constituency_id&quot; do
        expect(subject.errors[:constituency_id]).to include(&quot;Constituency doesn&#39;t exist&quot;)
      end
    end

    context &quot;when a constituency doesn&#39;t exist&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L77" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L89" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L101" class="js-smell-location">2</a>                  </div>  </li></ol>
      subject { FactoryBot.build(:invalidation, constituency_id: &quot;1234&quot;) }

      before do
        subject.valid?
      end

      it &quot;adds an error to :constituency_id&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(validations)::context(when a constituency doesn't exist)::it#adds an error to :constituency_id has a flog score of 29</span>          </div>  </li></ol>
        expect(subject.errors[:constituency_id]).to include(&quot;Constituency doesn&#39;t exist&quot;)
      end
    end

    context &quot;when a location doesn&#39;t exist&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L77" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L89" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L101" class="js-smell-location">2</a>                  </div>  </li></ol>
      subject { FactoryBot.build(:invalidation, location_code: &quot;XX&quot;) }

      before do
        subject.valid?
      end

      it &quot;adds an error to :location_code&quot; do
        expect(subject.errors[:location_code]).to include(&quot;Location doesn&#39;t exist&quot;)
      end
    end

    context &quot;when the date range is reversed&quot; do
      subject { FactoryBot.build(:invalidation, created_after: 2.weeks.ago, created_before: 3.weeks.ago) }

      before do
        subject.valid?
      end

      it &quot;adds an error to :created_after&quot; do
        expect(subject.errors[:created_after]).to include(&quot;Starting date is after the finishing date&quot;)
      end
    end
  end

  describe &quot;class methods&quot; do
    describe &quot;.by_most_recent&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L127" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L136" class="js-smell-location">1</a>                  </div>  </li></ol>
      let!(:invalidation_1) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, created_at: 3.weeks.ago) }
      let!(:invalidation_2) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, created_at: 2.weeks.ago) }

      it &quot;orders the invalidations by the created_at timestamp in descending order&quot; do
        expect(described_class.by_most_recent.to_a).to eq([invalidation_2, invalidation_1])
      end
    end

    describe &quot;.by_longest_running&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L127" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L136" class="js-smell-location">1</a>                  </div>  </li></ol>
      let!(:invalidation_1) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, started_at: 1.hour.ago) }
      let!(:invalidation_2) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, started_at: 2.hours.ago) }

      it &quot;orders the invalidations by the started_at timestamp in ascending order&quot; do
        expect(described_class.by_most_recent.to_a).to eq([invalidation_2, invalidation_1])
      end
    end

    describe &quot;.cancelled&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L145" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L154" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L173" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L203" class="js-smell-location">3</a>                  </div>  </li></ol>
      let!(:invalidation_1) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, cancelled_at: nil) }
      let!(:invalidation_2) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, cancelled_at: 2.hours.ago) }

      it &quot;scopes the query to invalidations with a cancelled_at timestamp&quot; do
        expect(described_class.cancelled.to_a).to eq([invalidation_2])
      end
    end

    describe &quot;.completed&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L145" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L154" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L173" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L203" class="js-smell-location">3</a>                  </div>  </li></ol>
      let!(:invalidation_1) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, completed_at: nil) }
      let!(:invalidation_2) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, completed_at: 2.hours.ago) }

      it &quot;scopes the query to invalidations with a completed_at timestamp&quot; do
        expect(described_class.completed.to_a).to eq([invalidation_2])
      end
    end

    describe &quot;.enqueued&quot; do
      let!(:invalidation_1) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, enqueued_at: nil) }
      let!(:invalidation_2) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, enqueued_at: 2.hours.ago) }
      let!(:invalidation_3) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, enqueued_at: 2.hours.ago, started_at: 1.hour.ago) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L166" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L196" class="js-smell-location">1</a>                  </div>  </li></ol>

      it &quot;scopes the query to invalidations with a enqueued_at timestamp that have not started&quot; do
        expect(described_class.enqueued.to_a).to eq([invalidation_2])
      end
    end

    describe &quot;.not_completed&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L145" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L154" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L173" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L203" class="js-smell-location">3</a>                  </div>  </li></ol>
      let!(:invalidation_1) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, completed_at: nil) }
      let!(:invalidation_2) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, completed_at: 2.hours.ago) }

      it &quot;scopes the query to invalidations without a completed_at timestamp&quot; do
        expect(described_class.not_completed.to_a).to eq([invalidation_1])
      end
    end

    describe &quot;.pending&quot; do
      let!(:invalidation_1) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;) }
      let!(:invalidation_2) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, enqueued_at: 2.hours.ago) }
      let!(:invalidation_3) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, started_at: 2.hours.ago) }
      let!(:invalidation_4) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, cancelled_at: 2.hours.ago) }
      let!(:invalidation_5) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, completed_at: 2.hours.ago) }

      it &quot;scopes the query to invalidations that have not been processed in anyway&quot; do
        expect(described_class.pending.to_a).to eq([invalidation_1])
      end
    end

    describe &quot;.running&quot; do
      let!(:invalidation_1) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, started_at: 3.hours.ago, completed_at: nil) }
      let!(:invalidation_2) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, started_at: 3.hours.ago, completed_at: 2.hours.ago) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L166" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L196" class="js-smell-location">1</a>                  </div>  </li></ol>

      it &quot;scopes the query to invalidations that have started, but not completed&quot; do
        expect(described_class.running.to_a).to eq([invalidation_1])
      end
    end

    describe &quot;.started&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L145" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L154" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L173" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L203" class="js-smell-location">3</a>                  </div>  </li></ol>
      let!(:invalidation_1) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, started_at: nil) }
      let!(:invalidation_2) { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, started_at: 2.hours.ago) }

      it &quot;scopes the query to invalidations with a started_at timestamp&quot; do
        expect(described_class.started.to_a).to eq([invalidation_2])
      end
    end
  end

  describe &quot;instance methods&quot; do
    describe &quot;#cancelled?&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L214" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L266" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L318" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L374" class="js-smell-location">3</a>                  </div>  </li></ol>
      context &quot;when cancelled_at is nil&quot; do
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, cancelled_at: nil) }

        it &quot;returns false&quot; do
          expect(subject.cancelled?).to eq(false)
        end
      end

      context &quot;when cancelled_at is set&quot; do
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, cancelled_at: Time.current) }

        it &quot;returns true&quot; do
          expect(subject.cancelled?).to eq(true)
        end
      end
    end

    describe &quot;#cancel!&quot; do
      it &quot;changes cancelled? from false to true&quot; do
        expect {
          subject.cancel!
        }.to change {
          subject.cancelled?
        }.from(false).to(true)
      end

      it &quot;it sets cancelled_at&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L241" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L301" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L357" class="js-smell-location">2</a>                  <a href="petition_spec.html#L2177" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(instance methods)::describe(#cancel!)::it#it sets cancelled_at has a flog score of 28</span>          </div>  </li></ol>
        expect {
          subject.cancel!
        }.to change {
          subject.cancelled_at
        }.from(nil).to(be_within(1.second).of(Time.current))
      end

      context &quot;when the invalidation has already been cancelled&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L249" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L257" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L309" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L365" class="js-smell-location">3</a>                  <a href="invalidation_spec.html#L983" class="js-smell-location">4</a>                  </div>  </li></ol>
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, cancelled_at: Time.current) }

        it &quot;returns false&quot; do
          expect(subject.cancel!).to be_falsey
        end
      end

      context &quot;when the invalidation has already completed processing&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L249" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L257" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L309" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L365" class="js-smell-location">3</a>                  <a href="invalidation_spec.html#L983" class="js-smell-location">4</a>                  </div>  </li></ol>
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, completed_at: Time.current) }

        it &quot;returns false&quot; do
          expect(subject.cancel!).to be_falsey
        end
      end
    end

    describe &quot;#completed?&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L214" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L266" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L318" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L374" class="js-smell-location">3</a>                  </div>  </li></ol>
      context &quot;when completed_at is nil&quot; do
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, completed_at: nil) }

        it &quot;returns false&quot; do
          expect(subject.completed?).to eq(false)
        end
      end

      context &quot;when completed_at is set&quot; do
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, completed_at: Time.current) }

        it &quot;returns true&quot; do
          expect(subject.completed?).to eq(true)
        end
      end
    end

    describe &quot;#count!&quot; do
      before do
        3.times do
          FactoryBot.create(:validated_signature, ip_address: &quot;10.0.1.1&quot;)
        end
      end

      subject { FactoryBot.create(:invalidation, ip_address: &quot;10.0.1.1&quot;) }

      it &quot;updates the matching_count&quot; do
        expect {
          subject.count!
        }.to change {
          subject.matching_count
        }.from(0).to(3)
      end

      it &quot;updates the counted_at timestamp&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L241" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L301" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L357" class="js-smell-location">2</a>                  <a href="petition_spec.html#L2177" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(instance methods)::describe(#count!)::it#updates the counted_at timestamp has a flog score of 28</span>          </div>  </li></ol>
        expect {
          subject.count!
        }.to change {
          subject.counted_at
        }.from(nil).to(be_within(1.second).of(Time.current))
      end

      context &quot;when the invalidation in no longer pending&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L249" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L257" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L309" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L365" class="js-smell-location">3</a>                  <a href="invalidation_spec.html#L983" class="js-smell-location">4</a>                  </div>  </li></ol>
        subject { FactoryBot.create(:invalidation, ip_address: &quot;10.0.1.1&quot;, started_at: Time.current) }

        it &quot;returns false&quot; do
          expect(subject.count!).to be_falsey
        end
      end
    end

    describe &quot;#enqueued?&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L214" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L266" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L318" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L374" class="js-smell-location">3</a>                  </div>  </li></ol>
      context &quot;when enqueued_at is nil&quot; do
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, enqueued_at: nil) }

        it &quot;returns false&quot; do
          expect(subject.enqueued?).to eq(false)
        end
      end

      context &quot;when enqueued_at is set&quot; do
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, enqueued_at: Time.current) }

        it &quot;returns true&quot; do
          expect(subject.enqueued?).to eq(true)
        end
      end
    end

    describe &quot;#start!&quot; do
      subject { FactoryBot.create(:invalidation, ip_address: &quot;10.0.1.1&quot;) }

      let(:job) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="../jobs/notify_creators_that_parliament_is_dissolving_job_spec.html#L7" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L339" class="js-smell-location">1</a>                  </div>  </li></ol>
        {
          job: InvalidateSignaturesJob,
          args: [
            { &quot;_aj_globalid&quot; =&gt; &quot;gid://epets/Invalidation/#{subject.id}&quot; }
          ],
          queue: &quot;high_priority&quot;
        }
      end

      it &quot;enqueues the invalidate signatures job&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="../jobs/notify_creators_that_parliament_is_dissolving_job_spec.html#L19" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L349" class="js-smell-location">1</a>                  <a href="parliament_spec.html#L673" class="js-smell-location">2</a>                  <a href="parliament_spec.html#L818" class="js-smell-location">3</a>                  <a href="parliament_spec.html#L865" class="js-smell-location">4</a>                  </div>  </li></ol>
        expect {
          subject.start!
        }.to change {
          enqueued_jobs
        }.from([]).to([job])
      end

      it &quot;updates the enqueued_at timestamps&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L241" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L301" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L357" class="js-smell-location">2</a>                  <a href="petition_spec.html#L2177" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(instance methods)::describe(#start!)::it#updates the enqueued_at timestamps has a flog score of 28</span>          </div>  </li></ol>
        expect {
          subject.start!
        }.to change {
          subject.enqueued_at
        }.from(nil).to(be_within(1.second).of(Time.current))
      end

      context &quot;when the invalidation in no longer pending&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L249" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L257" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L309" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L365" class="js-smell-location">3</a>                  <a href="invalidation_spec.html#L983" class="js-smell-location">4</a>                  </div>  </li></ol>
        subject { FactoryBot.create(:invalidation, ip_address: &quot;10.0.1.1&quot;, started_at: Time.current) }

        it &quot;returns false&quot; do
          expect(subject.start!).to be_falsey
        end
      end
    end

    describe &quot;#started?&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L214" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L266" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L318" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L374" class="js-smell-location">3</a>                  </div>  </li></ol>
      context &quot;when started_at is nil&quot; do
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, started_at: nil) }

        it &quot;returns false&quot; do
          expect(subject.started?).to eq(false)
        end
      end

      context &quot;when started_at is set&quot; do
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, started_at: Time.current) }

        it &quot;returns true&quot; do
          expect(subject.started?).to eq(true)
        end
      end
    end

    describe &quot;#pending?&quot; do
      context &quot;by default&quot; do
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;) }

        it &quot;returns true&quot; do
          expect(subject.pending?).to eq(true)
        end
      end

      context &quot;when a invalidation is enqueued&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L401" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L409" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L417" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L425" class="js-smell-location">3</a>                  </div>  </li></ol>
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, enqueued_at: Time.current) }

        it &quot;returns false&quot; do
          expect(subject.pending?).to eq(false)
        end
      end

      context &quot;when a invalidation is running&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L401" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L409" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L417" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L425" class="js-smell-location">3</a>                  </div>  </li></ol>
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, started_at: Time.current) }

        it &quot;returns false&quot; do
          expect(subject.pending?).to eq(false)
        end
      end

      context &quot;when a invalidation has been cancelled&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L401" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L409" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L417" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L425" class="js-smell-location">3</a>                  </div>  </li></ol>
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, cancelled_at: Time.current) }

        it &quot;returns false&quot; do
          expect(subject.pending?).to eq(false)
        end
      end

      context &quot;when a invalidation has been completed&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L401" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L409" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L417" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L425" class="js-smell-location">3</a>                  </div>  </li></ol>
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, completed_at: Time.current) }

        it &quot;returns false&quot; do
          expect(subject.pending?).to eq(false)
        end
      end
    end

    describe &quot;#running?&quot; do
      context &quot;by default&quot; do
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;) }

        it &quot;returns false&quot; do
          expect(subject.running?).to eq(false)
        end
      end

      context &quot;when a invalidation is running&quot; do
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, started_at: Time.current) }

        it &quot;returns true&quot; do
          expect(subject.running?).to eq(true)
        end
      end

      context &quot;when a invalidation has been cancelled&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L451" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L459" class="js-smell-location">1</a>                  </div>  </li></ol>
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, started_at: Time.current, cancelled_at: Time.current) }

        it &quot;returns false&quot; do
          expect(subject.running?).to eq(false)
        end
      end

      context &quot;when a invalidation has been completed&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L451" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L459" class="js-smell-location">1</a>                  </div>  </li></ol>
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, started_at: Time.current, completed_at: Time.current) }

        it &quot;returns false&quot; do
          expect(subject.running?).to eq(false)
        end
      end
    end

    describe &quot;#percent_completed&quot; do
      context &quot;when matching_count is zero&quot; do
        context &quot;and the invalidation has not started&quot; do
          subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, matching_count: 0, invalidated_count: 0) }

          it &quot;returns 0&quot; do
            expect(subject.percent_completed).to eq(0)
          end
        end

        context &quot;and the invalidation has started&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L478" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L495" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L503" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L511" class="js-smell-location">3</a>                  </div>  </li></ol>
          subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, matching_count: 0, invalidated_count: 0, started_at: Time.current) }

          it &quot;returns 100&quot; do
            expect(subject.percent_completed).to eq(100)
          end
        end

        context &quot;and the invalidation has completed&quot; do
          subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, matching_count: 0, invalidated_count: 0, started_at: Time.current, completed_at: Time.current) }

          it &quot;returns 100&quot; do
            expect(subject.percent_completed).to eq(100)
          end
        end
      end

      context &quot;when matching_count is not zero&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L478" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L495" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L503" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L511" class="js-smell-location">3</a>                  </div>  </li></ol>
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, matching_count: 100, invalidated_count: 50, started_at: Time.current) }

        it &quot;returns the percentage of completed invalidations&quot; do
          expect(subject.percent_completed).to eq(50)
        end
      end

      context &quot;when invalidated_count is a negative number&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L478" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L495" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L503" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L511" class="js-smell-location">3</a>                  </div>  </li></ol>
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, matching_count: 100, invalidated_count: -50, started_at: Time.current) }

        it &quot;returns 0&quot; do
          expect(subject.percent_completed).to eq(0)
        end
      end

      context &quot;when invalidated_count is greater than matching_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L478" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L495" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L503" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L511" class="js-smell-location">3</a>                  </div>  </li></ol>
        subject { FactoryBot.create(:invalidation, name: &quot;Joe Bloggs&quot;, matching_count: 50, invalidated_count: 100, started_at: Time.current) }

        it &quot;returns 100&quot; do
          expect(subject.percent_completed).to eq(100)
        end
      end
    end

    describe &quot;#matching_signatures&quot; do
      context &quot;when filtering by petition&quot; do
        let!(:petition_1) { FactoryBot.create(:open_petition) }
        let!(:petition_2) { FactoryBot.create(:open_petition) }
        let!(:signature_1) { FactoryBot.create(:validated_signature, petition: petition_1) }
        let!(:signature_2) { FactoryBot.create(:validated_signature, petition: petition_2) }
        let!(:signature_3) { FactoryBot.create(:pending_signature, petition: petition_1) }
        let!(:signature_4) { FactoryBot.create(:invalidated_signature, petition: petition_1) }
        let!(:signature_5) { FactoryBot.create(:fraudulent_signature, petition: petition_1) }

        subject { FactoryBot.create(:invalidation, petition: petition_1) }

        it &quot;includes validated signatures for petition 1&quot; do
          expect(subject.matching_signatures).to include(signature_1)
        end

        it &quot;includes pending signatures for petition 1&quot; do
          expect(subject.matching_signatures).to include(signature_3)
        end

        it &quot;excludes invalidated signatures for petition 1&quot; do
          expect(subject.matching_signatures).not_to include(signature_4)
        end

        it &quot;excludes fraudulent signatures for petition 1&quot; do
          expect(subject.matching_signatures).not_to include(signature_5)
        end

        it &quot;excludes signatures for petition 2&quot; do
          expect(subject.matching_signatures).not_to include(signature_2)
        end
      end

      context &quot;when filtering by name&quot; do
        let!(:petition) { FactoryBot.create(:open_petition) }
        let!(:signature_1) { FactoryBot.create(:validated_signature, name: &quot;Joe Public&quot;, petition: petition) }
        let!(:signature_2) { FactoryBot.create(:validated_signature, name: &quot;John Doe&quot;, petition: petition) }
        let!(:signature_3) { FactoryBot.create(:pending_signature, name: &quot;Joe Public&quot;, petition: petition) }
        let!(:signature_4) { FactoryBot.create(:invalidated_signature, name: &quot;Joe Public&quot;, petition: petition) }
        let!(:signature_5) { FactoryBot.create(:fraudulent_signature, name: &quot;Joe Public&quot;, petition: petition) }

        subject { FactoryBot.create(:invalidation, name: &quot;Joe Public&quot;) }

        it &quot;includes validated signatures that match&quot; do
          expect(subject.matching_signatures).to include(signature_1)
        end

        it &quot;includes pending signatures that match&quot; do
          expect(subject.matching_signatures).to include(signature_3)
        end

        it &quot;excludes invalidated signatures that match&quot; do
          expect(subject.matching_signatures).not_to include(signature_4)
        end

        it &quot;excludes fraudulent signatures that match&quot; do
          expect(subject.matching_signatures).not_to include(signature_5)
        end

        it &quot;excludes signatures that don&#39;t match&quot; do
          expect(subject.matching_signatures).not_to include(signature_2)
        end

        context &quot;and the filter includes a LIKE wildcard&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L583" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L708" class="js-smell-location">1</a>                  </div>  </li></ol>
          subject { FactoryBot.create(:invalidation, name: &quot;Joe %&quot;) }

          it &quot;includes validated signatures that match&quot; do
            expect(subject.matching_signatures).to include(signature_1)
          end

          it &quot;includes pending signatures that match&quot; do
            expect(subject.matching_signatures).to include(signature_3)
          end

          it &quot;excludes invalidated signatures that match&quot; do
            expect(subject.matching_signatures).not_to include(signature_4)
          end

          it &quot;excludes fraudulent signatures that match&quot; do
            expect(subject.matching_signatures).not_to include(signature_5)
          end

          it &quot;excludes signatures that don&#39;t match&quot; do
            expect(subject.matching_signatures).not_to include(signature_2)
          end
        end
      end

      context &quot;when filtering by postcode&quot; do
        before do
          stub_api_request_for(&quot;SW1A0AA&quot;).to_return(api_response(:ok, &quot;london_and_westminster&quot;))
          stub_api_request_for(&quot;E16PL&quot;).to_return(api_response(:ok, &quot;bethnal_green_and_bow&quot;))
        end

        let!(:petition) { FactoryBot.create(:open_petition) }
        let!(:signature_1) { FactoryBot.create(:validated_signature, postcode: &quot;SW1A 0AA&quot;, petition: petition) }
        let!(:signature_2) { FactoryBot.create(:validated_signature, postcode: &quot;E1 6PL&quot;, petition: petition) }
        let!(:signature_3) { FactoryBot.create(:pending_signature, postcode: &quot;SW1A 0AA&quot;, petition: petition) }
        let!(:signature_4) { FactoryBot.create(:invalidated_signature, postcode: &quot;SW1A 0AA&quot;, petition: petition) }
        let!(:signature_5) { FactoryBot.create(:fraudulent_signature, postcode: &quot;SW1A 0AA&quot;, petition: petition) }

        subject { FactoryBot.create(:invalidation, postcode: &quot;SW1A0AA&quot;) }

        it &quot;includes validated signatures that match&quot; do
          expect(subject.matching_signatures).to include(signature_1)
        end

        it &quot;includes pending signatures that match&quot; do
          expect(subject.matching_signatures).to include(signature_3)
        end

        it &quot;excludes invalidated signatures that match&quot; do
          expect(subject.matching_signatures).not_to include(signature_4)
        end

        it &quot;excludes fraudulent signatures that match&quot; do
          expect(subject.matching_signatures).not_to include(signature_5)
        end

        it &quot;excludes signatures that don&#39;t match&quot; do
          expect(subject.matching_signatures).not_to include(signature_2)
        end
      end

      context &quot;when filtering by ip_address&quot; do
        let!(:petition) { FactoryBot.create(:open_petition) }
        let!(:signature_1) { FactoryBot.create(:validated_signature, ip_address: &quot;10.0.1.1&quot;, petition: petition) }
        let!(:signature_2) { FactoryBot.create(:validated_signature, ip_address: &quot;192.168.1.1&quot;, petition: petition) }
        let!(:signature_3) { FactoryBot.create(:pending_signature, ip_address: &quot;10.0.1.1&quot;, petition: petition) }
        let!(:signature_4) { FactoryBot.create(:invalidated_signature, ip_address: &quot;10.0.1.1&quot;, petition: petition) }
        let!(:signature_5) { FactoryBot.create(:fraudulent_signature, ip_address: &quot;10.0.1.1&quot;, petition: petition) }

        subject { FactoryBot.create(:invalidation, ip_address: &quot;10.0.1.1&quot;) }

        it &quot;includes validated signatures that match&quot; do
          expect(subject.matching_signatures).to include(signature_1)
        end

        it &quot;includes pending signatures that match&quot; do
          expect(subject.matching_signatures).to include(signature_3)
        end

        it &quot;excludes invalidated signatures that match&quot; do
          expect(subject.matching_signatures).not_to include(signature_4)
        end

        it &quot;excludes fraudulent signatures that match&quot; do
          expect(subject.matching_signatures).not_to include(signature_5)
        end

        it &quot;excludes signatures that don&#39;t match&quot; do
          expect(subject.matching_signatures).not_to include(signature_2)
        end
      end

      context &quot;when filtering by email&quot; do
        let!(:petition_1) { FactoryBot.create(:open_petition) }
        let!(:petition_2) { FactoryBot.create(:open_petition) }
        let!(:petition_3) { FactoryBot.create(:open_petition) }
        let!(:petition_4) { FactoryBot.create(:open_petition) }
        let!(:signature_1) { FactoryBot.create(:validated_signature, email: &quot;joe@public.com&quot;, petition: petition_1) }
        let!(:signature_2) { FactoryBot.create(:validated_signature, email: &quot;john@doe.com&quot;, petition: petition_1) }
        let!(:signature_3) { FactoryBot.create(:pending_signature, email: &quot;joe@public.com&quot;, petition: petition_2) }
        let!(:signature_4) { FactoryBot.create(:invalidated_signature, email: &quot;joe@public.com&quot;, petition: petition_3) }
        let!(:signature_5) { FactoryBot.create(:fraudulent_signature, email: &quot;joe@public.com&quot;, petition: petition_4) }

        subject { FactoryBot.create(:invalidation, email: &quot;joe@public.com&quot;) }

        it &quot;includes validated signatures that match&quot; do
          expect(subject.matching_signatures).to include(signature_1)
        end

        it &quot;includes pending signatures that match&quot; do
          expect(subject.matching_signatures).to include(signature_3)
        end

        it &quot;excludes invalidated signatures that match&quot; do
          expect(subject.matching_signatures).not_to include(signature_4)
        end

        it &quot;excludes fraudulent signatures that match&quot; do
          expect(subject.matching_signatures).not_to include(signature_5)
        end

        it &quot;excludes signatures that don&#39;t match&quot; do
          expect(subject.matching_signatures).not_to include(signature_2)
        end

        context &quot;and the filter includes a LIKE wildcard&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L583" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L708" class="js-smell-location">1</a>                  </div>  </li></ol>
          subject { FactoryBot.create(:invalidation, email: &quot;%@public.com&quot;) }

          it &quot;includes validated signatures that match&quot; do
            expect(subject.matching_signatures).to include(signature_1)
          end

          it &quot;includes pending signatures that match&quot; do
            expect(subject.matching_signatures).to include(signature_3)
          end

          it &quot;excludes invalidated signatures that match&quot; do
            expect(subject.matching_signatures).not_to include(signature_4)
          end

          it &quot;excludes fraudulent signatures that match&quot; do
            expect(subject.matching_signatures).not_to include(signature_5)
          end

          it &quot;excludes signatures that don&#39;t match&quot; do
            expect(subject.matching_signatures).not_to include(signature_2)
          end
        end
      end

      context &quot;when filtering by domain&quot; do
        let!(:petition_1) { FactoryBot.create(:open_petition) }
        let!(:petition_2) { FactoryBot.create(:open_petition) }
        let!(:petition_3) { FactoryBot.create(:open_petition) }
        let!(:petition_4) { FactoryBot.create(:open_petition) }
        let!(:signature_1) { FactoryBot.create(:validated_signature, email: &quot;joe@public.com&quot;, petition: petition_1) }
        let!(:signature_2) { FactoryBot.create(:validated_signature, email: &quot;john@doe.com&quot;, petition: petition_1) }
        let!(:signature_3) { FactoryBot.create(:pending_signature, email: &quot;joe@public.com&quot;, petition: petition_2) }
        let!(:signature_4) { FactoryBot.create(:invalidated_signature, email: &quot;joe@public.com&quot;, petition: petition_3) }
        let!(:signature_5) { FactoryBot.create(:fraudulent_signature, email: &quot;joe@public.com&quot;, petition: petition_4) }

        subject { FactoryBot.create(:invalidation, domain: &quot;public.com&quot;) }

        it &quot;includes validated signatures that match&quot; do
          expect(subject.matching_signatures).to include(signature_1)
        end

        it &quot;includes pending signatures that match&quot; do
          expect(subject.matching_signatures).to include(signature_3)
        end

        it &quot;excludes invalidated signatures that match&quot; do
          expect(subject.matching_signatures).not_to include(signature_4)
        end

        it &quot;excludes fraudulent signatures that match&quot; do
          expect(subject.matching_signatures).not_to include(signature_5)
        end

        it &quot;excludes signatures that don&#39;t match&quot; do
          expect(subject.matching_signatures).not_to include(signature_2)
        end
      end

      context &quot;when filtering by date range&quot; do
        let!(:petition) { FactoryBot.create(:open_petition) }

        context &quot;and just the start date is specified&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L770" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L800" class="js-smell-location">1</a>                  </div>  </li></ol>
          let!(:signature_1) { FactoryBot.create(:validated_signature, created_at: 2.weeks.ago, petition: petition) }
          let!(:signature_2) { FactoryBot.create(:validated_signature, created_at: 4.weeks.ago, petition: petition) }
          let!(:signature_3) { FactoryBot.create(:pending_signature, created_at: 2.weeks.ago, petition: petition) }
          let!(:signature_4) { FactoryBot.create(:invalidated_signature, created_at: 2.weeks.ago, petition: petition) }
          let!(:signature_5) { FactoryBot.create(:fraudulent_signature, created_at: 2.weeks.ago, petition: petition) }

          subject { FactoryBot.create(:invalidation, created_after: 3.weeks.ago) }

          it &quot;includes validated signatures that match&quot; do
            expect(subject.matching_signatures).to include(signature_1)
          end

          it &quot;includes pending signatures that match&quot; do
            expect(subject.matching_signatures).to include(signature_3)
          end

          it &quot;excludes invalidated signatures that match&quot; do
            expect(subject.matching_signatures).not_to include(signature_4)
          end

          it &quot;excludes fraudulent signatures that match&quot; do
            expect(subject.matching_signatures).not_to include(signature_5)
          end

          it &quot;excludes signatures that don&#39;t match&quot; do
            expect(subject.matching_signatures).not_to include(signature_2)
          end
        end

        context &quot;and just the end date is specified&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L770" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L800" class="js-smell-location">1</a>                  </div>  </li></ol>
          let!(:signature_1) { FactoryBot.create(:validated_signature, created_at: 4.weeks.ago, petition: petition) }
          let!(:signature_2) { FactoryBot.create(:validated_signature, created_at: 2.weeks.ago, petition: petition) }
          let!(:signature_3) { FactoryBot.create(:pending_signature, created_at: 4.weeks.ago, petition: petition) }
          let!(:signature_4) { FactoryBot.create(:invalidated_signature, created_at: 4.weeks.ago, petition: petition) }
          let!(:signature_5) { FactoryBot.create(:fraudulent_signature, created_at: 4.weeks.ago, petition: petition) }

          subject { FactoryBot.create(:invalidation, created_before: 3.weeks.ago) }

          it &quot;includes validated signatures that match&quot; do
            expect(subject.matching_signatures).to include(signature_1)
          end

          it &quot;includes pending signatures that match&quot; do
            expect(subject.matching_signatures).to include(signature_3)
          end

          it &quot;excludes invalidated signatures that match&quot; do
            expect(subject.matching_signatures).not_to include(signature_4)
          end

          it &quot;excludes fraudulent signatures that match&quot; do
            expect(subject.matching_signatures).not_to include(signature_5)
          end

          it &quot;excludes signatures that don&#39;t match&quot; do
            expect(subject.matching_signatures).not_to include(signature_2)
          end
        end

        context &quot;and both the start date and end date are specified&quot; do
          let!(:signature_1) { FactoryBot.create(:validated_signature, created_at: 4.weeks.ago, petition: petition) }
          let!(:signature_2) { FactoryBot.create(:validated_signature, created_at: 2.weeks.ago, petition: petition) }
          let!(:signature_3) { FactoryBot.create(:pending_signature, created_at: 4.weeks.ago, petition: petition) }
          let!(:signature_4) { FactoryBot.create(:invalidated_signature, created_at: 4.weeks.ago, petition: petition) }
          let!(:signature_5) { FactoryBot.create(:fraudulent_signature, created_at: 4.weeks.ago, petition: petition) }

          subject { FactoryBot.create(:invalidation, created_before: 3.weeks.ago, created_after: 5.weeks.ago) }

          it &quot;includes validated signatures that match&quot; do
            expect(subject.matching_signatures).to include(signature_1)
          end

          it &quot;includes pending signatures that match&quot; do
            expect(subject.matching_signatures).to include(signature_3)
          end

          it &quot;excludes invalidated signatures that match&quot; do
            expect(subject.matching_signatures).not_to include(signature_4)
          end

          it &quot;excludes fraudulent signatures that match&quot; do
            expect(subject.matching_signatures).not_to include(signature_5)
          end

          it &quot;excludes signatures that don&#39;t match&quot; do
            expect(subject.matching_signatures).not_to include(signature_2)
          end
        end
      end

      context &quot;when filtering by constituency_id&quot; do
        let!(:petition) { FactoryBot.create(:open_petition) }
        let!(:coventry) { FactoryBot.create(:constituency, :coventry_north_east) }
        let!(:bethnal) { FactoryBot.create(:constituency, :bethnal_green_and_bow) }
        let!(:signature_1) { FactoryBot.create(:validated_signature, constituency_id: &quot;3427&quot;, petition: petition) }
        let!(:signature_2) { FactoryBot.create(:validated_signature, constituency_id: &quot;3320&quot;, petition: petition) }
        let!(:signature_3) { FactoryBot.create(:pending_signature, constituency_id: &quot;3427&quot;, petition: petition) }
        let!(:signature_4) { FactoryBot.create(:invalidated_signature, constituency_id: &quot;3427&quot;, petition: petition) }
        let!(:signature_5) { FactoryBot.create(:fraudulent_signature, constituency_id: &quot;3427&quot;, petition: petition) }

        subject { FactoryBot.create(:invalidation, constituency_id: &quot;3427&quot;) }

        it &quot;includes validated signatures that match&quot; do
          expect(subject.matching_signatures).to include(signature_1)
        end

        it &quot;includes pending signatures that match&quot; do
          expect(subject.matching_signatures).to include(signature_3)
        end

        it &quot;excludes invalidated signatures that match&quot; do
          expect(subject.matching_signatures).not_to include(signature_4)
        end

        it &quot;excludes fraudulent signatures that match&quot; do
          expect(subject.matching_signatures).not_to include(signature_5)
        end

        it &quot;excludes signatures that don&#39;t match&quot; do
          expect(subject.matching_signatures).not_to include(signature_2)
        end
      end

      context &quot;when filtering by location_code&quot; do
        let!(:petition) { FactoryBot.create(:open_petition) }
        let!(:united_kingdom) { FactoryBot.create(:location, code: &quot;GB&quot;, name: &quot;United Kingdom&quot;) }
        let!(:australia) { FactoryBot.create(:location, code: &quot;AU&quot;, name: &quot;Australia&quot;) }
        let!(:signature_1) { FactoryBot.create(:validated_signature, location_code: &quot;GB&quot;, petition: petition) }
        let!(:signature_2) { FactoryBot.create(:validated_signature, location_code: &quot;AU&quot;, petition: petition) }
        let!(:signature_3) { FactoryBot.create(:pending_signature, location_code: &quot;GB&quot;, petition: petition) }
        let!(:signature_4) { FactoryBot.create(:invalidated_signature, location_code: &quot;GB&quot;, petition: petition) }
        let!(:signature_5) { FactoryBot.create(:fraudulent_signature, location_code: &quot;GB&quot;, petition: petition) }

        subject { FactoryBot.create(:invalidation, location_code: &quot;GB&quot;) }

        it &quot;includes validated signatures that match&quot; do
          expect(subject.matching_signatures).to include(signature_1)
        end

        it &quot;includes pending signatures that match&quot; do
          expect(subject.matching_signatures).to include(signature_3)
        end

        it &quot;excludes invalidated signatures that match&quot; do
          expect(subject.matching_signatures).not_to include(signature_4)
        end

        it &quot;excludes fraudulent signatures that match&quot; do
          expect(subject.matching_signatures).not_to include(signature_5)
        end

        it &quot;excludes signatures that don&#39;t match&quot; do
          expect(subject.matching_signatures).not_to include(signature_2)
        end
      end
    end

    describe &quot;#invalidate!&quot; do
      let!(:petition) { FactoryBot.create(:open_petition) }
      let!(:signature_1) { FactoryBot.create(:validated_signature, ip_address: &quot;10.0.1.1&quot;, petition: petition) }
      let!(:signature_2) { FactoryBot.create(:validated_signature, ip_address: &quot;192.168.1.1&quot;, petition: petition) }
      let!(:signature_3) { FactoryBot.create(:validated_signature, ip_address: &quot;10.0.1.1&quot;, petition: petition) }
      let!(:signature_4) { FactoryBot.create(:validated_signature, ip_address: &quot;192.168.1.2&quot;, petition: petition) }
      let!(:signature_5) { FactoryBot.create(:validated_signature, ip_address: &quot;10.0.1.1&quot;, petition: petition) }

      subject { FactoryBot.create(:invalidation, ip_address: &quot;10.0.1.1&quot;) }

      it &quot;sets the matching_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L938" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L951" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L975" class="js-smell-location">2</a>                  <a href="petition_spec.html#L798" class="js-smell-location">3</a>                  <a href="petition_spec.html#L1538" class="js-smell-location">4</a>                  </div>  </li></ol>
        expect {
          subject.invalidate!
        }.to change {
          subject.reload.matching_count
        }.from(0).to(3)
      end

      it &quot;increments the invalidated_count after each invalidation&quot; do
        expect(subject).to receive(:increment!).with(:invalidated_count).exactly(3).times.and_call_original
        subject.invalidate!
      end

      it &quot;sets the invalidated_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L938" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L951" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L975" class="js-smell-location">2</a>                  <a href="petition_spec.html#L798" class="js-smell-location">3</a>                  <a href="petition_spec.html#L1538" class="js-smell-location">4</a>                  </div>  </li></ol>
        expect {
          subject.invalidate!
        }.to change {
          subject.reload.invalidated_count
        }.from(0).to(3)
      end

      it &quot;sets the started_at timestamp&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L959" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L967" class="js-smell-location">1</a>                  <a href="parliament_spec.html#L681" class="js-smell-location">2</a>                  <a href="parliament_spec.html#L826" class="js-smell-location">3</a>                  <a href="petition/statistics_spec.html#L60" class="js-smell-location">4</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(instance methods)::describe(#invalidate!)::it#sets the started_at timestamp has a flog score of 31</span>          </div>  </li></ol>
        expect {
          subject.invalidate!
        }.to change {
          subject.reload.started_at
        }.from(nil).to(be_within(1.second).of(Time.current))
      end

      it &quot;sets the completed_at timestamp&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L959" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L967" class="js-smell-location">1</a>                  <a href="parliament_spec.html#L681" class="js-smell-location">2</a>                  <a href="parliament_spec.html#L826" class="js-smell-location">3</a>                  <a href="petition/statistics_spec.html#L60" class="js-smell-location">4</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(instance methods)::describe(#invalidate!)::it#sets the completed_at timestamp has a flog score of 31</span>          </div>  </li></ol>
        expect {
          subject.invalidate!
        }.to change {
          subject.reload.completed_at
        }.from(nil).to(be_within(1.second).of(Time.current))
      end

      it &quot;adds the invalidated signatures to the signatures association&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L938" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L951" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L975" class="js-smell-location">2</a>                  <a href="petition_spec.html#L798" class="js-smell-location">3</a>                  <a href="petition_spec.html#L1538" class="js-smell-location">4</a>                  </div>  </li></ol>
        expect {
          subject.invalidate!
        }.to change {
          subject.signatures.count
        }.from(0).to(3)
      end

      context &quot;when the invalidation has already completed processing&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L249" class="js-smell-location">0</a>                  <a href="invalidation_spec.html#L257" class="js-smell-location">1</a>                  <a href="invalidation_spec.html#L309" class="js-smell-location">2</a>                  <a href="invalidation_spec.html#L365" class="js-smell-location">3</a>                  <a href="invalidation_spec.html#L983" class="js-smell-location">4</a>                  </div>  </li></ol>
        subject { FactoryBot.create(:invalidation, ip_address: &quot;10.0.1.1&quot;, completed_at: Time.current) }

        it &quot;returns false&quot; do
          expect(subject.invalidate!).to be_falsey
        end
      end

      context &quot;when cancelled before starting&quot; do
        before do
          subject.cancel!
        end

        it &quot;doesn&#39;t start&quot; do
          expect {
            subject.invalidate!
          }.not_to change {
            subject.reload.started_at
          }
        end
      end

      context &quot;when cancelled during processing&quot; do
        before do
          200.times do
            FactoryBot.create(:validated_signature, ip_address: &quot;10.0.1.1&quot;, petition: petition)
          end
        end

        it &quot;doesn&#39;t finish&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(instance methods)::describe(#invalidate!)::context(when cancelled during processing)::it#doesn't finish has a flog score of 52</span>          </div>  </li></ol>
          allow(subject).to receive(:cancelled?).and_return(false, true)

          subject.invalidate!
          subject.reload

          expect(subject.matching_count).to eq(203)
          expect(subject.invalidated_count).to eq(100)
          expect(subject.signatures.count).to eq(100)
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- JavaScripts -->
    <script src='../../assets/javascripts/jquery.min.js'></script>
    <script src='../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../assets/javascripts/prettify.js'></script>
    <script src='../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../assets/javascripts/application.js'></script>
    <script src='../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>

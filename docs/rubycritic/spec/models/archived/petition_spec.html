<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" alt="Ruby Critic Logo" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
      
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2017-11-24 15:30:14 +0000'>2017-11-24 15:30:14 +0000</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/models/archived /</small> petition_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">1099</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">30</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">2398.51</span><small> complexity</small></div>
              <div><span class="metric">1619</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                28
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;rails_helper&#39;
require_relative &#39;../taggable_examples&#39;

RSpec.describe Archived::Petition, type: :model do
  subject(:petition){ described_class.new }

  describe &quot;associations&quot; do
    describe &quot;parliament&quot; do
      it { is_expected.to belong_to(:parliament).inverse_of(:petitions) }

      it &quot;is required&quot; do
        expect {
          petition.valid?
        }.to change {
          petition.errors[:parliament]
        }.from([]).to([&quot;Parliament can&#39;t be blank&quot;])
      end
    end

    describe &quot;government_response&quot; do
      it { is_expected.to have_one(:government_response) }
    end

    describe &quot;rejection&quot; do
      it { is_expected.to have_one(:rejection) }
    end
  end

  describe &quot;callbacks&quot; do
    describe &quot;updating the scheduled debate date&quot; do
      context &quot;when the debate date is changed to nil&quot; do
        subject(:petition) {
          FactoryBot.create(:archived_petition,
            scheduled_debate_date: 2.days.from_now,
            debate_state: &quot;scheduled&quot;
          )
        }

        it &quot;sets the debate state to &#39;awaiting&#39;&quot; do
          expect {
            petition.update(scheduled_debate_date: nil)
          }.to change {
            petition.debate_state
          }.from(&quot;scheduled&quot;).to(&quot;awaiting&quot;)
        end
      end

      context &quot;when the debate date is in the future&quot; do
        subject(:petition) {
          FactoryBot.create(:archived_petition,
            scheduled_debate_date: nil,
            debate_state: &quot;awaiting&quot;
          )
        }

        it &quot;sets the debate state to &#39;awaiting&#39;&quot; do
          expect {
            petition.update(scheduled_debate_date: 2.days.from_now)
          }.to change {
            petition.debate_state
          }.from(&quot;awaiting&quot;).to(&quot;scheduled&quot;)
        end
      end

      context &quot;when the debate date is in the past&quot; do
        subject(:petition) {
          FactoryBot.create(:archived_petition,
            scheduled_debate_date: nil,
            debate_state: &quot;awaiting&quot;
          )
        }

        it &quot;sets the debate state to &#39;debated&#39;&quot; do
          expect {
            petition.update(scheduled_debate_date: 2.days.ago)
          }.to change {
            petition.debate_state
          }.from(&quot;awaiting&quot;).to(&quot;debated&quot;)
        end
      end

      context &quot;when the debate date is not changed&quot; do
        subject(:petition) {
          FactoryBot.create(:archived_petition,
            scheduled_debate_date: Date.yesterday,
            debate_state: &quot;awaiting&quot;
          )
        }

        it &quot;does not change the debate state&quot; do
          expect {
            petition.update(special_consideration: true)
          }.not_to change {
            petition.debate_state
          }
        end
      end
    end
  end

  describe &quot;.search&quot; do
    let!(:petition_1) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L102" class="js-smell-location">0</a>                  <a href="petition_spec.html#L106" class="js-smell-location">1</a>                  <a href="petition_spec.html#L110" class="js-smell-location">2</a>                  </div>  </li></ol>
      FactoryBot.create(:archived_petition, :closed, action: &quot;Wombles are great&quot;, created_at: 1.year.ago, signature_count: 100)
    end

    let!(:petition_2) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L102" class="js-smell-location">0</a>                  <a href="petition_spec.html#L106" class="js-smell-location">1</a>                  <a href="petition_spec.html#L110" class="js-smell-location">2</a>                  </div>  </li></ol>
      FactoryBot.create(:archived_petition, :closed, background: &quot;The Wombles of Wimbledon&quot;, created_at: 2.years.ago, signature_count: 200)
    end

    let!(:petition_3) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L102" class="js-smell-location">0</a>                  <a href="petition_spec.html#L106" class="js-smell-location">1</a>                  <a href="petition_spec.html#L110" class="js-smell-location">2</a>                  </div>  </li></ol>
      FactoryBot.create(:archived_petition, :closed, additional_details: &quot;Are wombling free&quot;, created_at: 3.years.ago, signature_count: 300)
    end

    it &quot;searches based upon action&quot; do
      expect(Archived::Petition.search(q: &quot;wombles&quot;)).to include(petition_1)
    end

    it &quot;searches based upon background&quot; do
      expect(Archived::Petition.search(q: &quot;wimbledon&quot;)).to include(petition_2)
    end

    it &quot;searches based upon additional_details&quot; do
      expect(Archived::Petition.search(q: &quot;wombling&quot;)).to include(petition_3)
    end

    it &quot;sorts the results by the highest number of signatures&quot; do
      expect(Archived::Petition.search(q: &quot;Petition&quot;).to_a).to eq([petition_3, petition_2, petition_1])
    end
  end

  describe &quot;.by_created_at&quot; do
    let!(:petition_1) { FactoryBot.create(:archived_petition, created_at: 3.years.ago) }
    let!(:petition_2) { FactoryBot.create(:archived_petition, created_at: 1.year.ago) }
    let!(:petition_3) { FactoryBot.create(:archived_petition, created_at: 2.years.ago) }
    let(:petitions) { [petition_1, petition_3, petition_2] }

    it &#39;returns archived petitions ordered by the created_at timestamp&#39; do
      expect(Archived::Petition.by_created_at).to eq(petitions)
    end
  end

  describe &quot;.by_most_signatures&quot; do
    let!(:petition_1) { FactoryBot.create(:archived_petition, signature_count: 100) }
    let!(:petition_2) { FactoryBot.create(:archived_petition, signature_count: 10) }
    let!(:petition_3) { FactoryBot.create(:archived_petition, signature_count: 50) }
    let(:petitions) { [petition_1, petition_3, petition_2] }

    it &#39;returns archived petitions ordered by highest number of signatures&#39; do
      expect(Archived::Petition.by_most_signatures).to eq(petitions)
    end
  end

  describe &quot;.with_response&quot; do
    before do
      @p1 = FactoryBot.create(:archived_petition, :response)
      @p2 = FactoryBot.create(:archived_petition)
      @p3 = FactoryBot.create(:archived_petition, :response)
      @p4 = FactoryBot.create(:archived_petition)
    end

    it &quot;returns only the petitions have a government response timestamp&quot; do
      expect(described_class.with_response).to match_array([@p1, @p3])
    end
  end

  describe &quot;.visible&quot; do
    let!(:stopped_petition) { FactoryBot.create(:archived_petition, :stopped) }
    let!(:closed_petition) { FactoryBot.create(:archived_petition, :closed) }
    let!(:rejected_petition) { FactoryBot.create(:archived_petition, :rejected) }
    let!(:hidden_petition) { FactoryBot.create(:archived_petition, :hidden) }

    it &quot;doesn&#39;t include stopped petitions&quot; do
      expect(described_class.visible).not_to include(stopped_petition)
    end

    it &quot;includes closed petitions&quot; do
      expect(described_class.visible).to include(closed_petition)
    end

    it &quot;includes rejected petitions&quot; do
      expect(described_class.visible).to include(rejected_petition)
    end

    it &quot;doesn&#39;t include hidden petitions&quot; do
      expect(described_class.visible).not_to include(hidden_petition)
    end
  end

  describe &quot;.in_need_of_marking_as_debated&quot; do
    context &quot;when a petition is not in the the &#39;awaiting&#39; debate state&quot; do
      let!(:petition) { FactoryBot.create(:archived_petition) }

      it &quot;does not find the petition&quot; do
        expect(described_class.in_need_of_marking_as_debated).not_to include(petition)
      end
    end

    context &quot;when a petition is awaiting a debate date&quot; do
      let!(:petition) {
        FactoryBot.create(:archived_petition,
          debate_state: &#39;awaiting&#39;,
          scheduled_debate_date: nil
        )
      }

      it &quot;does not find the petition&quot; do
        expect(described_class.in_need_of_marking_as_debated).not_to include(petition)
      end
    end

    context &quot;when a petition is awaiting a debate&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L211" class="js-smell-location">0</a>                  <a href="petition_spec.html#L243" class="js-smell-location">1</a>                  </div>  </li></ol>
      let!(:petition) {
        FactoryBot.create(:archived_petition,
          debate_state: &#39;awaiting&#39;,
          scheduled_debate_date: 2.days.from_now
        )
      }

      it &quot;does not find the petition&quot; do
        expect(described_class.in_need_of_marking_as_debated).not_to include(petition)
      end
    end

    context &quot;when a petition debate date has passed but is still marked as &#39;awaiting&#39;&quot; do
      let(:petition) {
        FactoryBot.build(:archived_petition,
          debate_state: &#39;awaiting&#39;,
          scheduled_debate_date: Date.tomorrow
        )
      }

      before do
        travel_to(2.days.ago) do
          petition.save
        end
      end

      it &quot;finds the petition&quot; do
        expect(described_class.in_need_of_marking_as_debated).to include(petition)
      end
    end

    context &quot;when a petition debate date has passed and it marked as &#39;debated&#39;&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L211" class="js-smell-location">0</a>                  <a href="petition_spec.html#L243" class="js-smell-location">1</a>                  </div>  </li></ol>
      let!(:petition) {
        FactoryBot.create(:archived_petition,
          debate_state: &#39;debated&#39;,
          scheduled_debate_date: 2.days.ago
        )
      }

      it &quot;does not find the petition&quot; do
        expect(described_class.in_need_of_marking_as_debated).not_to include(petition)
      end
    end
  end

  describe &quot;.mark_petitions_as_debated!&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L257" class="js-smell-location">0</a>                  <a href="../petition_spec.html#L1477" class="js-smell-location">1</a>                  </div>  </li></ol>
    context &quot;when a petition is in the scheduled debate state and the debate date has passed&quot; do
      let(:petition) {
        FactoryBot.build(:archived_petition,
          debate_state: &#39;scheduled&#39;,
          scheduled_debate_date: Date.tomorrow
        )
      }

      before do
        travel_to(2.days.ago) do
          petition.save
        end
      end

      it &quot;marks the petition as debated&quot; do
        expect{
          described_class.mark_petitions_as_debated!
        }.to change{ petition.reload.debate_state }.from(&#39;scheduled&#39;).to(&#39;debated&#39;)
      end
    end

    context &quot;when a petition is in the scheduled debate state and the debate date has not passed&quot; do
      let(:petition) {
        FactoryBot.build(:archived_petition,
          debate_state: &#39;scheduled&#39;,
          scheduled_debate_date: Date.tomorrow
        )
      }

      before do
        petition.save
      end

      it &quot;does not mark the petition as debated&quot; do
        expect{
          described_class.mark_petitions_as_debated!
        }.not_to change{ petition.reload.debate_state }
      end
    end
  end

  it_behaves_like &quot;a taggable model&quot;

  describe &quot;#action&quot; do
    it &quot;defaults to nil&quot; do
      expect(petition.action).to be_nil
    end

    it { is_expected.to validate_presence_of(:action) }
    it { is_expected.to validate_length_of(:action).is_at_most(150) }
  end

  describe &quot;#background&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L310" class="js-smell-location">0</a>                  <a href="petition_spec.html#L318" class="js-smell-location">1</a>                  </div>  </li></ol>
    it &quot;defaults to nil&quot; do
      expect(petition.background).to be_nil
    end

    it { is_expected.to validate_length_of(:background).is_at_most(300) }
  end

  describe &quot;#additional_details&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L310" class="js-smell-location">0</a>                  <a href="petition_spec.html#L318" class="js-smell-location">1</a>                  </div>  </li></ol>
    it &quot;defaults to nil&quot; do
      expect(petition.additional_details).to be_nil
    end

    it { is_expected.to validate_length_of(:additional_details).is_at_most(1000) }
  end

  describe &quot;#state&quot; do
    it &quot;defaults to &#39;closed&#39;&quot; do
      expect(petition.state).to eq(&quot;closed&quot;)
    end

    it { is_expected.to validate_presence_of(:state) }
    it { is_expected.to validate_inclusion_of(:state).in_array(%w[stopped closed rejected hidden]) }
  end

  describe &quot;#opened_at&quot; do
    it &quot;defaults to nil&quot; do
      expect(petition.opened_at).to be_nil
    end
  end

  describe &quot;#closed_at&quot; do
    it &quot;defaults to nil&quot; do
      expect(petition.closed_at).to be_nil
    end

    it { is_expected.to validate_presence_of(:closed_at) }
  end

  describe &quot;#rejected_at&quot; do
    it &quot;defaults to nil&quot; do
      expect(petition.opened_at).to be_nil
    end
  end

  describe &quot;#signature_count&quot; do
    it &quot;defaults to zero&quot; do
      expect(petition.signature_count).to be_zero
    end
  end

  describe &quot;#stopped?&quot; do
    context &quot;when petition is in a stopped state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L362" class="js-smell-location">0</a>                  <a href="petition_spec.html#L404" class="js-smell-location">1</a>                  <a href="petition_spec.html#L446" class="js-smell-location">2</a>                  <a href="petition_spec.html#L488" class="js-smell-location">3</a>                  <a href="../parliament_spec.html#L445" class="js-smell-location">4</a>                  <a href="../parliament_spec.html#L477" class="js-smell-location">5</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :stopped) }

      it &quot;returns true&quot; do
        expect(petition.stopped?).to eq(true)
      end
    end

    context &quot;when petition is in a closed state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L370" class="js-smell-location">0</a>                  <a href="petition_spec.html#L378" class="js-smell-location">1</a>                  <a href="petition_spec.html#L386" class="js-smell-location">2</a>                  <a href="petition_spec.html#L396" class="js-smell-location">3</a>                  <a href="petition_spec.html#L412" class="js-smell-location">4</a>                  <a href="petition_spec.html#L420" class="js-smell-location">5</a>                  <a href="petition_spec.html#L430" class="js-smell-location">6</a>                  <a href="petition_spec.html#L438" class="js-smell-location">7</a>                  <a href="petition_spec.html#L454" class="js-smell-location">8</a>                  <a href="petition_spec.html#L464" class="js-smell-location">9</a>                  <a href="petition_spec.html#L472" class="js-smell-location">10</a>                  <a href="petition_spec.html#L480" class="js-smell-location">11</a>                  <a href="../parliament_spec.html#L467" class="js-smell-location">12</a>                  <a href="../parliament_spec.html#L970" class="js-smell-location">13</a>                  <a href="../parliament_spec.html#L1038" class="js-smell-location">14</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :closed) }

      it &quot;returns false&quot; do
        expect(petition.stopped?).to eq(false)
      end
    end

    context &quot;when petition is in a rejected state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L370" class="js-smell-location">0</a>                  <a href="petition_spec.html#L378" class="js-smell-location">1</a>                  <a href="petition_spec.html#L386" class="js-smell-location">2</a>                  <a href="petition_spec.html#L396" class="js-smell-location">3</a>                  <a href="petition_spec.html#L412" class="js-smell-location">4</a>                  <a href="petition_spec.html#L420" class="js-smell-location">5</a>                  <a href="petition_spec.html#L430" class="js-smell-location">6</a>                  <a href="petition_spec.html#L438" class="js-smell-location">7</a>                  <a href="petition_spec.html#L454" class="js-smell-location">8</a>                  <a href="petition_spec.html#L464" class="js-smell-location">9</a>                  <a href="petition_spec.html#L472" class="js-smell-location">10</a>                  <a href="petition_spec.html#L480" class="js-smell-location">11</a>                  <a href="../parliament_spec.html#L467" class="js-smell-location">12</a>                  <a href="../parliament_spec.html#L970" class="js-smell-location">13</a>                  <a href="../parliament_spec.html#L1038" class="js-smell-location">14</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :rejected) }

      it &quot;returns false&quot; do
        expect(petition.stopped?).to eq(false)
      end
    end

    context &quot;when petition is in a hidden state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L370" class="js-smell-location">0</a>                  <a href="petition_spec.html#L378" class="js-smell-location">1</a>                  <a href="petition_spec.html#L386" class="js-smell-location">2</a>                  <a href="petition_spec.html#L396" class="js-smell-location">3</a>                  <a href="petition_spec.html#L412" class="js-smell-location">4</a>                  <a href="petition_spec.html#L420" class="js-smell-location">5</a>                  <a href="petition_spec.html#L430" class="js-smell-location">6</a>                  <a href="petition_spec.html#L438" class="js-smell-location">7</a>                  <a href="petition_spec.html#L454" class="js-smell-location">8</a>                  <a href="petition_spec.html#L464" class="js-smell-location">9</a>                  <a href="petition_spec.html#L472" class="js-smell-location">10</a>                  <a href="petition_spec.html#L480" class="js-smell-location">11</a>                  <a href="../parliament_spec.html#L467" class="js-smell-location">12</a>                  <a href="../parliament_spec.html#L970" class="js-smell-location">13</a>                  <a href="../parliament_spec.html#L1038" class="js-smell-location">14</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :hidden) }

      it &quot;returns false&quot; do
        expect(petition.stopped?).to eq(false)
      end
    end
  end

  describe &quot;#closed?&quot; do
    context &quot;when petition is in a stopped state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L370" class="js-smell-location">0</a>                  <a href="petition_spec.html#L378" class="js-smell-location">1</a>                  <a href="petition_spec.html#L386" class="js-smell-location">2</a>                  <a href="petition_spec.html#L396" class="js-smell-location">3</a>                  <a href="petition_spec.html#L412" class="js-smell-location">4</a>                  <a href="petition_spec.html#L420" class="js-smell-location">5</a>                  <a href="petition_spec.html#L430" class="js-smell-location">6</a>                  <a href="petition_spec.html#L438" class="js-smell-location">7</a>                  <a href="petition_spec.html#L454" class="js-smell-location">8</a>                  <a href="petition_spec.html#L464" class="js-smell-location">9</a>                  <a href="petition_spec.html#L472" class="js-smell-location">10</a>                  <a href="petition_spec.html#L480" class="js-smell-location">11</a>                  <a href="../parliament_spec.html#L467" class="js-smell-location">12</a>                  <a href="../parliament_spec.html#L970" class="js-smell-location">13</a>                  <a href="../parliament_spec.html#L1038" class="js-smell-location">14</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :stopped) }

      it &quot;returns false&quot; do
        expect(petition.closed?).to eq(false)
      end
    end

    context &quot;when petition is in a closed state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L362" class="js-smell-location">0</a>                  <a href="petition_spec.html#L404" class="js-smell-location">1</a>                  <a href="petition_spec.html#L446" class="js-smell-location">2</a>                  <a href="petition_spec.html#L488" class="js-smell-location">3</a>                  <a href="../parliament_spec.html#L445" class="js-smell-location">4</a>                  <a href="../parliament_spec.html#L477" class="js-smell-location">5</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :closed) }

      it &quot;returns true&quot; do
        expect(petition.closed?).to eq(true)
      end
    end

    context &quot;when petition is in a rejected state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L370" class="js-smell-location">0</a>                  <a href="petition_spec.html#L378" class="js-smell-location">1</a>                  <a href="petition_spec.html#L386" class="js-smell-location">2</a>                  <a href="petition_spec.html#L396" class="js-smell-location">3</a>                  <a href="petition_spec.html#L412" class="js-smell-location">4</a>                  <a href="petition_spec.html#L420" class="js-smell-location">5</a>                  <a href="petition_spec.html#L430" class="js-smell-location">6</a>                  <a href="petition_spec.html#L438" class="js-smell-location">7</a>                  <a href="petition_spec.html#L454" class="js-smell-location">8</a>                  <a href="petition_spec.html#L464" class="js-smell-location">9</a>                  <a href="petition_spec.html#L472" class="js-smell-location">10</a>                  <a href="petition_spec.html#L480" class="js-smell-location">11</a>                  <a href="../parliament_spec.html#L467" class="js-smell-location">12</a>                  <a href="../parliament_spec.html#L970" class="js-smell-location">13</a>                  <a href="../parliament_spec.html#L1038" class="js-smell-location">14</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :rejected) }

      it &quot;returns false&quot; do
        expect(petition.closed?).to eq(false)
      end
    end

    context &quot;when petition is in a hidden state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L370" class="js-smell-location">0</a>                  <a href="petition_spec.html#L378" class="js-smell-location">1</a>                  <a href="petition_spec.html#L386" class="js-smell-location">2</a>                  <a href="petition_spec.html#L396" class="js-smell-location">3</a>                  <a href="petition_spec.html#L412" class="js-smell-location">4</a>                  <a href="petition_spec.html#L420" class="js-smell-location">5</a>                  <a href="petition_spec.html#L430" class="js-smell-location">6</a>                  <a href="petition_spec.html#L438" class="js-smell-location">7</a>                  <a href="petition_spec.html#L454" class="js-smell-location">8</a>                  <a href="petition_spec.html#L464" class="js-smell-location">9</a>                  <a href="petition_spec.html#L472" class="js-smell-location">10</a>                  <a href="petition_spec.html#L480" class="js-smell-location">11</a>                  <a href="../parliament_spec.html#L467" class="js-smell-location">12</a>                  <a href="../parliament_spec.html#L970" class="js-smell-location">13</a>                  <a href="../parliament_spec.html#L1038" class="js-smell-location">14</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :hidden) }

      it &quot;returns false&quot; do
        expect(petition.closed?).to eq(false)
      end
    end
  end

  describe &quot;#rejected?&quot; do
    context &quot;when petition is in a stopped state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L370" class="js-smell-location">0</a>                  <a href="petition_spec.html#L378" class="js-smell-location">1</a>                  <a href="petition_spec.html#L386" class="js-smell-location">2</a>                  <a href="petition_spec.html#L396" class="js-smell-location">3</a>                  <a href="petition_spec.html#L412" class="js-smell-location">4</a>                  <a href="petition_spec.html#L420" class="js-smell-location">5</a>                  <a href="petition_spec.html#L430" class="js-smell-location">6</a>                  <a href="petition_spec.html#L438" class="js-smell-location">7</a>                  <a href="petition_spec.html#L454" class="js-smell-location">8</a>                  <a href="petition_spec.html#L464" class="js-smell-location">9</a>                  <a href="petition_spec.html#L472" class="js-smell-location">10</a>                  <a href="petition_spec.html#L480" class="js-smell-location">11</a>                  <a href="../parliament_spec.html#L467" class="js-smell-location">12</a>                  <a href="../parliament_spec.html#L970" class="js-smell-location">13</a>                  <a href="../parliament_spec.html#L1038" class="js-smell-location">14</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :stopped) }

      it &quot;returns false&quot; do
        expect(petition.rejected?).to eq(false)
      end
    end

    context &quot;when petition is in a closed state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L370" class="js-smell-location">0</a>                  <a href="petition_spec.html#L378" class="js-smell-location">1</a>                  <a href="petition_spec.html#L386" class="js-smell-location">2</a>                  <a href="petition_spec.html#L396" class="js-smell-location">3</a>                  <a href="petition_spec.html#L412" class="js-smell-location">4</a>                  <a href="petition_spec.html#L420" class="js-smell-location">5</a>                  <a href="petition_spec.html#L430" class="js-smell-location">6</a>                  <a href="petition_spec.html#L438" class="js-smell-location">7</a>                  <a href="petition_spec.html#L454" class="js-smell-location">8</a>                  <a href="petition_spec.html#L464" class="js-smell-location">9</a>                  <a href="petition_spec.html#L472" class="js-smell-location">10</a>                  <a href="petition_spec.html#L480" class="js-smell-location">11</a>                  <a href="../parliament_spec.html#L467" class="js-smell-location">12</a>                  <a href="../parliament_spec.html#L970" class="js-smell-location">13</a>                  <a href="../parliament_spec.html#L1038" class="js-smell-location">14</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :closed) }

      it &quot;returns false&quot; do
        expect(petition.rejected?).to eq(false)
      end
    end

    context &quot;when petition is in a rejected state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L362" class="js-smell-location">0</a>                  <a href="petition_spec.html#L404" class="js-smell-location">1</a>                  <a href="petition_spec.html#L446" class="js-smell-location">2</a>                  <a href="petition_spec.html#L488" class="js-smell-location">3</a>                  <a href="../parliament_spec.html#L445" class="js-smell-location">4</a>                  <a href="../parliament_spec.html#L477" class="js-smell-location">5</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :rejected) }

      it &quot;returns true&quot; do
        expect(petition.rejected?).to eq(true)
      end
    end

    context &quot;when petition is in a hidden state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L370" class="js-smell-location">0</a>                  <a href="petition_spec.html#L378" class="js-smell-location">1</a>                  <a href="petition_spec.html#L386" class="js-smell-location">2</a>                  <a href="petition_spec.html#L396" class="js-smell-location">3</a>                  <a href="petition_spec.html#L412" class="js-smell-location">4</a>                  <a href="petition_spec.html#L420" class="js-smell-location">5</a>                  <a href="petition_spec.html#L430" class="js-smell-location">6</a>                  <a href="petition_spec.html#L438" class="js-smell-location">7</a>                  <a href="petition_spec.html#L454" class="js-smell-location">8</a>                  <a href="petition_spec.html#L464" class="js-smell-location">9</a>                  <a href="petition_spec.html#L472" class="js-smell-location">10</a>                  <a href="petition_spec.html#L480" class="js-smell-location">11</a>                  <a href="../parliament_spec.html#L467" class="js-smell-location">12</a>                  <a href="../parliament_spec.html#L970" class="js-smell-location">13</a>                  <a href="../parliament_spec.html#L1038" class="js-smell-location">14</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :hidden) }

      it &quot;returns false&quot; do
        expect(petition.rejected?).to eq(false)
      end
    end
  end

  describe &quot;#hidden?&quot; do
    context &quot;when petition is in a stopped state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L370" class="js-smell-location">0</a>                  <a href="petition_spec.html#L378" class="js-smell-location">1</a>                  <a href="petition_spec.html#L386" class="js-smell-location">2</a>                  <a href="petition_spec.html#L396" class="js-smell-location">3</a>                  <a href="petition_spec.html#L412" class="js-smell-location">4</a>                  <a href="petition_spec.html#L420" class="js-smell-location">5</a>                  <a href="petition_spec.html#L430" class="js-smell-location">6</a>                  <a href="petition_spec.html#L438" class="js-smell-location">7</a>                  <a href="petition_spec.html#L454" class="js-smell-location">8</a>                  <a href="petition_spec.html#L464" class="js-smell-location">9</a>                  <a href="petition_spec.html#L472" class="js-smell-location">10</a>                  <a href="petition_spec.html#L480" class="js-smell-location">11</a>                  <a href="../parliament_spec.html#L467" class="js-smell-location">12</a>                  <a href="../parliament_spec.html#L970" class="js-smell-location">13</a>                  <a href="../parliament_spec.html#L1038" class="js-smell-location">14</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :stopped) }

      it &quot;returns false&quot; do
        expect(petition.hidden?).to eq(false)
      end
    end

    context &quot;when petition is in a closed state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L370" class="js-smell-location">0</a>                  <a href="petition_spec.html#L378" class="js-smell-location">1</a>                  <a href="petition_spec.html#L386" class="js-smell-location">2</a>                  <a href="petition_spec.html#L396" class="js-smell-location">3</a>                  <a href="petition_spec.html#L412" class="js-smell-location">4</a>                  <a href="petition_spec.html#L420" class="js-smell-location">5</a>                  <a href="petition_spec.html#L430" class="js-smell-location">6</a>                  <a href="petition_spec.html#L438" class="js-smell-location">7</a>                  <a href="petition_spec.html#L454" class="js-smell-location">8</a>                  <a href="petition_spec.html#L464" class="js-smell-location">9</a>                  <a href="petition_spec.html#L472" class="js-smell-location">10</a>                  <a href="petition_spec.html#L480" class="js-smell-location">11</a>                  <a href="../parliament_spec.html#L467" class="js-smell-location">12</a>                  <a href="../parliament_spec.html#L970" class="js-smell-location">13</a>                  <a href="../parliament_spec.html#L1038" class="js-smell-location">14</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :closed) }

      it &quot;returns false&quot; do
        expect(petition.hidden?).to eq(false)
      end
    end

    context &quot;when petition is in a rejected state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L370" class="js-smell-location">0</a>                  <a href="petition_spec.html#L378" class="js-smell-location">1</a>                  <a href="petition_spec.html#L386" class="js-smell-location">2</a>                  <a href="petition_spec.html#L396" class="js-smell-location">3</a>                  <a href="petition_spec.html#L412" class="js-smell-location">4</a>                  <a href="petition_spec.html#L420" class="js-smell-location">5</a>                  <a href="petition_spec.html#L430" class="js-smell-location">6</a>                  <a href="petition_spec.html#L438" class="js-smell-location">7</a>                  <a href="petition_spec.html#L454" class="js-smell-location">8</a>                  <a href="petition_spec.html#L464" class="js-smell-location">9</a>                  <a href="petition_spec.html#L472" class="js-smell-location">10</a>                  <a href="petition_spec.html#L480" class="js-smell-location">11</a>                  <a href="../parliament_spec.html#L467" class="js-smell-location">12</a>                  <a href="../parliament_spec.html#L970" class="js-smell-location">13</a>                  <a href="../parliament_spec.html#L1038" class="js-smell-location">14</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :rejected) }

      it &quot;returns false&quot; do
        expect(petition.hidden?).to eq(false)
      end
    end

    context &quot;when petition is in a hidden state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L362" class="js-smell-location">0</a>                  <a href="petition_spec.html#L404" class="js-smell-location">1</a>                  <a href="petition_spec.html#L446" class="js-smell-location">2</a>                  <a href="petition_spec.html#L488" class="js-smell-location">3</a>                  <a href="../parliament_spec.html#L445" class="js-smell-location">4</a>                  <a href="../parliament_spec.html#L477" class="js-smell-location">5</a>                  </div>  </li></ol>
      subject(:petition) { FactoryBot.build(:archived_petition, :hidden) }

      it &quot;returns false&quot; do
        expect(petition.hidden?).to eq(true)
      end
    end
  end

  describe &quot;#duration&quot; do
    context &quot;when the parliament petition duration is nil&quot; do
      let(:parliament) { FactoryBot.create(:parliament, petition_duration: nil) }

      context &quot;and the petition was not published&quot; do
        let(:petition) { FactoryBot.create(:archived_petition, :rejected, parliament: parliament) }

        it &quot;returns 0&quot; do
          expect(petition.duration).to eq(0)
        end
      end

      context &quot;and the petition was published for three months&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L509" class="js-smell-location">0</a>                  <a href="petition_spec.html#L519" class="js-smell-location">1</a>                  <a href="petition_spec.html#L529" class="js-smell-location">2</a>                  <a href="petition_spec.html#L539" class="js-smell-location">3</a>                  </div>  </li></ol>
        let(:opened_at) { 2.years.ago }
        let(:closed_at) { opened_at + 3.months }
        let(:petition) { FactoryBot.create(:archived_petition, opened_at: opened_at, closed_at: closed_at, parliament: parliament) }

        it &quot;returns 3&quot; do
          expect(petition.duration).to eq(3)
        end
      end

      context &quot;and the petition was published for six months&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L509" class="js-smell-location">0</a>                  <a href="petition_spec.html#L519" class="js-smell-location">1</a>                  <a href="petition_spec.html#L529" class="js-smell-location">2</a>                  <a href="petition_spec.html#L539" class="js-smell-location">3</a>                  </div>  </li></ol>
        let(:opened_at) { 2.years.ago }
        let(:closed_at) { opened_at + 6.months }
        let(:petition) { FactoryBot.create(:archived_petition, opened_at: opened_at, closed_at: closed_at, parliament: parliament) }

        it &quot;returns 3&quot; do
          expect(petition.duration).to eq(6)
        end
      end

      context &quot;and the petition was published for nine months&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L509" class="js-smell-location">0</a>                  <a href="petition_spec.html#L519" class="js-smell-location">1</a>                  <a href="petition_spec.html#L529" class="js-smell-location">2</a>                  <a href="petition_spec.html#L539" class="js-smell-location">3</a>                  </div>  </li></ol>
        let(:opened_at) { 2.years.ago }
        let(:closed_at) { opened_at + 9.months }
        let(:petition) { FactoryBot.create(:archived_petition, opened_at: opened_at, closed_at: closed_at, parliament: parliament) }

        it &quot;returns 3&quot; do
          expect(petition.duration).to eq(9)
        end
      end

      context &quot;and the petition was published for twelve months&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L509" class="js-smell-location">0</a>                  <a href="petition_spec.html#L519" class="js-smell-location">1</a>                  <a href="petition_spec.html#L529" class="js-smell-location">2</a>                  <a href="petition_spec.html#L539" class="js-smell-location">3</a>                  </div>  </li></ol>
        let(:opened_at) { 2.years.ago }
        let(:closed_at) { opened_at + 12.months }
        let(:petition) { FactoryBot.create(:archived_petition, opened_at: opened_at, closed_at: closed_at, parliament: parliament) }

        it &quot;returns 3&quot; do
          expect(petition.duration).to eq(12)
        end
      end

      context &quot;and the petition was published for an arbitrary length of time&quot; do
        let(:opened_at) { 2.years.ago }
        let(:closed_at) { opened_at + 45.days }
        let(:petition) { FactoryBot.create(:archived_petition, opened_at: opened_at, closed_at: closed_at, parliament: parliament) }

        it &quot;returns a fractional number of months assuming that 1 month == 30 days&quot; do
          expect(petition.duration).to be_within(0.1).of(1.5)
        end
      end
    end

    context &quot;when the parliament petition duration is not nil&quot; do
      let(:parliament) { FactoryBot.create(:parliament, petition_duration: 6) }
      let(:petition) { FactoryBot.create(:archived_petition, parliament: parliament) }

      it &quot;returns the duration from the parliament&quot; do
        expect(petition.duration).to eq(6)
      end
    end
  end

  describe &quot;#threshold_for_response&quot; do
    it { is_expected.to delegate_method(:threshold_for_response).to(:parliament) }
  end

  describe &quot;#threshold_for_debate&quot; do
    it { is_expected.to delegate_method(:threshold_for_response).to(:parliament) }
  end

  describe &quot;#closed_early_due_to_election?&quot; do
    let(:parliament) { FactoryBot.create(:parliament, :dissolved, :archived, dissolution_at: &quot;2015-05-18T23:59:59&quot;) }
    let(:petition) { FactoryBot.create(:archived_petition, parliament: parliament, closed_at: closed_at) }

    context &quot;when closed_at is before the dissolution_at timestamp&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L582" class="js-smell-location">0</a>                  <a href="petition_spec.html#L598" class="js-smell-location">1</a>                  </div>  </li></ol>
      let(:closed_at) { &quot;2015-05-01T00:00:00&quot; }

      it &quot;returns false&quot; do
        expect(petition.closed_early_due_to_election?).to eq(false)
      end
    end

    context &quot;when closed_at is equal to the dissolution_at timestamp&quot; do
      let(:closed_at) { &quot;2015-05-18T23:59:59&quot; }

      it &quot;returns true&quot; do
        expect(petition.closed_early_due_to_election?).to eq(true)
      end
    end

    context &quot;when closed_at is after the dissolution_at timestamp&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L582" class="js-smell-location">0</a>                  <a href="petition_spec.html#L598" class="js-smell-location">1</a>                  </div>  </li></ol>
      let(:closed_at) { &quot;2015-06-01T00:00:00&quot; }

      it &quot;returns false&quot; do
        expect(petition.closed_early_due_to_election?).to eq(false)
      end
    end
  end

  describe &quot;#threshold_for_response_reached?&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L607" class="js-smell-location">0</a>                  <a href="petition_spec.html#L636" class="js-smell-location">1</a>                  </div>  </li></ol>
    let(:parliament) { FactoryBot.create(:parliament, threshold_for_response: 500) }
    let(:petition) { FactoryBot.create(:archived_petition, parliament: parliament, signature_count: signature_count) }

    context &quot;when the signature count is less than the threshold&quot; do
      let(:signature_count) { 250 }

      it &quot;returns false&quot; do
        expect(petition.threshold_for_response_reached?).to eq(false)
      end
    end

    context &quot;when the signature count is equal to the threshold&quot; do
      let(:signature_count) { 500 }

      it &quot;returns true&quot; do
        expect(petition.threshold_for_response_reached?).to eq(true)
      end
    end

    context &quot;when the signature count is greater than the threshold&quot; do
      let(:signature_count) { 750 }

      it &quot;returns true&quot; do
        expect(petition.threshold_for_response_reached?).to eq(true)
      end
    end
  end

  describe &quot;#threshold_for_debate_reached?&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L607" class="js-smell-location">0</a>                  <a href="petition_spec.html#L636" class="js-smell-location">1</a>                  </div>  </li></ol>
    let(:parliament) { FactoryBot.create(:parliament, threshold_for_debate: 5000) }
    let(:petition) { FactoryBot.create(:archived_petition, parliament: parliament, signature_count: signature_count) }

    context &quot;when the signature count is less than the threshold&quot; do
      let(:signature_count) { 2500 }

      it &quot;returns false&quot; do
        expect(petition.threshold_for_debate_reached?).to eq(false)
      end
    end

    context &quot;when the signature count is equal to the threshold&quot; do
      let(:signature_count) { 5000 }

      it &quot;returns true&quot; do
        expect(petition.threshold_for_debate_reached?).to eq(true)
      end
    end

    context &quot;when the signature count is greater than the threshold&quot; do
      let(:signature_count) { 7500 }

      it &quot;returns true&quot; do
        expect(petition.threshold_for_debate_reached?).to eq(true)
      end
    end
  end

  describe &quot;#signatures_by_constituency&quot; do
    let(:petition) { FactoryBot.create(:archived_petition, signatures_by_constituency: signatures_by_constituency) }

    let(:signatures_by_constituency) do
      { &quot;3427&quot; =&gt; 123, &quot;3320&quot; =&gt; 456 }
    end

    before do
      FactoryBot.create(:constituency, :coventry_north_east)
      FactoryBot.create(:constituency, :bethnal_green_and_bow)
    end

    it &quot;returns an array of constituency signature details&quot; do
      expect(petition.signatures_by_constituency).to eq [
        {
          name: &quot;Bethnal Green and Bow&quot;,
          ons_code: &quot;E14000555&quot;,
          mp: &quot;Rushanara Ali MP&quot;,
          signature_count: 456
        },
        {
          name: &quot;Coventry North East&quot;,
          ons_code: &quot;E14000649&quot;,
          mp: &quot;Colleen Fletcher MP&quot;,
          signature_count: 123
        }
      ]
    end

    it &quot;only finds the constituencies once&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L694" class="js-smell-location">0</a>                  <a href="petition_spec.html#L729" class="js-smell-location">1</a>                  </div>  </li></ol>
      expect(Constituency).to receive(:where).with(external_id: %w[3427 3320]).once.and_call_original

      petition.signatures_by_constituency
      petition.signatures_by_constituency
    end
  end

  describe &quot;#signatures_by_country&quot; do
    let(:petition) { FactoryBot.create(:archived_petition, signatures_by_country: signatures_by_country) }

    let(:signatures_by_country) do
      { &quot;GB&quot; =&gt; 1234, &quot;US&quot; =&gt; 56 }
    end

    before do
      FactoryBot.create(:location, code: &quot;GB&quot;, name: &quot;United Kingdom&quot;)
      FactoryBot.create(:location, code: &quot;US&quot;, name: &quot;United States&quot;)
    end

    it &quot;returns an array of country signature details&quot; do
      expect(petition.signatures_by_country).to eq [
        {
          name: &quot;United Kingdom&quot;,
          code: &quot;GB&quot;,
          signature_count: 1234
        },
        {
          name: &quot;United States&quot;,
          code: &quot;US&quot;,
          signature_count: 56
        }
      ]
    end

    it &quot;only finds the countries once&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L694" class="js-smell-location">0</a>                  <a href="petition_spec.html#L729" class="js-smell-location">1</a>                  </div>  </li></ol>
      expect(Location).to receive(:where).with(code: %w[GB US]).once.and_call_original

      petition.signatures_by_country
      petition.signatures_by_country
    end
  end

  describe &quot;#get_email_requested_at_for&quot; do
    let(:requested_at) { Time.current }

    %w[government_response debate_scheduled debate_outcome petition_email].each do |timestamp|
      context &quot;when nothing has been requested for &#39;#{timestamp}&#39;&quot; do
        let(:petition) { FactoryBot.create(:archived_petition, &quot;email_requested_for_#{timestamp}_at&quot;: nil) }

        it &quot;returns nil&quot; do
          expect(petition.get_email_requested_at_for(timestamp)).to be_nil
        end
      end

      context &quot;when an email has been requested for &#39;#{timestamp}&#39;&quot; do
        let(:petition) { FactoryBot.create(:archived_petition, &quot;email_requested_for_#{timestamp}_at&quot;: requested_at) }

        it &quot;returns the timestamp&quot; do
          expect(petition.get_email_requested_at_for(timestamp)).to be_usec_precise_with(requested_at)
        end
      end
    end
  end

  describe &#39;#set_email_requested_at_for&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe##set_email_requested_at_for has a flog score of 30</span>          </div>  </li></ol>
    let(:petition) { FactoryBot.create(:archived_petition) }
    let(:requested_at) { Time.current }

    %w[government_response debate_scheduled debate_outcome petition_email].each do |timestamp|
      it &quot;sets the email requested timestamp for &#39;#{timestamp}&#39;&quot; do
        expect {
          petition.set_email_requested_at_for(timestamp, to: requested_at)
        }.to change {
          petition[:&quot;email_requested_for_#{timestamp}_at&quot;]
        }.from(nil).to(be_usec_precise_with(requested_at))
      end
    end
  end

  describe &quot;#signatures_to_email_for&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe##signatures_to_email_for has a flog score of 59</span>          </div>  </li></ol>
    let!(:petition) { FactoryBot.create(:archived_petition) }
    let!(:creator) { FactoryBot.create(:archived_signature, petition: petition, creator: true) }
    let!(:pending) { FactoryBot.create(:archived_signature, petition: petition, state: &quot;pending&quot;) }
    let!(:fraudulent) { FactoryBot.create(:archived_signature, petition: petition, state: &quot;fraudulent&quot;) }
    let!(:invalidated) { FactoryBot.create(:archived_signature, petition: petition, state: &quot;invalidated&quot;) }
    let!(:subscribed) { FactoryBot.create(:archived_signature, petition: petition) }
    let!(:unsubscribed) { FactoryBot.create(:archived_signature, petition: petition, notify_by_email: false) }

    let(:requested_at) { 6.days.ago }

    %w[government_response debate_scheduled debate_outcome petition_email].each do |timestamp|
      context &quot;when the email requested timestamp for &#39;#{timestamp}&#39; is not set&quot; do
        it &quot;raises an ArgumentError&quot; do
          expect {
            petition.signatures_to_email_for(timestamp)
          }.to raise_error(ArgumentError, /#{timestamp} email has not been requested/)
        end
      end

      context &quot;when the email requested timestamp for &#39;#{timestamp}&#39; is set&quot; do
        before do
          petition.set_email_requested_at_for(timestamp, to: requested_at)
        end

        it &quot;includes subscribed signatures&quot; do
          expect(petition.signatures_to_email_for(timestamp)).to match_array([creator, subscribed])
        end

        it &quot;does not include unsubscribed signatures&quot; do
          expect(petition.signatures_to_email_for(timestamp)).not_to include(unsubscribed)
        end

        it &quot;does not include pending signatures&quot; do
          expect(petition.signatures_to_email_for(timestamp)).not_to include(pending)
        end

        it &quot;does not include fraudulent signatures&quot; do
          expect(petition.signatures_to_email_for(timestamp)).not_to include(fraudulent)
        end

        it &quot;does not include invalidated signatures&quot; do
          expect(petition.signatures_to_email_for(timestamp)).not_to include(invalidated)
        end

        context &quot;and the email sent timestamp for &#39;#{timestamp}&#39; is before the requested timestamp&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L819" class="js-smell-location">0</a>                  <a href="petition_spec.html#L839" class="js-smell-location">1</a>                  </div>  </li></ol>
          before do
            subscribed.set_email_sent_at_for(timestamp, to: requested_at - 1.day)
          end

          it &quot;includes the signature&quot; do
            expect(petition.signatures_to_email_for(timestamp)).to include(subscribed)
          end
        end

        context &quot;and the email sent timestamp for &#39;#{timestamp}&#39; is the same as the requested timestamp&quot; do
          before do
            subscribed.set_email_sent_at_for(timestamp, to: requested_at)
          end

          it &quot;does not include the signature&quot; do
            expect(petition.signatures_to_email_for(timestamp)).not_to include(subscribed)
          end
        end

        context &quot;and the email sent timestamp for &#39;#{timestamp}&#39; is after as the requested timestamp&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L819" class="js-smell-location">0</a>                  <a href="petition_spec.html#L839" class="js-smell-location">1</a>                  </div>  </li></ol>
          before do
            subscribed.set_email_sent_at_for(timestamp, to: requested_at + 1.day)
          end

          it &quot;does not include the signature&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#signatures_to_email_for)::it#does not include the signature has a flog score of 36</span>          </div>  </li></ol>
            expect(petition.signatures_to_email_for(timestamp)).not_to include(subscribed)
          end
        end
      end
    end
  end

  describe &quot;#update_lock!&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L852" class="js-smell-location">0</a>                  <a href="../petition_spec.html#L2690" class="js-smell-location">1</a>                  </div>  </li></ol>
    let(:current_user) { FactoryBot.create(:moderator_user) }

    context &quot;when the petition is not locked&quot; do
      let(:petition) { FactoryBot.create(:petition, locked_by: nil, locked_at: nil) }

      it &quot;doesn&#39;t update the locked_by association&quot; do
        expect {
          petition.update_lock!(current_user)
        }.not_to change {
          petition.reload.locked_by
        }
      end

      it &quot;doesn&#39;t update the locked_at timestamp&quot; do
        expect {
          petition.update_lock!(current_user)
        }.not_to change {
          petition.reload.locked_at
        }
      end
    end

    context &quot;when the petition is locked by someone else&quot; do
      let(:other_user) { FactoryBot.create(:moderator_user) }
      let(:petition) { FactoryBot.create(:petition, locked_by: other_user, locked_at: 1.hour.ago) }

      it &quot;doesn&#39;t update the locked_by association&quot; do
        expect {
          petition.update_lock!(current_user)
        }.not_to change {
          petition.reload.locked_by
        }
      end

      it &quot;doesn&#39;t update the locked_at timestamp&quot; do
        expect {
          petition.update_lock!(current_user)
        }.not_to change {
          petition.reload.locked_at
        }
      end
    end

    context &quot;when the petition is locked by the current user&quot; do
      let(:petition) { FactoryBot.create(:petition, locked_by: current_user, locked_at: 1.hour.ago) }

      it &quot;doesn&#39;t update the locked_by association&quot; do
        expect {
          petition.update_lock!(current_user)
        }.not_to change {
          petition.reload.locked_by
        }
      end

      it &quot;updates the locked_at timestamp&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#update_lock!)::context(when the petition is locked by the current user)::it#updates the locked_at timestamp has a flog score of 30</span>          </div>  </li></ol>
        expect {
          petition.update_lock!(current_user)
        }.to change {
          petition.reload.locked_at
        }.to be_within(1.second).of(Time.current)
      end
    end
  end

  describe &quot;#checkout!&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L917" class="js-smell-location">0</a>                  <a href="../petition_spec.html#L2755" class="js-smell-location">1</a>                  </div>  </li></ol>
    let(:current_user) { FactoryBot.create(:moderator_user) }

    context &quot;when the petition is not locked&quot; do
      let(:petition) { FactoryBot.create(:petition, locked_by: nil, locked_at: nil) }

      it &quot;updates the locked_by association&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#checkout!)::context(when the petition is not locked)::it#updates the locked_by association has a flog score of 26</span>          </div>  </li></ol>
        expect {
          petition.checkout!(current_user)
        }.to change {
          petition.reload.locked_by
        }.from(nil).to(current_user)
      end

      it &quot;updates the locked_at timestamp&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#checkout!)::context(when the petition is not locked)::it#updates the locked_at timestamp has a flog score of 33</span>          </div>  </li></ol>
        expect {
          petition.checkout!(current_user)
        }.to change {
          petition.reload.locked_at
        }.from(nil).to(be_within(1.second).of(Time.current))
      end
    end

    context &quot;when the petition is locked by someone else&quot; do
      let(:other_user) { FactoryBot.create(:moderator_user) }
      let(:petition) { FactoryBot.create(:petition, locked_by: other_user, locked_at: 1.hour.ago) }

      it &quot;returns false&quot; do
        expect(petition.checkout!(current_user)).to eq(false)
      end
    end

    context &quot;when the petition is locked by the current user&quot; do
      let(:petition) { FactoryBot.create(:petition, locked_by: current_user, locked_at: 1.hour.ago) }

      it &quot;doesn&#39;t update the locked_by association&quot; do
        expect {
          petition.checkout!(current_user)
        }.not_to change {
          petition.reload.locked_by
        }
      end

      it &quot;updates the locked_at timestamp&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#checkout!)::context(when the petition is locked by the current user)::it#updates the locked_at timestamp has a flog score of 30</span>          </div>  </li></ol>
        expect {
          petition.checkout!(current_user)
        }.to change {
          petition.reload.locked_at
        }.to be_within(1.second).of(Time.current)
      end
    end
  end

  describe &quot;#force_checkout!&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L970" class="js-smell-location">0</a>                  <a href="../petition_spec.html#L2808" class="js-smell-location">1</a>                  </div>  </li></ol>
    let(:current_user) { FactoryBot.create(:moderator_user) }

    context &quot;when the petition is not locked&quot; do
      let(:petition) { FactoryBot.create(:petition, locked_by: nil, locked_at: nil) }

      it &quot;updates the locked_by association&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#force_checkout!)::context(when the petition is not locked)::it#updates the locked_by association has a flog score of 26</span>          </div>  </li></ol>
        expect {
          petition.force_checkout!(current_user)
        }.to change {
          petition.reload.locked_by
        }.from(nil).to(current_user)
      end

      it &quot;updates the locked_at timestamp&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#force_checkout!)::context(when the petition is not locked)::it#updates the locked_at timestamp has a flog score of 33</span>          </div>  </li></ol>
        expect {
          petition.force_checkout!(current_user)
        }.to change {
          petition.reload.locked_at
        }.from(nil).to(be_within(1.second).of(Time.current))
      end
    end

    context &quot;when the petition is locked by someone else&quot; do
      let(:other_user) { FactoryBot.create(:moderator_user) }
      let(:petition) { FactoryBot.create(:petition, locked_by: other_user, locked_at: 1.hour.ago) }

      it &quot;updates the locked_by association&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#force_checkout!)::context(when the petition is locked by someone else)::it#updates the locked_by association has a flog score of 28</span>          </div>  </li></ol>
        expect {
          petition.force_checkout!(current_user)
        }.to change {
          petition.reload.locked_by
        }.from(other_user).to(current_user)
      end

      it &quot;updates the locked_at timestamp&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#force_checkout!)::context(when the petition is locked by someone else)::it#updates the locked_at timestamp has a flog score of 30</span>          </div>  </li></ol>
        expect {
          petition.force_checkout!(current_user)
        }.to change {
          petition.reload.locked_at
        }.to(be_within(1.second).of(Time.current))
      end
    end

    context &quot;when the petition is locked by the current user&quot; do
      let(:petition) { FactoryBot.create(:petition, locked_by: current_user, locked_at: 1.hour.ago) }

      it &quot;doesn&#39;t update the locked_by association&quot; do
        expect {
          petition.force_checkout!(current_user)
        }.not_to change {
          petition.reload.locked_by
        }
      end

      it &quot;updates the locked_at timestamp&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#force_checkout!)::context(when the petition is locked by the current user)::it#updates the locked_at timestamp has a flog score of 30</span>          </div>  </li></ol>
        expect {
          petition.force_checkout!(current_user)
        }.to change {
          petition.reload.locked_at
          }.to be_within(1.second).of(Time.current)
        end
      end
    end

  describe &quot;#release!&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L1035" class="js-smell-location">0</a>                  <a href="../petition_spec.html#L2873" class="js-smell-location">1</a>                  </div>  </li></ol>
    let(:current_user) { FactoryBot.create(:moderator_user) }

    context &quot;when the petition is not locked&quot; do
      let(:petition) { FactoryBot.create(:petition, locked_by: nil, locked_at: nil) }

      it &quot;doesn&#39;t update the locked_by association&quot; do
        expect {
          petition.release!(current_user)
        }.not_to change {
          petition.reload.locked_by
        }
      end

      it &quot;doesn&#39;t update the locked_at timestamp&quot; do
        expect {
          petition.release!(current_user)
        }.not_to change {
          petition.reload.locked_at
        }
      end
    end

    context &quot;when the petition is locked by someone else&quot; do
      let(:other_user) { FactoryBot.create(:moderator_user) }
      let(:petition) { FactoryBot.create(:petition, locked_by: other_user, locked_at: 1.hour.ago) }

      it &quot;doesn&#39;t update the locked_by association&quot; do
        expect {
          petition.release!(current_user)
        }.not_to change {
          petition.reload.locked_by
        }
      end

      it &quot;doesn&#39;t update the locked_at timestamp&quot; do
        expect {
          petition.release!(current_user)
        }.not_to change {
          petition.reload.locked_at
        }
      end
    end

    context &quot;when the petition is locked by the current user&quot; do
      let(:petition) { FactoryBot.create(:petition, locked_by: current_user, locked_at: 1.hour.ago) }

      it &quot;updates the locked_by association&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#release!)::context(when the petition is locked by the current user)::it#updates the locked_by association has a flog score of 26</span>          </div>  </li></ol>
        expect {
          petition.release!(current_user)
        }.to change {
          petition.reload.locked_by
        }.from(current_user).to(nil)
      end

      it &quot;updates the locked_at timestamp&quot; do
        expect {
          petition.release!(current_user)
        }.to change {
          petition.reload.locked_at
        }.to be_nil
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- JavaScripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>

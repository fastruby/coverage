<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../overview.html"><img src="../../assets/images/logo.png" alt="Ruby Critic Logo" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
      
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2019-07-18 15:50:31 +0100'>2019-07-18 15:50:31 +0100</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/models /</small> signature_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">2316</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">107</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">5624.47</span><small> complexity</small></div>
              <div><span class="metric">3240</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                92
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;rails_helper&#39;

RSpec.describe Signature, type: :model do
  it &quot;has a valid factory&quot; do
    expect(FactoryBot.build(:signature)).to be_valid
  end

  around do |example|
    perform_enqueued_jobs do
      example.call
    end
  end

  before do
    FactoryBot.create(:constituency, :london_and_westminster)
    FactoryBot.create(:location, code: &quot;GB&quot;, name: &quot;United Kingdom&quot;)
  end

  context &quot;defaults&quot; do
    it &quot;has pending as default state&quot; do
      s = Signature.new
      expect(s.state).to eq(&quot;pending&quot;)
    end

    it &quot;generates perishable token&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L11" class="js-smell-location">0</a>                  <a href="signature_spec.html#L25" class="js-smell-location">1</a>                  <a href="signature_spec.html#L35" class="js-smell-location">2</a>                  <a href="signature_spec.html#L40" class="js-smell-location">3</a>                  </div>  </li></ol>
      s = FactoryBot.create(:signature, :perishable_token =&gt; nil)
      expect(s.perishable_token).not_to be_nil
    end

    it &quot;sets notify_by_email to falsey&quot; do
      s = Signature.new
      expect(s.notify_by_email).to be_falsey
    end

    it &quot;generates unsubscription token&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L11" class="js-smell-location">0</a>                  <a href="signature_spec.html#L25" class="js-smell-location">1</a>                  <a href="signature_spec.html#L35" class="js-smell-location">2</a>                  <a href="signature_spec.html#L40" class="js-smell-location">3</a>                  </div>  </li></ol>
      s = FactoryBot.create(:signature, :unsubscribe_token =&gt; nil)
      expect(s.unsubscribe_token).not_to be_nil
    end

    it &quot;generates signed token&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L11" class="js-smell-location">0</a>                  <a href="signature_spec.html#L25" class="js-smell-location">1</a>                  <a href="signature_spec.html#L35" class="js-smell-location">2</a>                  <a href="signature_spec.html#L40" class="js-smell-location">3</a>                  </div>  </li></ol>
      s = FactoryBot.create(:signature, :signed_token =&gt; nil)
      expect(s.signed_token).not_to be_nil
    end
  end

  RSpec::Matchers.define :have_valid do |field|
    match do |actual|
      actual.valid?
      expect(actual.errors[field]).to be_empty
    end
  end

  context &quot;custom attribute setters&quot; do
    describe &quot;#postcode=&quot; do
      let(:signature) { FactoryBot.build(:signature) }

      it &quot;removes all whitespace&quot; do
        signature.postcode = &quot; N1  1TY  &quot;
        expect(signature.postcode).to eq &quot;N11TY&quot;
      end
      it &quot;upcases the postcode&quot; do
        signature.postcode = &quot;n11ty &quot;
        expect(signature.postcode).to eq &quot;N11TY&quot;
      end
      it &quot;removes whitespaces and upcase the postcode&quot; do
        signature.postcode = &quot;   N1  1ty &quot;
        expect(signature.postcode).to eq &quot;N11TY&quot;
      end
    end
    describe &quot;#email=&quot; do
      let(:signature) { FactoryBot.build(:signature) }

      it &quot;downcases the email&quot; do
        signature.email = &quot;JOE@PUBLIC.COM&quot;
        expect(signature.email).to eq &quot;joe@public.com&quot;
      end
    end
  end

  describe &quot;associations&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="invalidation_spec.html#L10" class="js-smell-location">0</a>                  <a href="signature_spec.html#L80" class="js-smell-location">1</a>                  </div>  </li></ol>
    it { is_expected.to belong_to(:petition) }
    it { is_expected.to belong_to(:invalidation) }
  end

  describe &quot;callbacks&quot; do
    context &quot;when the signature is destroyed&quot; do
      let(:attributes) { FactoryBot.attributes_for(:petition) }
      let(:creator) { FactoryBot.create(:pending_signature, creator: true) }
      let(:petition) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 7 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L89" class="js-smell-location">0</a>                  <a href="signature_spec.html#L575" class="js-smell-location">1</a>                  <a href="signature_spec.html#L698" class="js-smell-location">2</a>                  <a href="signature_spec.html#L826" class="js-smell-location">3</a>                  <a href="signature_spec.html#L893" class="js-smell-location">4</a>                  <a href="signature_spec.html#L1191" class="js-smell-location">5</a>                  <a href="signature_spec.html#L1203" class="js-smell-location">6</a>                  </div>  </li></ol>
        Petition.create(attributes) do |petition|
          petition.creator = creator

          5.times do
            petition.signatures &lt;&lt; FactoryBot.create(:pending_signature)
          end
        end
      end

      before do
        petition.signatures.each { |s| s.validate! }
        petition.publish
      end

      context &quot;and the signature is the creator&quot; do
        it &quot;cancels the destroy&quot; do
          expect(creator.destroy).to eq(false)
        end
      end

      context &quot;and the signature is not the creator&quot; do
        let(:country_journal) { CountryPetitionJournal.for(petition, &quot;GB&quot;) }
        let(:constituency_journal) { ConstituencyPetitionJournal.for(petition, &quot;3415&quot;) }

        let(:signature) {
          FactoryBot.create(
            :pending_signature,
            petition: petition,
            constituency_id: &quot;3415&quot;,
            location_code: &quot;GB&quot;
          )
        }

        before do
          signature.validate!
          petition.reload
        end

        it &quot;decrements the petition signature count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L128" class="js-smell-location">0</a>                  <a href="signature_spec.html#L133" class="js-smell-location">1</a>                  <a href="signature_spec.html#L138" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(callbacks)::context(when the signature is destroyed)::context(and the signature is not the creator)::it#decrements the petition signature count has a flog score of 31</span>          </div>  </li></ol>
          expect(petition.signature_count).to eq(7)
          expect{ signature.destroy }.to change{ petition.reload.signature_count }.by(-1)
        end

        it &quot;decrements the country journal signature count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L128" class="js-smell-location">0</a>                  <a href="signature_spec.html#L133" class="js-smell-location">1</a>                  <a href="signature_spec.html#L138" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(callbacks)::context(when the signature is destroyed)::context(and the signature is not the creator)::it#decrements the country journal signature count has a flog score of 31</span>          </div>  </li></ol>
          expect(petition.signature_count).to eq(7)
          expect{ signature.destroy }.to change{ country_journal.reload.signature_count }.by(-1)
        end

        it &quot;decrements the constituency journal signature count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L128" class="js-smell-location">0</a>                  <a href="signature_spec.html#L133" class="js-smell-location">1</a>                  <a href="signature_spec.html#L138" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(callbacks)::context(when the signature is destroyed)::context(and the signature is not the creator)::it#decrements the constituency journal signature count has a flog score of 31</span>          </div>  </li></ol>
          expect(petition.signature_count).to eq(7)
          expect{ signature.destroy }.to change{ constituency_journal.reload.signature_count }.by(-1)
        end
      end

      context &quot;and the signature is invalidated&quot; do
        let(:country_journal) { CountryPetitionJournal.for(petition, &quot;GB&quot;) }
        let(:constituency_journal) { ConstituencyPetitionJournal.for(petition, &quot;3415&quot;) }

        let(:signature) {
          FactoryBot.create(
            :pending_signature,
            petition: petition,
            constituency_id: &quot;3415&quot;,
            location_code: &quot;GB&quot;
          )
        }

        before do
          signature.validate!
          signature.invalidate!
          petition.reload
        end

        it &quot;doesn&#39;t decrement the petition signature count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L163" class="js-smell-location">0</a>                  <a href="signature_spec.html#L168" class="js-smell-location">1</a>                  <a href="signature_spec.html#L173" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(callbacks)::context(when the signature is destroyed)::context(and the signature is invalidated)::it#doesn't decrement the petition signature count has a flog score of 29</span>          </div>  </li></ol>
          expect(petition.signature_count).to eq(6)
          expect{ signature.destroy }.not_to change{ petition.reload.signature_count }
        end

        it &quot;doesn&#39;t decrement the country journal signature count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L163" class="js-smell-location">0</a>                  <a href="signature_spec.html#L168" class="js-smell-location">1</a>                  <a href="signature_spec.html#L173" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(callbacks)::context(when the signature is destroyed)::context(and the signature is invalidated)::it#doesn't decrement the country journal signature count has a flog score of 29</span>          </div>  </li></ol>
          expect(petition.signature_count).to eq(6)
          expect{ signature.destroy }.not_to change{ country_journal.reload.signature_count }
        end

        it &quot;doesn&#39;t decrement the constituency journal signature count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L163" class="js-smell-location">0</a>                  <a href="signature_spec.html#L168" class="js-smell-location">1</a>                  <a href="signature_spec.html#L173" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(callbacks)::context(when the signature is destroyed)::context(and the signature is invalidated)::it#doesn't decrement the constituency journal signature count has a flog score of 29</span>          </div>  </li></ol>
          expect(petition.signature_count).to eq(6)
          expect{ signature.destroy }.not_to change{ constituency_journal.reload.signature_count }
        end
      end
    end

    context &quot;when the signature is created&quot; do
      let!(:petition) { FactoryBot.create(:open_petition) }
      let!(:signature) { petition.signatures.build(attributes) }
      let(:email) { &quot;foo@example.com&quot; }
      let(:location_code) { &quot;GB&quot; }
      let(:postcode) { &quot;SW1A 1AA&quot; }

      let(:attributes) do
        {
          name: &quot;Suzy Signer&quot;,
          email: email,
          postcode: postcode,
          location_code: location_code,
          uk_citizenship: &quot;1&quot;
        }
      end

      context &quot;and the signature is a duplicate&quot; do
        before do
          petition.signatures.create!(attributes)
        end

        it &quot;raises an ActiveRecord::RecordNotUnique exception&quot; do
          expect { signature.save }.to raise_exception(ActiveRecord::RecordNotUnique)
        end
      end

      context &quot;and the email is blank&quot; do
        let(:email) { &quot;&quot; }

        it &quot;doesn&#39;t set the uuid column&quot; do
          expect {
            signature.save
          }.not_to change {
            signature.uuid
          }
        end
      end

      context &quot;and the email is set&quot; do
        let(:email) { &quot;alice@example.com&quot; }

        it &quot;sets the uuid column&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L222" class="js-smell-location">0</a>                  <a href="signature_spec.html#L241" class="js-smell-location">1</a>                  </div>  </li></ol>
          expect {
            signature.save
          }.to change {
            signature.uuid
          }.from(nil).to(&quot;6613a3fd-c2c4-5bc2-a6de-3dc0b2527dd6&quot;)
        end
      end

      context &quot;and the email is normalized&quot; do
        let!(:domain_1) { Domain.create(name: &quot;example.com&quot;, strip_extension: &quot;+&quot;, strip_characters: &quot;.&quot;) }
        let!(:domain_2) { Domain.create(name: &quot;example.co.uk&quot;, canonical_domain: domain_1) }

        let(:email) { &quot;alice.smith+petitions@example.co.uk&quot; }

        before do
          allow(Site).to receive(:disable_plus_address_check?).and_return(true)
        end

        it &quot;sets the canonical_email column&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L222" class="js-smell-location">0</a>                  <a href="signature_spec.html#L241" class="js-smell-location">1</a>                  </div>  </li></ol>
          expect {
            signature.save
          }.to change {
            signature.canonical_email
          }.from(nil).to(&quot;alicesmith@example.com&quot;)
        end
      end
    end
  end

  context &quot;validations&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context#validations has a flog score of 44</span>          </div>  </li></ol>
    it { is_expected.to validate_presence_of(:name).with_message(/must be completed/) }
    it { is_expected.to validate_presence_of(:email).with_message(/must be completed/) }
    it { is_expected.to validate_presence_of(:location_code).with_message(/must be completed/) }
    it { is_expected.to validate_length_of(:name).is_at_most(255) }
    it { is_expected.to validate_length_of(:constituency_id).is_at_most(255) }

    it &quot;validates format of email&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L259" class="js-smell-location">0</a>                  <a href="signature_spec.html#L264" class="js-smell-location">1</a>                  <a href="signature_spec.html#L301" class="js-smell-location">2</a>                  <a href="signature_spec.html#L312" class="js-smell-location">3</a>                  <a href="signature_spec.html#L317" class="js-smell-location">4</a>                  </div>  </li></ol>
      s = FactoryBot.build(:signature, :email =&gt; &#39;joe@example.com&#39;)
      expect(s).to have_valid(:email)
    end

    it &quot;does not allow invalid email&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L259" class="js-smell-location">0</a>                  <a href="signature_spec.html#L264" class="js-smell-location">1</a>                  <a href="signature_spec.html#L301" class="js-smell-location">2</a>                  <a href="signature_spec.html#L312" class="js-smell-location">3</a>                  <a href="signature_spec.html#L317" class="js-smell-location">4</a>                  </div>  </li></ol>
      s = FactoryBot.build(:signature, :email =&gt; &#39;not an email&#39;)
      expect(s).not_to have_valid(:email)
    end

    it &quot;does not allow emails using plus addresses&quot; do
      signature = FactoryBot.build(:signature, email: &#39;foobar+petitions@example.com&#39;)
      expect(signature).not_to have_valid(:email)
      expect(signature.errors.full_messages).to include(&quot;You can’t use ‘plus addressing’ in your email address&quot;)
    end

    it &quot;does not allow blank or unknown state&quot; do
      s = FactoryBot.build(:signature, :state =&gt; &#39;&#39;)
      expect(s).not_to have_valid(:state)
      s.state = &#39;unknown&#39;
      expect(s).not_to have_valid(:state)
    end

    it &quot;allows known states&quot; do
      s = FactoryBot.build(:signature)
      %w(pending validated ).each do |state|
        s.state = state
        expect(s).to have_valid(:state)
      end
    end

    describe &quot;postcode&quot; do
      it &quot;requires a postcode for a UK address&quot; do
        expect(FactoryBot.build(:signature, :postcode =&gt; &#39;SW1A 1AA&#39;)).to be_valid
        expect(FactoryBot.build(:signature, :postcode =&gt; &#39;&#39;)).not_to be_valid
      end

      it &quot;does not require a postcode for non-UK addresses&quot; do
        expect(FactoryBot.build(:signature, :location_code =&gt; &quot;GB&quot;, :postcode =&gt; &#39;&#39;)).not_to be_valid
        expect(FactoryBot.build(:signature, :location_code =&gt; &quot;US&quot;, :postcode =&gt; &#39;&#39;)).to be_valid
      end

      it &quot;checks the format of postcode&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L259" class="js-smell-location">0</a>                  <a href="signature_spec.html#L264" class="js-smell-location">1</a>                  <a href="signature_spec.html#L301" class="js-smell-location">2</a>                  <a href="signature_spec.html#L312" class="js-smell-location">3</a>                  <a href="signature_spec.html#L317" class="js-smell-location">4</a>                  </div>  </li></ol>
        s = FactoryBot.build(:signature, :postcode =&gt; &#39;SW1A1AA&#39;)
        expect(s).to have_valid(:postcode)
      end

      it &quot;recognises special postcodes&quot; do
        expect(FactoryBot.build(:signature, :postcode =&gt; &#39;BFPO 1234&#39;)).to have_valid(:postcode)
        expect(FactoryBot.build(:signature, :postcode =&gt; &#39;XM4 5HQ&#39;)).to have_valid(:postcode)
        expect(FactoryBot.build(:signature, :postcode =&gt; &#39;GIR 0AA&#39;)).to have_valid(:postcode)
      end

      it &quot;does not allow prefix of postcode only&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L259" class="js-smell-location">0</a>                  <a href="signature_spec.html#L264" class="js-smell-location">1</a>                  <a href="signature_spec.html#L301" class="js-smell-location">2</a>                  <a href="signature_spec.html#L312" class="js-smell-location">3</a>                  <a href="signature_spec.html#L317" class="js-smell-location">4</a>                  </div>  </li></ol>
        s = FactoryBot.build(:signature, :postcode =&gt; &#39;N1&#39;)
        expect(s).not_to have_valid(:postcode)
      end

      it &quot;does not allow unrecognised postcodes&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L259" class="js-smell-location">0</a>                  <a href="signature_spec.html#L264" class="js-smell-location">1</a>                  <a href="signature_spec.html#L301" class="js-smell-location">2</a>                  <a href="signature_spec.html#L312" class="js-smell-location">3</a>                  <a href="signature_spec.html#L317" class="js-smell-location">4</a>                  </div>  </li></ol>
        s = FactoryBot.build(:signature, :postcode =&gt; &#39;90210&#39;)
        expect(s).not_to have_valid(:postcode)
      end

      it &quot;does not allow postcodes longer than 255 characters for non-UK addresses&quot; do
        s = FactoryBot.build(:signature, :location_code =&gt; &quot;US&quot;, :postcode =&gt; &quot;1&quot; * 256)
        expect(s).not_to have_valid(:postcode)
      end
    end

    describe &quot;uk_citizenship&quot; do
      it &quot;requires acceptance of uk_citizenship for a new record&quot; do
        expect(FactoryBot.build(:signature, :uk_citizenship =&gt; &#39;1&#39;)).to be_valid
        expect(FactoryBot.build(:signature, :uk_citizenship =&gt; &#39;0&#39;)).not_to be_valid
        expect(FactoryBot.build(:signature, :uk_citizenship =&gt; nil)).not_to be_valid
      end

      it &quot;does not require acceptance of uk_citizenship for old records&quot; do
        sig = FactoryBot.create(:signature)
        sig.reload
        sig.uk_citizenship = &#39;0&#39;
        expect(sig).to be_valid
      end
    end
  end

  describe &quot;scopes&quot; do
    let(:week_ago) { 1.week.ago }
    let(:two_days_ago) { 2.days.ago }
    let!(:petition) { FactoryBot.create(:petition) }
    let!(:signature1) { FactoryBot.create(:signature, :email =&gt; &quot;person1@example.com&quot;, :petition =&gt; petition, :state =&gt; Signature::VALIDATED_STATE, :notify_by_email =&gt; true) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L348" class="js-smell-location">0</a>                  <a href="signature_spec.html#L349" class="js-smell-location">1</a>                  </div>  </li></ol>
    let!(:signature2) { FactoryBot.create(:signature, :email =&gt; &quot;person2@example.com&quot;, :petition =&gt; petition, :state =&gt; Signature::PENDING_STATE, :notify_by_email =&gt; true) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L348" class="js-smell-location">0</a>                  <a href="signature_spec.html#L349" class="js-smell-location">1</a>                  </div>  </li></ol>
    let!(:signature3) { FactoryBot.create(:signature, :email =&gt; &quot;person3@example.com&quot;, :petition =&gt; petition, :state =&gt; Signature::VALIDATED_STATE, :notify_by_email =&gt; false) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L350" class="js-smell-location">0</a>                  <a href="signature_spec.html#L351" class="js-smell-location">1</a>                  <a href="signature_spec.html#L352" class="js-smell-location">2</a>                  </div>  </li></ol>
    let!(:signature4) { FactoryBot.create(:signature, :email =&gt; &quot;person4@example.com&quot;, :petition =&gt; petition, :state =&gt; Signature::INVALIDATED_STATE, :notify_by_email =&gt; false) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L350" class="js-smell-location">0</a>                  <a href="signature_spec.html#L351" class="js-smell-location">1</a>                  <a href="signature_spec.html#L352" class="js-smell-location">2</a>                  </div>  </li></ol>
    let!(:signature5) { FactoryBot.create(:signature, :email =&gt; &quot;person4@example.com&quot;, :petition =&gt; petition, :state =&gt; Signature::FRAUDULENT_STATE, :notify_by_email =&gt; false) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L350" class="js-smell-location">0</a>                  <a href="signature_spec.html#L351" class="js-smell-location">1</a>                  <a href="signature_spec.html#L352" class="js-smell-location">2</a>                  </div>  </li></ol>

    describe &quot;validated&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L354" class="js-smell-location">0</a>                  <a href="signature_spec.html#L362" class="js-smell-location">1</a>                  </div>  </li></ol>
      it &quot;returns only validated signatures&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(scopes)::describe(validated)::it#returns only validated signatures has a flog score of 25</span>          </div>  </li></ol>
        signatures = Signature.validated
        expect(signatures.size).to eq(3)
        expect(signatures).to include(signature1, signature3, petition.creator)
      end
    end

    describe &quot;subscribed&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L354" class="js-smell-location">0</a>                  <a href="signature_spec.html#L362" class="js-smell-location">1</a>                  </div>  </li></ol>
      it &quot;returns only signatures with notify_by_email: true&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(scopes)::describe(subscribed)::it#returns only signatures with notify_by_email: true has a flog score of 25</span>          </div>  </li></ol>
        signatures = Signature.subscribed
        expect(signatures.size).to eq(3)
        expect(signatures).to include(signature1, signature2, petition.creator)
      end
    end

    describe &quot;pending&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L370" class="js-smell-location">0</a>                  <a href="signature_spec.html#L378" class="js-smell-location">1</a>                  <a href="signature_spec.html#L386" class="js-smell-location">2</a>                  </div>  </li></ol>
      it &quot;returns only pending signatures&quot; do
        signatures = Signature.pending
        expect(signatures.size).to eq(1)
        expect(signatures).to include(signature2)
      end
    end

    describe &quot;invalidated&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L370" class="js-smell-location">0</a>                  <a href="signature_spec.html#L378" class="js-smell-location">1</a>                  <a href="signature_spec.html#L386" class="js-smell-location">2</a>                  </div>  </li></ol>
      it &quot;returns only invalidated signatures&quot; do
        signatures = Signature.invalidated
        expect(signatures.size).to eq(1)
        expect(signatures).to include(signature4)
      end
    end

    describe &quot;fraudulent&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L370" class="js-smell-location">0</a>                  <a href="signature_spec.html#L378" class="js-smell-location">1</a>                  <a href="signature_spec.html#L386" class="js-smell-location">2</a>                  </div>  </li></ol>
      it &quot;returns only fraudulent signatures&quot; do
        signatures = Signature.fraudulent
        expect(signatures.size).to eq(1)
        expect(signatures).to include(signature5)
      end
    end

    describe &quot;for_invalidating&quot; do
      let(:petition) { FactoryBot.create(:open_petition) }

      subject do
        described_class.for_invalidating.to_a
      end

      it &quot;returns pending signatures&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L401" class="js-smell-location">0</a>                  <a href="signature_spec.html#L406" class="js-smell-location">1</a>                  <a href="signature_spec.html#L411" class="js-smell-location">2</a>                  <a href="signature_spec.html#L416" class="js-smell-location">3</a>                  </div>  </li></ol>
        signature = FactoryBot.create(:pending_signature, petition: petition)
        expect(subject).to include(signature)
      end

      it &quot;returns validated signatures&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L401" class="js-smell-location">0</a>                  <a href="signature_spec.html#L406" class="js-smell-location">1</a>                  <a href="signature_spec.html#L411" class="js-smell-location">2</a>                  <a href="signature_spec.html#L416" class="js-smell-location">3</a>                  </div>  </li></ol>
        signature = FactoryBot.create(:validated_signature, petition: petition)
        expect(subject).to include(signature)
      end

      it &quot;doesn&#39;t return fraudulent signatures&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L401" class="js-smell-location">0</a>                  <a href="signature_spec.html#L406" class="js-smell-location">1</a>                  <a href="signature_spec.html#L411" class="js-smell-location">2</a>                  <a href="signature_spec.html#L416" class="js-smell-location">3</a>                  </div>  </li></ol>
        signature = FactoryBot.create(:fraudulent_signature, petition: petition)
        expect(subject).not_to include(signature)
      end

      it &quot;doesn&#39;t return invalidated signatures&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L401" class="js-smell-location">0</a>                  <a href="signature_spec.html#L406" class="js-smell-location">1</a>                  <a href="signature_spec.html#L411" class="js-smell-location">2</a>                  <a href="signature_spec.html#L416" class="js-smell-location">3</a>                  </div>  </li></ol>
        signature = FactoryBot.create(:invalidated_signature, petition: petition)
        expect(subject).not_to include(signature)
      end
    end

    describe &quot;for_email&quot; do
      before do
        allow(Site).to receive(:disable_plus_address_check?).and_return(true)
      end

      let!(:other_petition) { FactoryBot.create(:petition) }
      let!(:other_signature) { FactoryBot.create(:pending_signature, email: &quot;person3@example.com&quot;, petition: other_petition) }
      let!(:dotted_signature) { FactoryBot.create(:signature, email: &quot;b.o.b@example.com&quot;, petition: other_petition) }
      let!(:plus_signature) { FactoryBot.create(:signature, email: &quot;alice+3@example.com&quot;, petition: other_petition) }

      it &quot;returns an empty set if the email is not found&quot; do
        expect(Signature.for_email(&quot;notfound@example.com&quot;)).to eq([])
      end

      it &quot;returns only signatures for the given email address&quot; do
        expect(Signature.for_email(&quot;person3@example.com&quot;)).to match_array([signature3, other_signature])
      end

      it &quot;searches case-insensitively&quot; do
        expect(Signature.for_email(&quot;Person3@example.com&quot;)).to match_array([signature3, other_signature])
      end

      it &quot;normalizes dots in the local part&quot; do
        expect(Signature.for_email(&quot;bob@example.com&quot;)).to match_array([dotted_signature])
      end

      it &quot;normalizes pluses in the local part&quot; do
        expect(Signature.for_email(&quot;alice@example.com&quot;)).to match_array([plus_signature])
      end
    end

    describe &quot;checking whether the signature is the creator&quot; do
      let!(:petition) { FactoryBot.create(:petition) }
      it &quot;is the creator if the signature is listed as the creator signature&quot; do
        expect(petition.creator).to be_creator
      end

      it &quot;is not the creator if the signature is not listed as the creator&quot; do
        signature = FactoryBot.create(:signature, :petition =&gt; petition)
        expect(signature).not_to be_creator
      end
    end
  end

  describe &quot;read-only attributes&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L109" class="js-smell-location">0</a>                  <a href="signature_spec.html#L466" class="js-smell-location">1</a>                  </div>  </li></ol>
    [
      [:sponsor, true, false],
      [:creator, true, false]
    ].each do |attribute, value, new_value|

      describe &quot;##{attribute}&quot; do
        let(:signature) { FactoryBot.create(:signature, attribute =&gt; value) }
        let(:exception) { ActiveRecord::ActiveRecordError }
        let(:message) { &quot;#{attribute} is marked as readonly&quot; }

        it &quot;can&#39;t be updated via update_column&quot; do
          expect {
            signature.update_column(attribute, new_value)
          }.to raise_error(exception, message)
        end

        it &quot;can&#39;t be updated via update&quot; do
          expect {
            signature.update(attribute =&gt; value)
          }.not_to change {
            signature.reload.send(attribute)
          }
        end

        it &quot;can&#39;t be updated via save&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(read-only attributes)::it#can't be updated via save has a flog score of 30</span>          </div>  </li></ol>
          expect {
            signature.send(:&quot;#{attribute}=&quot;, new_value)
            signature.save
          }.not_to change {
            signature.reload.send(attribute)
          }
        end
      end

    end
  end

  describe &quot;.search&quot; do
    let(:scope) { double(:scope) }

    context &quot;when searching with an ip address&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L507" class="js-smell-location">0</a>                  <a href="signature_spec.html#L523" class="js-smell-location">1</a>                  <a href="signature_spec.html#L539" class="js-smell-location">2</a>                  <a href="signature_spec.html#L555" class="js-smell-location">3</a>                  </div>  </li></ol>
      it &quot;calls the for_ip scope and paginates the result&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.search)::context(when searching with an ip address)::it#calls the for_ip scope and paginates the result has a flog score of 27</span>          </div>  </li></ol>
        expect(Signature).to receive(:for_ip).with(&quot;127.0.0.1&quot;).and_return(scope)
        expect(scope).to receive(:paginate).with(page: 1, per_page: 50)
        described_class.search(&quot;127.0.0.1&quot;)
      end

      context &quot;and passing the page parameter&quot; do
        it &quot;calls the for_ip scope and paginates the result&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.search)::context(when searching with an ip address)::context(and passing the page parameter)::it#calls the for_ip scope and paginates the result has a flog score of 27</span>          </div>  </li></ol>
          expect(Signature).to receive(:for_ip).with(&quot;127.0.0.1&quot;).and_return(scope)
          expect(scope).to receive(:paginate).with(page: 2, per_page: 50)
          described_class.search(&quot;127.0.0.1&quot;, page: &quot;2&quot;)
        end
      end
    end

    context &quot;when searching with a domain&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L507" class="js-smell-location">0</a>                  <a href="signature_spec.html#L523" class="js-smell-location">1</a>                  <a href="signature_spec.html#L539" class="js-smell-location">2</a>                  <a href="signature_spec.html#L555" class="js-smell-location">3</a>                  </div>  </li></ol>
      it &quot;calls the for_domain scope and paginates the result&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.search)::context(when searching with a domain)::it#calls the for_domain scope and paginates the result has a flog score of 27</span>          </div>  </li></ol>
        expect(Signature).to receive(:for_domain).with(&quot;@example.com&quot;).and_return(scope)
        expect(scope).to receive(:paginate).with(page: 1, per_page: 50)
        described_class.search(&quot;@example.com&quot;)
      end

      context &quot;and passing the page parameter&quot; do
        it &quot;calls the for_ip scope and paginates the result&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.search)::context(when searching with a domain)::context(and passing the page parameter)::it#calls the for_ip scope and paginates the result has a flog score of 27</span>          </div>  </li></ol>
          expect(Signature).to receive(:for_domain).with(&quot;@example.com&quot;).and_return(scope)
          expect(scope).to receive(:paginate).with(page: 2, per_page: 50)
          described_class.search(&quot;@example.com&quot;, page: &quot;2&quot;)
        end
      end
    end

    context &quot;when searching with an email address&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L507" class="js-smell-location">0</a>                  <a href="signature_spec.html#L523" class="js-smell-location">1</a>                  <a href="signature_spec.html#L539" class="js-smell-location">2</a>                  <a href="signature_spec.html#L555" class="js-smell-location">3</a>                  </div>  </li></ol>
      it &quot;calls the for_email scope and paginates the result&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.search)::context(when searching with an email address)::it#calls the for_email scope and paginates the result has a flog score of 27</span>          </div>  </li></ol>
        expect(Signature).to receive(:for_email).with(&quot;alice@example.com&quot;).and_return(scope)
        expect(scope).to receive(:paginate).with(page: 1, per_page: 50)
        described_class.search(&quot;alice@example.com&quot;)
      end

      context &quot;and passing the page parameter&quot; do
        it &quot;calls the for_email scope and paginates the result&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.search)::context(when searching with an email address)::context(and passing the page parameter)::it#calls the for_email scope and paginates the result has a flog score of 27</span>          </div>  </li></ol>
          expect(Signature).to receive(:for_email).with(&quot;alice@example.com&quot;).and_return(scope)
          expect(scope).to receive(:paginate).with(page: 2, per_page: 50)
          described_class.search(&quot;alice@example.com&quot;, page: &quot;2&quot;)
        end
      end
    end

    context &quot;when searching with a name&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L507" class="js-smell-location">0</a>                  <a href="signature_spec.html#L523" class="js-smell-location">1</a>                  <a href="signature_spec.html#L539" class="js-smell-location">2</a>                  <a href="signature_spec.html#L555" class="js-smell-location">3</a>                  </div>  </li></ol>
      it &quot;calls the for_name scope and paginates the result&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.search)::context(when searching with a name)::it#calls the for_name scope and paginates the result has a flog score of 27</span>          </div>  </li></ol>
        expect(Signature).to receive(:for_name).with(&quot;Alice&quot;).and_return(scope)
        expect(scope).to receive(:paginate).with(page: 1, per_page: 50)
        described_class.search(&quot;Alice&quot;)
      end

      context &quot;and passing the page parameter&quot; do
        it &quot;calls the for_name scope and paginates the result&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.search)::context(when searching with a name)::context(and passing the page parameter)::it#calls the for_name scope and paginates the result has a flog score of 27</span>          </div>  </li></ol>
          expect(Signature).to receive(:for_name).with(&quot;Alice&quot;).and_return(scope)
          expect(scope).to receive(:paginate).with(page: 2, per_page: 50)
          described_class.search(&quot;Alice&quot;, page: &quot;2&quot;)
        end
      end
    end
  end

  describe &quot;.validate!&quot; do
    let(:attributes) { FactoryBot.attributes_for(:petition) }
    let(:creator) { FactoryBot.create(:pending_signature, creator: true) }
    let(:petition) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 7 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L89" class="js-smell-location">0</a>                  <a href="signature_spec.html#L575" class="js-smell-location">1</a>                  <a href="signature_spec.html#L698" class="js-smell-location">2</a>                  <a href="signature_spec.html#L826" class="js-smell-location">3</a>                  <a href="signature_spec.html#L893" class="js-smell-location">4</a>                  <a href="signature_spec.html#L1191" class="js-smell-location">5</a>                  <a href="signature_spec.html#L1203" class="js-smell-location">6</a>                  </div>  </li></ol>
      Petition.create(attributes) do |petition|
        petition.creator = creator

        5.times do
          petition.signatures &lt;&lt; FactoryBot.create(:pending_signature)
        end
      end
    end

    before do
      petition.signatures.each { |s| s.validate! }
      petition.publish
    end

    context &quot;when passed a signature id that doesn&#39;t exist&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 8 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L300" class="js-smell-location">0</a>                  <a href="archived/signature_spec.html#L370" class="js-smell-location">1</a>                  <a href="archived/signature_spec.html#L433" class="js-smell-location">2</a>                  <a href="signature_spec.html#L590" class="js-smell-location">3</a>                  <a href="signature_spec.html#L713" class="js-smell-location">4</a>                  <a href="signature_spec.html#L762" class="js-smell-location">5</a>                  <a href="signature_spec.html#L841" class="js-smell-location">6</a>                  <a href="signature_spec.html#L908" class="js-smell-location">7</a>                  </div>  </li></ol>
      let(:signature_ids) { [petition.signatures.maximum(:id) + 1] }

      it &quot;raises an ActiveRecord::RecordNotFound error&quot; do
        expect {
          described_class.invalidate!(signature_ids)
        }.to raise_error(ActiveRecord::RecordNotFound)
      end
    end

    context &quot;with a pending signature&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.validate!)::context#with a pending signature has a flog score of 41</span>          </div>  </li></ol>
      let(:signature) { FactoryBot.create(:pending_signature, petition: petition) }

      before do
        allow(described_class).to receive(:find).and_call_original
        allow(described_class).to receive(:find).with([signature.id]).and_return([signature])
        expect(signature).to receive(:validate!).and_call_original
      end

      it &quot;transitions the signature to the validated state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L407" class="js-smell-location">0</a>                  <a href="signature_spec.html#L609" class="js-smell-location">1</a>                  <a href="signature_spec.html#L734" class="js-smell-location">2</a>                  <a href="signature_spec.html#L880" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.validate!)::context(with a pending signature)::it#transitions the signature to the validated state has a flog score of 26</span>          </div>  </li></ol>
        expect {
          described_class.validate!([signature.id])
        }.to change {
          signature.reload.validated?
        }.from(false).to(true)
      end
    end

    describe &quot;using the default :force option&quot; do
      context &quot;with a fraudulent signature&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L619" class="js-smell-location">0</a>                  <a href="signature_spec.html#L637" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.validate!)::describe(using the default :force option)::context#with a fraudulent signature has a flog score of 43</span>          </div>  </li></ol>
        let(:signature) { FactoryBot.create(:fraudulent_signature, petition: petition) }

        before do
          allow(described_class).to receive(:find).and_call_original
          allow(described_class).to receive(:find).with([signature.id]).and_return([signature])
          expect(signature).to receive(:validate!).and_call_original
        end

        it &quot;doesn&#39;t transition the signature to the validated state&quot; do
          expect {
            described_class.validate!([signature.id])
          }.not_to change {
            signature.reload.validated?
          }.from(false)
        end
      end

      context &quot;with an invalidated signature&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L619" class="js-smell-location">0</a>                  <a href="signature_spec.html#L637" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.validate!)::describe(using the default :force option)::context#with an invalidated signature has a flog score of 43</span>          </div>  </li></ol>
        let(:signature) { FactoryBot.create(:invalidated_signature, petition: petition) }

        before do
          allow(described_class).to receive(:find).and_call_original
          allow(described_class).to receive(:find).with([signature.id]).and_return([signature])
          expect(signature).to receive(:validate!).and_call_original
        end

        it &quot;transitions the signature to the validated state&quot; do
          expect {
            described_class.validate!([signature.id])
          }.not_to change {
            signature.reload.validated?
          }.from(false)
        end
      end
    end

    describe &quot;using the force: true option&quot; do
      context &quot;with a fraudulent signature&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L657" class="js-smell-location">0</a>                  <a href="signature_spec.html#L675" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.validate!)::describe(using the force: true option)::context#with a fraudulent signature has a flog score of 43</span>          </div>  </li></ol>
        let(:signature) { FactoryBot.create(:fraudulent_signature, petition: petition) }

        before do
          allow(described_class).to receive(:find).and_call_original
          allow(described_class).to receive(:find).with([signature.id]).and_return([signature])
          expect(signature).to receive(:validate!).and_call_original
        end

        it &quot;transitions the signature to the validated state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.validate!)::describe(using the force: true option)::context(with a fraudulent signature)::it#transitions the signature to the validated state has a flog score of 27</span>          </div>  </li></ol>
          expect {
            described_class.validate!([signature.id], force: true)
          }.to change {
            signature.reload.validated?
          }.from(false).to(true)
        end
      end

      context &quot;with an invalidated signature&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L657" class="js-smell-location">0</a>                  <a href="signature_spec.html#L675" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.validate!)::describe(using the force: true option)::context#with an invalidated signature has a flog score of 43</span>          </div>  </li></ol>
        let(:signature) { FactoryBot.create(:invalidated_signature, petition: petition) }

        before do
          allow(described_class).to receive(:find).and_call_original
          allow(described_class).to receive(:find).with([signature.id]).and_return([signature])
          expect(signature).to receive(:validate!).and_call_original
        end

        it &quot;transitions the signature to the validated state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.validate!)::describe(using the force: true option)::context(with an invalidated signature)::it#transitions the signature to the validated state has a flog score of 27</span>          </div>  </li></ol>
          expect {
            described_class.validate!([signature.id], force: true)
          }.to change {
            signature.reload.validated?
          }.from(false).to(true)
        end
      end
    end
  end

  describe &quot;.invalidate!&quot; do
    let(:attributes) { FactoryBot.attributes_for(:petition) }
    let(:creator) { FactoryBot.create(:pending_signature, creator: true) }
    let(:petition) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 7 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L89" class="js-smell-location">0</a>                  <a href="signature_spec.html#L575" class="js-smell-location">1</a>                  <a href="signature_spec.html#L698" class="js-smell-location">2</a>                  <a href="signature_spec.html#L826" class="js-smell-location">3</a>                  <a href="signature_spec.html#L893" class="js-smell-location">4</a>                  <a href="signature_spec.html#L1191" class="js-smell-location">5</a>                  <a href="signature_spec.html#L1203" class="js-smell-location">6</a>                  </div>  </li></ol>
      Petition.create(attributes) do |petition|
        petition.creator = creator

        5.times do
          petition.signatures &lt;&lt; FactoryBot.create(:pending_signature)
        end
      end
    end

    before do
      petition.signatures.each { |s| s.validate! }
      petition.publish
    end

    context &quot;when passed a signature id that doesn&#39;t exist&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 8 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L300" class="js-smell-location">0</a>                  <a href="archived/signature_spec.html#L370" class="js-smell-location">1</a>                  <a href="archived/signature_spec.html#L433" class="js-smell-location">2</a>                  <a href="signature_spec.html#L590" class="js-smell-location">3</a>                  <a href="signature_spec.html#L713" class="js-smell-location">4</a>                  <a href="signature_spec.html#L762" class="js-smell-location">5</a>                  <a href="signature_spec.html#L841" class="js-smell-location">6</a>                  <a href="signature_spec.html#L908" class="js-smell-location">7</a>                  </div>  </li></ol>
      let(:signature_ids) { [petition.signatures.maximum(:id) + 1] }

      it &quot;raises an ActiveRecord::RecordNotFound error&quot; do
        expect {
          described_class.invalidate!(signature_ids)
        }.to raise_error(ActiveRecord::RecordNotFound)
      end
    end

    context &quot;with a validated signature&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.invalidate!)::context#with a validated signature has a flog score of 45</span>          </div>  </li></ol>
      let(:signature) { FactoryBot.create(:pending_signature, petition: petition) }

      before do
        signature.validate!

        allow(described_class).to receive(:find).and_call_original
        allow(described_class).to receive(:find).with([signature.id]).and_return([signature])
        expect(signature).to receive(:invalidate!).and_call_original
      end

      it &quot;transitions the signature to the invalidated state&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L407" class="js-smell-location">0</a>                  <a href="signature_spec.html#L609" class="js-smell-location">1</a>                  <a href="signature_spec.html#L734" class="js-smell-location">2</a>                  <a href="signature_spec.html#L880" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.invalidate!)::context(with a validated signature)::it#transitions the signature to the invalidated state has a flog score of 26</span>          </div>  </li></ol>
        expect {
          described_class.invalidate!([signature.id])
        }.to change {
          signature.reload.invalidated?
        }.from(false).to(true)
      end
    end
  end

  describe &quot;.subscribe!&quot; do
    let(:attributes) { FactoryBot.attributes_for(:petition) }
    let(:creator) { FactoryBot.create(:pending_signature, creator: true) }
    let(:petition) do
      Petition.create(attributes) do |petition|
        petition.creator = creator

        5.times do
          petition.signatures &lt;&lt; FactoryBot.create(:pending_signature, notify_by_email: false)
        end
      end
    end

    before do
      petition.signatures.each { |s| s.validate! }
      petition.publish
    end

    context &quot;when passed a signature id that doesn&#39;t exist&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 8 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L300" class="js-smell-location">0</a>                  <a href="archived/signature_spec.html#L370" class="js-smell-location">1</a>                  <a href="archived/signature_spec.html#L433" class="js-smell-location">2</a>                  <a href="signature_spec.html#L590" class="js-smell-location">3</a>                  <a href="signature_spec.html#L713" class="js-smell-location">4</a>                  <a href="signature_spec.html#L762" class="js-smell-location">5</a>                  <a href="signature_spec.html#L841" class="js-smell-location">6</a>                  <a href="signature_spec.html#L908" class="js-smell-location">7</a>                  </div>  </li></ol>
      let(:signature_ids) { [petition.signatures.maximum(:id) + 1] }

      it &quot;raises an ActiveRecord::RecordNotFound error&quot; do
        expect {
          described_class.subscribe!(signature_ids)
        }.to raise_error(ActiveRecord::RecordNotFound)
      end
    end

    context &quot;when trying to subscribe the creator&quot; do
      it &quot;doesn&#39;t raise an error&quot; do
        expect {
          described_class.subscribe!([creator.id])
        }.not_to raise_error
      end
    end

    context &quot;with a pending signature&quot; do
      let(:signature) { FactoryBot.create(:pending_signature, petition: petition) }

      it &quot;doesn&#39;t raise an error&quot; do
        expect {
          described_class.subscribe!([signature.id])
        }.not_to raise_error
      end
    end

    context &quot;with a pending signature that isn&#39;t subscribed&quot; do
      let(:signature) { FactoryBot.create(:pending_signature, petition: petition, notify_by_email: false) }

      it &quot;subscribes the signature&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 4 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L331" class="js-smell-location">0</a>                  <a href="archived/signature_spec.html#L349" class="js-smell-location">1</a>                  <a href="signature_spec.html#L793" class="js-smell-location">2</a>                  <a href="signature_spec.html#L813" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.subscribe!)::context(with a pending signature that isn't subscribed)::it#subscribes the signature has a flog score of 26</span>          </div>  </li></ol>
        expect {
          described_class.subscribe!([signature.id])
        }.to change {
          signature.reload.unsubscribed?
        }.from(true).to(false)
      end
    end

    context &quot;with a validated signature&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.subscribe!)::context#with a validated signature has a flog score of 47</span>          </div>  </li></ol>
      let(:signature) { FactoryBot.create(:pending_signature, petition: petition, notify_by_email: false) }

      before do
        signature.validate!

        allow(described_class).to receive(:find).and_call_original
        allow(described_class).to receive(:find).with([signature.id]).and_return([signature])
        expect(signature).to receive(:update!).with(notify_by_email: true).and_call_original
      end

      it &quot;subscribes the signature&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 4 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L331" class="js-smell-location">0</a>                  <a href="archived/signature_spec.html#L349" class="js-smell-location">1</a>                  <a href="signature_spec.html#L793" class="js-smell-location">2</a>                  <a href="signature_spec.html#L813" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.subscribe!)::context(with a validated signature)::it#subscribes the signature has a flog score of 26</span>          </div>  </li></ol>
        expect {
          described_class.subscribe!([signature.id])
        }.to change {
          signature.reload.unsubscribed?
        }.from(true).to(false)
      end
    end
  end

  describe &quot;.unsubscribe!&quot; do
    let(:attributes) { FactoryBot.attributes_for(:petition) }
    let(:creator) { FactoryBot.create(:pending_signature, creator: true) }
    let(:petition) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 7 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L89" class="js-smell-location">0</a>                  <a href="signature_spec.html#L575" class="js-smell-location">1</a>                  <a href="signature_spec.html#L698" class="js-smell-location">2</a>                  <a href="signature_spec.html#L826" class="js-smell-location">3</a>                  <a href="signature_spec.html#L893" class="js-smell-location">4</a>                  <a href="signature_spec.html#L1191" class="js-smell-location">5</a>                  <a href="signature_spec.html#L1203" class="js-smell-location">6</a>                  </div>  </li></ol>
      Petition.create(attributes) do |petition|
        petition.creator = creator

        5.times do
          petition.signatures &lt;&lt; FactoryBot.create(:pending_signature)
        end
      end
    end

    before do
      petition.signatures.each { |s| s.validate! }
      petition.publish
    end

    context &quot;when passed a signature id that doesn&#39;t exist&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 8 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L300" class="js-smell-location">0</a>                  <a href="archived/signature_spec.html#L370" class="js-smell-location">1</a>                  <a href="archived/signature_spec.html#L433" class="js-smell-location">2</a>                  <a href="signature_spec.html#L590" class="js-smell-location">3</a>                  <a href="signature_spec.html#L713" class="js-smell-location">4</a>                  <a href="signature_spec.html#L762" class="js-smell-location">5</a>                  <a href="signature_spec.html#L841" class="js-smell-location">6</a>                  <a href="signature_spec.html#L908" class="js-smell-location">7</a>                  </div>  </li></ol>
      let(:signature_ids) { [petition.signatures.maximum(:id) + 1] }

      it &quot;raises an ActiveRecord::RecordNotFound error&quot; do
        expect {
          described_class.unsubscribe!(signature_ids)
        }.to raise_error(ActiveRecord::RecordNotFound)
      end
    end

    context &quot;when trying to unsubscribe the creator&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L380" class="js-smell-location">0</a>                  <a href="signature_spec.html#L851" class="js-smell-location">1</a>                  </div>  </li></ol>
      it &quot;raises an error&quot; do
        expect {
          described_class.unsubscribe!([creator.id])
        }.to raise_error(RuntimeError, &quot;Can&#39;t unsubscribe the creator signature&quot;)
      end
    end

    context &quot;with a pending signature&quot; do
      let(:signature) { FactoryBot.create(:pending_signature, petition: petition) }

      it &quot;raises an error&quot; do
        expect {
          described_class.unsubscribe!([signature.id])
        }.to raise_error(RuntimeError, &quot;Can&#39;t unsubscribe a pending signature&quot;)
      end
    end

    context &quot;with a validated signature&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.unsubscribe!)::context#with a validated signature has a flog score of 47</span>          </div>  </li></ol>
      let(:signature) { FactoryBot.create(:pending_signature, petition: petition) }

      before do
        signature.validate!

        allow(described_class).to receive(:find).and_call_original
        allow(described_class).to receive(:find).with([signature.id]).and_return([signature])
        expect(signature).to receive(:update!).with(notify_by_email: false).and_call_original
      end

      it &quot;unsubscribes the signature&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L407" class="js-smell-location">0</a>                  <a href="signature_spec.html#L609" class="js-smell-location">1</a>                  <a href="signature_spec.html#L734" class="js-smell-location">2</a>                  <a href="signature_spec.html#L880" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.unsubscribe!)::context(with a validated signature)::it#unsubscribes the signature has a flog score of 26</span>          </div>  </li></ol>
        expect {
          described_class.unsubscribe!([signature.id])
        }.to change {
          signature.reload.unsubscribed?
        }.from(false).to(true)
      end
    end
  end

  describe &quot;.destroy!&quot; do
    let(:attributes) { FactoryBot.attributes_for(:petition) }
    let(:creator) { FactoryBot.create(:pending_signature, creator: true) }
    let(:petition) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 7 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L89" class="js-smell-location">0</a>                  <a href="signature_spec.html#L575" class="js-smell-location">1</a>                  <a href="signature_spec.html#L698" class="js-smell-location">2</a>                  <a href="signature_spec.html#L826" class="js-smell-location">3</a>                  <a href="signature_spec.html#L893" class="js-smell-location">4</a>                  <a href="signature_spec.html#L1191" class="js-smell-location">5</a>                  <a href="signature_spec.html#L1203" class="js-smell-location">6</a>                  </div>  </li></ol>
      Petition.create(attributes) do |petition|
        petition.creator = creator

        5.times do
          petition.signatures &lt;&lt; FactoryBot.create(:pending_signature)
        end
      end
    end

    before do
      petition.signatures.each { |s| s.validate! }
      petition.publish
    end

    context &quot;when passed a signature id that doesn&#39;t exist&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 8 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L300" class="js-smell-location">0</a>                  <a href="archived/signature_spec.html#L370" class="js-smell-location">1</a>                  <a href="archived/signature_spec.html#L433" class="js-smell-location">2</a>                  <a href="signature_spec.html#L590" class="js-smell-location">3</a>                  <a href="signature_spec.html#L713" class="js-smell-location">4</a>                  <a href="signature_spec.html#L762" class="js-smell-location">5</a>                  <a href="signature_spec.html#L841" class="js-smell-location">6</a>                  <a href="signature_spec.html#L908" class="js-smell-location">7</a>                  </div>  </li></ol>
      let(:signature_ids) { [petition.signatures.maximum(:id) + 1] }

      it &quot;raises an ActiveRecord::RecordNotFound error&quot; do
        expect {
          described_class.destroy!(signature_ids)
        }.to raise_error(ActiveRecord::RecordNotFound)
      end
    end

    context &quot;when trying to delete the creator&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L443" class="js-smell-location">0</a>                  <a href="signature_spec.html#L918" class="js-smell-location">1</a>                  </div>  </li></ol>
      let(:signature_ids) { [creator.id] }

      it &quot;raises an ActiveRecord::RecordNotDestroyed error&quot; do
        expect {
          described_class.destroy!(signature_ids)
        }.to raise_error(ActiveRecord::RecordNotDestroyed)
      end
    end

    context &quot;when the signature is not the creator&quot; do
      let(:country_journal) { CountryPetitionJournal.for(petition, &quot;GB&quot;) }
      let(:constituency_journal) { ConstituencyPetitionJournal.for(petition, &quot;3415&quot;) }

      let(:signature) {
        FactoryBot.create(
          :pending_signature,
          petition: petition,
          constituency_id: &quot;3415&quot;,
          location_code: &quot;GB&quot;
        )
      }

      before do
        signature.validate!
        petition.reload
      end

      it &quot;decrements the petition signature count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.destroy!)::context(when the signature is not the creator)::it#decrements the petition signature count has a flog score of 27</span>          </div>  </li></ol>
        expect {
          described_class.destroy!([signature.id])
        }.to change {
          petition.reload.signature_count
        }.from(7).to(6)
      end

      it &quot;decrements the country journal signature count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L954" class="js-smell-location">0</a>                  <a href="signature_spec.html#L962" class="js-smell-location">1</a>                  </div>  </li></ol>
        expect {
          described_class.destroy!([signature.id])
        }.to change {
          country_journal.reload.signature_count
        }.by(-1)
      end

      it &quot;decrements the constituency journal signature count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L954" class="js-smell-location">0</a>                  <a href="signature_spec.html#L962" class="js-smell-location">1</a>                  </div>  </li></ol>
        expect {
          described_class.destroy!([signature.id])
        }.to change {
          constituency_journal.reload.signature_count
        }.by(-1)
      end
    end

    context &quot;when one signature fails&quot; do
      let(:signatures) { [petition.signatures.last, creator] }
      let(:signature_ids) { signatures.map(&amp;:id) }

      before do
        allow(described_class).to receive(:find).with(signature_ids).and_return(signatures)
      end

      it &quot;raises an ActiveRecord::RecordNotDestroyed error&quot; do
        expect {
          described_class.destroy!(signature_ids)
        }.to raise_error(ActiveRecord::RecordNotDestroyed)
      end

      it &quot;doesn&#39;t destroy any signatures&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L485" class="js-smell-location">0</a>                  <a href="signature_spec.html#L985" class="js-smell-location">1</a>                  </div>  </li></ol>
        expect {
          begin
            described_class.destroy!(signature_ids)
          rescue ActiveRecord::RecordNotDestroyed =&gt; e
            0
          end
        }.not_to change {
          petition.reload.signatures.count
        }
      end
    end
  end

  describe &quot;.missing_constituency_id&quot; do
    let!(:signature_1) { FactoryBot.create(:validated_signature, validated_at: 2.weeks.ago) }
    let!(:signature_2) { FactoryBot.create(:validated_signature, constituency_id: &quot;3415&quot;) }
    let!(:signature_3) { FactoryBot.create(:validated_signature, location_code: &quot;US&quot;) }
    let!(:signature_4) { FactoryBot.create(:validated_signature) }

    subject { described_class.missing_constituency_id(since: 1.week.ago) }

    it &quot;doesn&#39;t include signatures from before the cut-off date&quot; do
      expect(subject).not_to include(signature_1)
    end

    it &quot;doesn&#39;t include signatures that have a constituency_id&quot; do
      expect(subject).not_to include(signature_2)
    end

    it &quot;doesn&#39;t include signatures that are not in the UK&quot; do
      expect(subject).not_to include(signature_3)
    end

    it &quot;includes signatures that need their constituency_id set&quot; do
      expect(subject).to include(signature_4)
    end

    context &quot;when not supplying the cut-off date&quot; do
      subject { described_class.missing_constituency_id }

      it &quot;includes all signatures that need their constituency_id set&quot; do
        expect(subject).to include(signature_1)
      end
    end
  end

  describe &quot;.fraudulent_domains&quot; do
    subject do
      described_class.fraudulent_domains
    end

    before do
      FactoryBot.create(:fraudulent_signature, email: &quot;alice@foo.com&quot;)
      FactoryBot.create(:fraudulent_signature, email: &quot;bob@bar.com&quot;)
      FactoryBot.create(:fraudulent_signature, email: &quot;charlie@foo.com&quot;)
    end

    it &quot;returns a hash of domains and counts in descending order&quot; do
      expect(subject).to be_an_instance_of(Hash)
      expect(subject.to_a).to eq([[&quot;foo.com&quot;, 2], [&quot;bar.com&quot;, 1]])
    end
  end

  describe &quot;.trending_domains&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1049" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1098" class="js-smell-location">1</a>                  </div>  </li></ol>
    before do
      FactoryBot.create(:validated_signature, email: &quot;alice@foo.com&quot;, validated_at: 30.minutes.ago)
      FactoryBot.create(:validated_signature, email: &quot;bob@bar.com&quot;, validated_at: 30.minutes.ago)
      FactoryBot.create(:validated_signature, email: &quot;charlie@foo.com&quot;, validated_at: 30.minutes.ago)
    end

    it &quot;returns a hash of domains and counts in descending order&quot; do
      domains = described_class.trending_domains

      expect(domains).to be_an_instance_of(Hash)
      expect(domains.to_a).to eq([[&quot;foo.com&quot;, 2], [&quot;bar.com&quot;, 1]])
    end

    it &quot;ignores pending signatures&quot; do
      FactoryBot.create(:pending_signature, email: &quot;derek@foo.com&quot;, created_at: 30.minutes.ago)
      domains = described_class.trending_domains

      expect(domains.to_a).to eq([[&quot;foo.com&quot;, 2], [&quot;bar.com&quot;, 1]])
    end

    it &quot;ignores invalidated signatures&quot; do
      FactoryBot.create(:invalidated_signature, email: &quot;derek@foo.com&quot;, validated_at: 30.minutes.ago, invalidated_at: 10.minutes.ago)
      domains = described_class.trending_domains

      expect(domains.to_a).to eq([[&quot;foo.com&quot;, 2], [&quot;bar.com&quot;, 1]])
    end

    it &quot;ignores fraudulent signatures&quot; do
      FactoryBot.create(:fraudulent_signature, email: &quot;derek@foo.com&quot;, created_at: 30.minutes.ago)
      domains = described_class.trending_domains

      expect(domains.to_a).to eq([[&quot;foo.com&quot;, 2], [&quot;bar.com&quot;, 1]])
    end

    it &quot;can override the timespan&quot; do
      FactoryBot.create(:validated_signature, email: &quot;derek@foo.com&quot;, validated_at: 5.minutes.ago)
      domains = described_class.trending_domains(since: 10.minutes.ago)

      expect(domains.to_a).to eq([[&quot;foo.com&quot;, 1]])
    end

    it &quot;can override the number returned&quot; do
      domains = described_class.trending_domains(limit: 1)

      expect(domains.to_a).to eq([[&quot;foo.com&quot;, 2]])
    end
  end

  describe &quot;.trending_ips&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1049" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1098" class="js-smell-location">1</a>                  </div>  </li></ol>
    before do
      FactoryBot.create(:validated_signature, ip_address: &quot;10.0.1.1&quot;, validated_at: 30.minutes.ago)
      FactoryBot.create(:validated_signature, ip_address: &quot;192.168.1.1&quot;, validated_at: 30.minutes.ago)
      FactoryBot.create(:validated_signature, ip_address: &quot;10.0.1.1&quot;, validated_at: 30.minutes.ago)
    end

    it &quot;returns a hash of domains and counts in descending order&quot; do
      domains = described_class.trending_ips

      expect(domains).to be_an_instance_of(Hash)
      expect(domains.to_a).to eq([[&quot;10.0.1.1&quot;, 2], [&quot;192.168.1.1&quot;, 1]])
    end

    it &quot;ignores pending signatures&quot; do
      FactoryBot.create(:pending_signature, ip_address: &quot;10.0.1.1&quot;, created_at: 30.minutes.ago)
      domains = described_class.trending_ips

      expect(domains.to_a).to eq([[&quot;10.0.1.1&quot;, 2], [&quot;192.168.1.1&quot;, 1]])
    end

    it &quot;ignores invalidated signatures&quot; do
      FactoryBot.create(:invalidated_signature, ip_address: &quot;10.0.1.1&quot;, validated_at: 30.minutes.ago, invalidated_at: 10.minutes.ago)
      domains = described_class.trending_ips

      expect(domains.to_a).to eq([[&quot;10.0.1.1&quot;, 2], [&quot;192.168.1.1&quot;, 1]])
    end

    it &quot;ignores fraudulent signatures&quot; do
      FactoryBot.create(:fraudulent_signature, ip_address: &quot;10.0.1.1&quot;, created_at: 30.minutes.ago)
      domains = described_class.trending_ips

      expect(domains.to_a).to eq([[&quot;10.0.1.1&quot;, 2], [&quot;192.168.1.1&quot;, 1]])
    end

    it &quot;can override the timespan&quot; do
      FactoryBot.create(:validated_signature, ip_address: &quot;10.0.1.1&quot;, validated_at: 5.minutes.ago)
      domains = described_class.trending_ips(since: 10.minutes.ago)

      expect(domains.to_a).to eq([[&quot;10.0.1.1&quot;, 1]])
    end

    it &quot;can override the number returned&quot; do
      domains = described_class.trending_ips(limit: 1)

      expect(domains.to_a).to eq([[&quot;10.0.1.1&quot;, 2]])
    end
  end

  describe &quot;.duplicate_emails&quot; do
    let!(:petition) { FactoryBot.create(:open_petition) }

    context &quot;when there are no duplicate emails&quot; do
      it &quot;returns zero&quot; do
        expect(petition.signatures.duplicate_emails).to eq(0)
      end
    end

    context &quot;when there are duplicate emails&quot; do
      before do
        FactoryBot.create(:validated_signature, petition: petition, name: &quot;Alice&quot;, email: &quot;aliceandbob@example.com&quot;)
        FactoryBot.create(:validated_signature, petition: petition, name: &quot;Bob&quot;, email: &quot;aliceandbob@example.com&quot;)
      end

      it &quot;returns the number of duplicate emails&quot; do
        expect(petition.signatures.duplicate_emails).to eq(1)
      end
    end
  end

  describe &quot;.pending_rate&quot; do
    let!(:petition) { FactoryBot.create(:open_petition) }

    context &quot;when there are no pending signatures&quot; do
      it &quot;returns zero&quot; do
        expect(petition.signatures.pending_rate).to eq(0)
      end
    end

    context &quot;when there are pending signatures&quot; do
      before do
        FactoryBot.create(:pending_signature, petition: petition)
      end

      it &quot;returns the number of duplicate emails&quot; do
        expect(petition.signatures.pending_rate).to eq(50)
      end
    end
  end

  describe &quot;#number&quot; do
    let(:attributes) { FactoryBot.attributes_for(:petition) }
    let(:creator) { FactoryBot.create(:pending_signature, creator: true) }
    let(:petition) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 7 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L89" class="js-smell-location">0</a>                  <a href="signature_spec.html#L575" class="js-smell-location">1</a>                  <a href="signature_spec.html#L698" class="js-smell-location">2</a>                  <a href="signature_spec.html#L826" class="js-smell-location">3</a>                  <a href="signature_spec.html#L893" class="js-smell-location">4</a>                  <a href="signature_spec.html#L1191" class="js-smell-location">5</a>                  <a href="signature_spec.html#L1203" class="js-smell-location">6</a>                  </div>  </li></ol>
      Petition.create(attributes) do |petition|
        petition.creator = creator

        5.times do
          petition.signatures &lt;&lt; FactoryBot.create(:pending_signature)
        end
      end
    end

    let(:other_attributes) { FactoryBot.attributes_for(:petition) }
    let(:other_creator) { FactoryBot.create(:pending_signature, creator: true) }
    let(:other_petition) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 7 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L89" class="js-smell-location">0</a>                  <a href="signature_spec.html#L575" class="js-smell-location">1</a>                  <a href="signature_spec.html#L698" class="js-smell-location">2</a>                  <a href="signature_spec.html#L826" class="js-smell-location">3</a>                  <a href="signature_spec.html#L893" class="js-smell-location">4</a>                  <a href="signature_spec.html#L1191" class="js-smell-location">5</a>                  <a href="signature_spec.html#L1203" class="js-smell-location">6</a>                  </div>  </li></ol>
      Petition.create(other_attributes) do |petition|
        petition.creator = other_creator

        5.times do
          petition.signatures &lt;&lt; FactoryBot.create(:pending_signature)
        end
      end
    end

    before do
      petition.signatures.each { |s| s.validate! }
      petition.publish

      other_petition.signatures.each { |s| s.validate! }
      other_petition.publish
    end

    it &quot;returns the signature number&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#number)::it#returns the signature number has a flog score of 25</span>          </div>  </li></ol>
      signature = FactoryBot.create(:pending_signature, petition: petition)
      signature.validate!

      expect(signature.petition.reload.signature_count).to eq(7)
      expect(signature.number).to eq(7)
    end

    it &quot;is scoped to the petition&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#number)::it#is scoped to the petition has a flog score of 49</span>          </div>  </li></ol>
      other_signature = FactoryBot.create(:pending_signature, petition: other_petition)
      other_signature.validate!

      signature = FactoryBot.create(:pending_signature, petition: petition)
      signature.validate!

      expect(other_signature.petition.reload.signature_count).to eq(7)
      expect(other_signature.number).to eq(7)

      expect(signature.petition.reload.signature_count).to eq(7)
      expect(signature.number).to eq(7)
    end

    it &quot;remains the same after another signature is added&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1243" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1251" class="js-smell-location">1</a>                  </div>  </li></ol>
      signature = FactoryBot.create(:pending_signature, petition: petition)
      later_signature = FactoryBot.create(:pending_signature, petition: petition)
      signature.validate!

      expect { later_signature.validate! }.not_to change{ signature.number }
    end

    it &quot;remains the same even if an earlier signature is validated&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1243" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1251" class="js-smell-location">1</a>                  </div>  </li></ol>
      earlier_signature = FactoryBot.create(:pending_signature, petition: petition)
      signature = FactoryBot.create(:pending_signature, petition: petition)
      signature.validate!

      expect { earlier_signature.validate! }.not_to change{ signature.number }
    end
  end

  describe &quot;#pending?&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1260" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1274" class="js-smell-location">1</a>                  <a href="signature_spec.html#L1288" class="js-smell-location">2</a>                  <a href="signature_spec.html#L1302" class="js-smell-location">3</a>                  </div>  </li></ol>
    it &quot;returns true if the signature has a pending state&quot; do
      signature = FactoryBot.build(:pending_signature)
      expect(signature.pending?).to be_truthy
    end

    (Signature::STATES - [Signature::PENDING_STATE]).each do |state|
      it &quot;returns false if the signature is #{state} state&quot; do
        signature = FactoryBot.build(:&quot;#{state}_signature&quot;)
        expect(signature.pending?).to be_falsey
      end
    end
  end

  describe &quot;#fraudulent?&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1260" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1274" class="js-smell-location">1</a>                  <a href="signature_spec.html#L1288" class="js-smell-location">2</a>                  <a href="signature_spec.html#L1302" class="js-smell-location">3</a>                  </div>  </li></ol>
    it &quot;returns true if the signature has a fraudulent state&quot; do
      signature = FactoryBot.build(:fraudulent_signature)
      expect(signature.fraudulent?).to be_truthy
    end

    (Signature::STATES - [Signature::FRAUDULENT_STATE]).each do |state|
      it &quot;returns false if the signature is #{state} state&quot; do
        signature = FactoryBot.build(:&quot;#{state}_signature&quot;)
        expect(signature.fraudulent?).to be_falsey
      end
    end
  end

  describe &quot;#validated?&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1260" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1274" class="js-smell-location">1</a>                  <a href="signature_spec.html#L1288" class="js-smell-location">2</a>                  <a href="signature_spec.html#L1302" class="js-smell-location">3</a>                  </div>  </li></ol>
    it &quot;returns true if the signature has a validated state&quot; do
      signature = FactoryBot.build(:validated_signature)
      expect(signature.validated?).to be_truthy
    end

    (Signature::STATES - [Signature::VALIDATED_STATE]).each do |state|
      it &quot;returns false if the signature is #{state} state&quot; do
        signature = FactoryBot.build(:&quot;#{state}_signature&quot;)
        expect(signature.validated?).to be_falsey
      end
    end
  end

  describe &quot;#invalidated?&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1260" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1274" class="js-smell-location">1</a>                  <a href="signature_spec.html#L1288" class="js-smell-location">2</a>                  <a href="signature_spec.html#L1302" class="js-smell-location">3</a>                  </div>  </li></ol>
    it &quot;returns true if the signature has an invalidated state&quot; do
      signature = FactoryBot.build(:invalidated_signature)
      expect(signature.invalidated?).to be_truthy
    end

    (Signature::STATES - [Signature::INVALIDATED_STATE]).each do |state|
      it &quot;returns false if the signature is #{state} state&quot; do
        signature = FactoryBot.build(:&quot;#{state}_signature&quot;)
        expect(signature.invalidated?).to be_falsey
      end
    end
  end

  describe &#39;#creator?&#39; do
    let(:petition) { FactoryBot.create(:petition) }
    let(:signature) { FactoryBot.create(:signature, petition: petition) }
    let(:creator) { petition.creator }

    it &#39;is true if the signature is the creator for the petition it belongs to&#39; do
      expect(creator.creator?).to be_truthy
    end

    it &#39;is false if the signature is not the creator for the petition it belongs to&#39; do
      expect(signature.creator?).to be_falsey
    end
  end

  describe &#39;#sponsor?&#39; do
    let(:petition) { FactoryBot.create(:petition) }
    let(:sponsor) { FactoryBot.create(:sponsor, petition: petition) }
    let(:signature) { FactoryBot.create(:signature, petition: petition) }

    it &#39;is true if the signature is a sponsor signature for the petition it belongs to&#39; do
      expect(sponsor.sponsor?).to be_truthy
    end

    it &#39;is false if the signature is not a sponsor signature for the petition it belongs to&#39; do
      expect(signature.sponsor?).to be_falsey
    end
  end

  describe &#39;#validate!&#39; do
    let(:signature) { FactoryBot.create(:pending_signature, attributes) }
    let(:location_code) { &quot;GB&quot; }
    let(:postcode) { &quot;SW1A 1AA&quot; }

    let (:attributes) do
      {
        petition: petition,
        name: &quot;Suzy Signer&quot;,
        email: &quot;suzy@example.com&quot;,
        postcode: postcode,
        location_code: location_code,
        uk_citizenship: &quot;1&quot;,
        created_at: 2.days.ago,
        updated_at: 2.days.ago
      }
    end

    context &quot;when the petition is open&quot; do
      let(:petition) do
        FactoryBot.create(:open_petition,
          created_at: 2.days.ago,
          updated_at: 2.days.ago,
          last_signed_at: 1.days.ago,
          creator_attributes: {
            validated_at: 2.days.ago
          }
        )
      end

      it &quot;transitions the signature to the validated state&quot; do
        signature.validate!
        expect(signature).to be_validated
      end

      it &quot;timestamps the signature to say it was updated just now&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 9 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L1574" class="js-smell-location">0</a>                  <a href="petition_spec.html#L1579" class="js-smell-location">1</a>                  <a href="petition_spec.html#L1598" class="js-smell-location">2</a>                  <a href="petition_spec.html#L1603" class="js-smell-location">3</a>                  <a href="petition_spec.html#L1782" class="js-smell-location">4</a>                  <a href="signature_spec.html#L1379" class="js-smell-location">5</a>                  <a href="signature_spec.html#L1384" class="js-smell-location">6</a>                  <a href="signature_spec.html#L1662" class="js-smell-location">7</a>                  <a href="signature_spec.html#L1675" class="js-smell-location">8</a>                  </div>  </li></ol>
        signature.validate!
        expect(signature.updated_at).to be_within(1.second).of(Time.current)
      end

      it &quot;timestamps the signature to say it was validated just now&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 9 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L1574" class="js-smell-location">0</a>                  <a href="petition_spec.html#L1579" class="js-smell-location">1</a>                  <a href="petition_spec.html#L1598" class="js-smell-location">2</a>                  <a href="petition_spec.html#L1603" class="js-smell-location">3</a>                  <a href="petition_spec.html#L1782" class="js-smell-location">4</a>                  <a href="signature_spec.html#L1379" class="js-smell-location">5</a>                  <a href="signature_spec.html#L1384" class="js-smell-location">6</a>                  <a href="signature_spec.html#L1662" class="js-smell-location">7</a>                  <a href="signature_spec.html#L1675" class="js-smell-location">8</a>                  </div>  </li></ol>
        signature.validate!
        expect(signature.validated_at).to be_within(1.second).of(Time.current)
      end

      it &quot;increments the petition count&quot; do
        expect{ signature.validate! }.to change{ petition.reload.signature_count }.by(1)
      end

      it &quot;updates the petition to say it was updated just now&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1393" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1398" class="js-smell-location">1</a>                  <a href="signature_spec.html#L1684" class="js-smell-location">2</a>                  </div>  </li></ol>
        signature.validate!
        expect(petition.reload.updated_at).to be_within(1.second).of(Time.current)
      end

      it &quot;updates the petition to say it was last signed at just now&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1393" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1398" class="js-smell-location">1</a>                  <a href="signature_spec.html#L1684" class="js-smell-location">2</a>                  </div>  </li></ol>
        signature.validate!
        expect(petition.reload.last_signed_at).to be_within(1.second).of(Time.current)
      end

      it &quot;doesn&#39;t increment the petition count twice&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1403" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1689" class="js-smell-location">1</a>                  </div>  </li></ol>
        signature.validate!
        expect{ signature.validate! }.to change{ petition.reload.signature_count }.by(0)
      end

      it &quot;generates a signed_token if it&#39;s missing&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#validate!)::context(when the petition is open)::it#generates a signed_token if it's missing has a flog score of 28</span>          </div>  </li></ol>
        signature.update_column(:signed_token, nil)

        expect {
          signature.validate!
        }.to change {
          signature.reload[:signed_token]
        }.from(nil).to(be_present)
      end

      it &quot;retries if the schema has changed&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1418" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1716" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#validate!)::context(when the petition is open)::it#retries if the schema has changed has a flog score of 49</span>          </div>  </li></ol>
        expect(signature).to receive(:lock!).once.and_raise(PG::InFailedSqlTransaction)
        expect(signature).to receive(:lock!).once.and_call_original
        expect(signature.class.connection).to receive(:clear_cache!).once

        signature.validate!
        expect(signature).to be_validated
      end

      it &quot;raises PG::InFailedSqlTransaction if it fails twice&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1427" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1725" class="js-smell-location">1</a>                  </div>  </li></ol>
        expect(signature).to receive(:lock!).twice.and_raise(PG::InFailedSqlTransaction)
        expect{ signature.validate! }.to raise_error(PG::InFailedSqlTransaction)
      end

      context &quot;and the signer is from the UK&quot; do
        let(:location_code) { &quot;GB&quot; }

        context &quot;and the postcode is valid&quot; do
          let(:postcode) { &quot;SW1A 1AA&quot; }

          it &quot;calls the Constituency API and sets the constituency_id&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#validate!)::context(when the petition is open)::context(and the signer is from the UK)::context(and the postcode is valid)::it#calls the Constituency API and sets the constituency_id has a flog score of 34</span>          </div>  </li></ol>
            expect(Constituency).to receive(:find_by_postcode).with(&quot;SW1A1AA&quot;).and_call_original

            signature.validate!

            expect(signature).to be_validated
            expect(signature.constituency_id).to eq(&quot;3415&quot;)
          end
        end

        context &quot;and the postcode is invalid&quot; do
          let(:postcode) { &quot;SW14 9RQ&quot; }

          it &quot;calls the Constituency API but doesn&#39;t set constituency_id&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#validate!)::context(when the petition is open)::context(and the signer is from the UK)::context(and the postcode is invalid)::it#calls the Constituency API but doesn't set constituency_id has a flog score of 34</span>          </div>  </li></ol>
            expect(Constituency).to receive(:find_by_postcode).with(&quot;SW149RQ&quot;).and_call_original

            signature.validate!

            expect(signature).to be_validated
            expect(signature.constituency_id).to be_nil
          end
        end
      end

      context &quot;and the signer is not from the UK&quot; do
        let(:location_code) { &quot;US&quot; }

        context &quot;and the postcode is set&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1465" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1478" class="js-smell-location">1</a>                  </div>  </li></ol>
          let(:postcode) { &quot;12345&quot; }

          it &quot;doesn&#39;t call the Constituency API and doesn&#39;t set constituency_id&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#validate!)::context(when the petition is open)::context(and the signer is not from the UK)::context(and the postcode is set)::it#doesn't call the Constituency API and doesn't set constituency_id has a flog score of 30</span>          </div>  </li></ol>
            expect(Constituency).not_to receive(:find_by_postcode)

            signature.validate!

            expect(signature).to be_validated
            expect(signature.constituency_id).to be_nil
          end
        end

        context &quot;and the postcode is blank&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1465" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1478" class="js-smell-location">1</a>                  </div>  </li></ol>
          let(:postcode) { &quot;&quot; }

          it &quot;doesn&#39;t call the Constituency API and doesn&#39;t set constituency_id&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#validate!)::context(when the petition is open)::context(and the signer is not from the UK)::context(and the postcode is blank)::it#doesn't call the Constituency API and doesn't set constituency_id has a flog score of 30</span>          </div>  </li></ol>
            expect(Constituency).not_to receive(:find_by_postcode)

            signature.validate!

            expect(signature).to be_validated
            expect(signature.constituency_id).to be_nil
          end
        end
      end

      context &quot;and the signature is fraudulent&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1492" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1512" class="js-smell-location">1</a>                  </div>  </li></ol>
        let(:signature) { FactoryBot.create(:fraudulent_signature, attributes) }

        it &quot;doesn&#39;t transition the signature to the validated state&quot; do
          expect {
            signature.validate!
          }.not_to change {
            signature.reload.validated?
          }.from(false)
        end

        it &quot;doesn&#39;t increment the petition count&quot; do
          expect {
            signature.validate!
          }.not_to change {
            petition.reload.signature_count
          }
        end
      end

      context &quot;and the signature is invalidated&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1492" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1512" class="js-smell-location">1</a>                  </div>  </li></ol>
        let(:signature) { FactoryBot.create(:invalidated_signature, attributes) }

        it &quot;doesn&#39;t transition the signature to the validated state&quot; do
          expect {
            signature.validate!
          }.not_to change {
            signature.reload.validated?
          }.from(false)
        end

        it &quot;doesn&#39;t increment the petition count&quot; do
          expect {
            signature.validate!
          }.not_to change {
            petition.reload.signature_count
          }
        end
      end

      describe &quot;using the force: true option&quot; do
        context &quot;and the signature is fraudulent&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1533" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1553" class="js-smell-location">1</a>                  </div>  </li></ol>
          let(:signature) { FactoryBot.create(:fraudulent_signature, attributes) }

          it &quot;transitions the signature to the validated state&quot; do
            expect {
              signature.validate!(force: true)
            }.to change {
              signature.reload.validated?
            }.from(false).to(true)
          end

          it &quot;increments the petition count&quot; do
            expect {
              signature.validate!(force: true)
            }.to change {
              petition.reload.signature_count
            }.by(1)
          end
        end

        context &quot;and the signature is invalidated&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1533" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1553" class="js-smell-location">1</a>                  </div>  </li></ol>
          let(:signature) { FactoryBot.create(:invalidated_signature, attributes) }

          it &quot;transitions the signature to the validated state&quot; do
            expect {
              signature.validate!(force: true)
            }.to change {
              signature.reload.validated?
            }.from(false).to(true)
          end

          it &quot;increments the petition count&quot; do
            expect {
              signature.validate!(force: true)
            }.to change {
              petition.reload.signature_count
            }.by(1)
          end
        end
      end

      describe &quot;using the :request option&quot; do
        let(:signature) { FactoryBot.create(:pending_signature, attributes) }
        let(:request) { double(:request, remote_ip: &quot;12.34.56.78&quot;) }

        it &quot;records the ip address of the validation request&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#validate!)::context(when the petition is open)::describe(using the :request option)::it#records the ip address of the validation request has a flog score of 25</span>          </div>  </li></ol>
          expect {
            signature.validate!(request: request)
          }.to change {
            signature.reload.validated_ip
          }.from(nil).to(&quot;12.34.56.78&quot;)
        end
      end
    end
  end

  describe &quot;#just_validated?&quot; do
    let(:petition) { FactoryBot.create(:petition) }
    let(:signature) { FactoryBot.create(:pending_signature, petition: petition) }

    context &quot;when the signature is pending&quot; do
      it &quot;returns false&quot; do
        expect(signature.just_validated?).to eq(false)
      end
    end

    context &quot;when the signature has just been validated&quot; do
      before do
        signature.validate!
      end

      it &quot;returns true&quot; do
        expect(signature.just_validated?).to eq(true)
      end
    end

    context &quot;when the signature has been reloaded after validation&quot; do
      before do
        signature.validate!
        signature.reload
      end

      it &quot;returns false&quot; do
        expect(signature.just_validated?).to eq(false)
      end
    end
  end

  describe &quot;#validated_before?&quot; do
    let(:petition) { FactoryBot.create(:petition) }
    let(:timestamp) { 15.minutes.ago }

    %w[pending fraudulent invalidated].each do |state|
      context &quot;when the signature is #{state}&quot; do
        let(:signature) { FactoryBot.create(:&quot;#{state}_signature&quot;, petition: petition) }

        it &quot;returns false&quot; do
          expect(signature.validated_before?(timestamp)).to eq(false)
        end
      end
    end

    context &quot;when the signature has been validated within the last 15 minutes&quot; do
      let(:signature) { FactoryBot.create(:validated_signature, validated_at: 5.minutes.ago, petition: petition) }

      it &quot;returns false&quot; do
        expect(signature.validated_before?(timestamp)).to eq(false)
      end
    end

    context &quot;when the signature has been validated over 15 minutes ago&quot; do
      let(:signature) { FactoryBot.create(:validated_signature, validated_at: 30.minutes.ago, petition: petition) }

      it &quot;returns true&quot; do
        expect(signature.validated_before?(timestamp)).to eq(true)
      end
    end
  end

  describe &#39;#invalidate!&#39; do
    let!(:petition) { FactoryBot.create(:open_petition, created_at: 2.days.ago, updated_at: 2.days.ago) }
    let!(:signature) { FactoryBot.create(:validated_signature, petition: petition, created_at: 2.days.ago, updated_at: 2.days.ago) }
    let(:now) { Time.current }

    it &quot;transitions the signature to the validated state&quot; do
      signature.invalidate!
      expect(signature).to be_invalidated
    end

    it &quot;timestamps the signature to say it was updated just now&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 9 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L1574" class="js-smell-location">0</a>                  <a href="petition_spec.html#L1579" class="js-smell-location">1</a>                  <a href="petition_spec.html#L1598" class="js-smell-location">2</a>                  <a href="petition_spec.html#L1603" class="js-smell-location">3</a>                  <a href="petition_spec.html#L1782" class="js-smell-location">4</a>                  <a href="signature_spec.html#L1379" class="js-smell-location">5</a>                  <a href="signature_spec.html#L1384" class="js-smell-location">6</a>                  <a href="signature_spec.html#L1662" class="js-smell-location">7</a>                  <a href="signature_spec.html#L1675" class="js-smell-location">8</a>                  </div>  </li></ol>
      signature.invalidate!
      expect(signature.updated_at).to be_within(1.second).of(Time.current)
    end

    it &quot;sets notify_by_email to false&quot; do
      expect {
        signature.invalidate!
      }.to change {
        signature.reload.notify_by_email?
      }.from(true).to(false)
    end

    it &quot;timestamps the signature to say it was invalidated just now&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 9 nodes</span>              <span>Locations:</span>                  <a href="petition_spec.html#L1574" class="js-smell-location">0</a>                  <a href="petition_spec.html#L1579" class="js-smell-location">1</a>                  <a href="petition_spec.html#L1598" class="js-smell-location">2</a>                  <a href="petition_spec.html#L1603" class="js-smell-location">3</a>                  <a href="petition_spec.html#L1782" class="js-smell-location">4</a>                  <a href="signature_spec.html#L1379" class="js-smell-location">5</a>                  <a href="signature_spec.html#L1384" class="js-smell-location">6</a>                  <a href="signature_spec.html#L1662" class="js-smell-location">7</a>                  <a href="signature_spec.html#L1675" class="js-smell-location">8</a>                  </div>  </li></ol>
      signature.invalidate!
      expect(signature.invalidated_at).to be_within(1.second).of(Time.current)
    end

    it &quot;decrements the petition count&quot; do
      expect{ signature.invalidate! }.to change{ petition.reload.signature_count }.by(-1)
    end

    it &quot;updates the petition to say it was updated just now&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1393" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1398" class="js-smell-location">1</a>                  <a href="signature_spec.html#L1684" class="js-smell-location">2</a>                  </div>  </li></ol>
      signature.invalidate!
      expect(petition.reload.updated_at).to be_within(1.second).of(Time.current)
    end

    it &quot;doesn&#39;t decrement the petition count twice&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1403" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1689" class="js-smell-location">1</a>                  </div>  </li></ol>
      signature.invalidate!
      expect{ signature.invalidate! }.to change{ petition.reload.signature_count }.by(0)
    end

    it &#39;tells the relevant constituency petition journal to invalidate the signature&#39; do
      expect(ConstituencyPetitionJournal).to receive(:invalidate_signature_for).with(signature, now)
      signature.invalidate!(now)
    end

    it &#39;does not talk to the constituency petition journal if the signature is not validated&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1699" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1710" class="js-smell-location">1</a>                  </div>  </li></ol>
      expect(ConstituencyPetitionJournal).not_to receive(:invalidate_signature_for)
      signature.update_columns(state: Signature::INVALIDATED_STATE)
      signature.invalidate!
    end

    it &#39;tells the relevant country petition journal to invalidate the signature&#39; do
      expect(CountryPetitionJournal).to receive(:invalidate_signature_for).with(signature, now)
      signature.invalidate!(now)
    end

    it &#39;does not talk to the country petition journal if the signature is not validated&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1699" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1710" class="js-smell-location">1</a>                  </div>  </li></ol>
      expect(CountryPetitionJournal).not_to receive(:invalidate_signature_for)
      signature.update_columns(state: Signature::INVALIDATED_STATE)
      signature.invalidate!
    end

    it &quot;retries if the schema has changed&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1418" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1716" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#invalidate!)::it#retries if the schema has changed has a flog score of 46</span>          </div>  </li></ol>
      expect(signature).to receive(:lock!).once.and_raise(PG::InFailedSqlTransaction)
      expect(signature).to receive(:lock!).once.and_call_original
      expect(signature.class.connection).to receive(:clear_cache!).once

      signature.invalidate!
      expect(signature).to be_invalidated
    end

    it &quot;raises PG::InFailedSqlTransaction if it fails twice&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1427" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1725" class="js-smell-location">1</a>                  </div>  </li></ol>
      expect(signature).to receive(:lock!).twice.and_raise(PG::InFailedSqlTransaction)
      expect{ signature.invalidate! }.to raise_error(PG::InFailedSqlTransaction)
    end

    context &quot;when the signature is pending&quot; do
      let(:signature) { FactoryBot.create(:pending_signature, petition: petition) }

      it &quot;doesn&#39;t decrement the petition count&quot; do
        expect{ signature.invalidate! }.not_to change{ petition.reload.signature_count }
      end

      it &quot;doesn&#39;t update the constituency journal&quot; do
        expect(ConstituencyPetitionJournal).not_to receive(:invalidate_signature_for)
        signature.invalidate!
      end

      it &quot;doesn&#39;t update the country journal&quot; do
        expect(CountryPetitionJournal).not_to receive(:invalidate_signature_for)
        signature.invalidate!
      end
    end
  end

  describe &quot;#save&quot; do
    let(:petition) { FactoryBot.create(:petition, creator_attributes: { name: &quot;Alice&quot;, email: &quot;aliceandbob@example.com&quot; }) }

    before do
      FactoryBot.create(:validated_signature, name: &quot;Bob&quot;, email: &quot;aliceandbob@example.com&quot;, petition: petition)
    end

    context &quot;when the new creator hasn&#39;t already signed&quot; do
      it &quot;saves the new name&quot; do
        expect(petition.update(creator_attributes: { name: &quot;Fred&quot; })).to be_truthy
      end
    end

    context &quot;when the new creator has already signed&quot; do
      it &quot;doesn&#39;t save the new name&quot; do
        expect(petition.update(creator_attributes: { name: &quot;Bob&quot; })).to be_falsey
      end

      it &quot;adds an error to the name attribute&quot; do
        expect {
          petition.update(creator_attributes: { name: &quot;Bob&quot; })
        }.to change {
          petition.creator.errors[:name]
        }.from([]).to([&quot;Bob has already signed this petition using aliceandbob@example.com&quot;])
      end
    end
  end

  describe &quot;#unsubscribe&quot; do
    let(:signature) { FactoryBot.create(:validated_signature, notify_by_email: subscribed) }
    let(:unsubscribe_token) { signature.unsubscribe_token }

    before do
      signature.unsubscribe!(unsubscribe_token)
    end

    context &quot;when subcribed&quot; do
      let(:subscribed) { true }

      it &quot;changes the subscription status&quot; do
        expect(signature.notify_by_email).to be_falsey
      end

      it &quot;doesn&#39;t add an error to the :base attribute&quot; do
        expect(signature.errors[:base]).to be_empty
      end
    end

    context &quot;when already unsubcribed&quot; do
      let(:subscribed) { false }

      it &quot;doesn&#39;t change the subscription status&quot; do
        expect(signature.notify_by_email).to be_falsey
      end

      it &quot;adds an error to the :base attribute&quot; do
        expect(signature.errors[:base]).to include(&quot;Already Unsubscribed&quot;)
      end
    end

    context &quot;when token is invalid&quot; do
      let(:subscribed) { true }
      let(:unsubscribe_token) { &quot;invalid token&quot; }

      it &quot;doesn&#39;t change the subscription status&quot; do
        expect(signature.notify_by_email).to be_truthy
      end

      it &quot;adds an error to the :base attribute&quot; do
        expect(signature.errors[:base]).to include(&quot;Invalid Unsubscribe Token&quot;)
      end
    end
  end

  describe &quot;#already_unsubscribed?&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L757" class="js-smell-location">0</a>                  <a href="archived/signature_spec.html#L777" class="js-smell-location">1</a>                  <a href="signature_spec.html#L1823" class="js-smell-location">2</a>                  <a href="signature_spec.html#L1843" class="js-smell-location">3</a>                  </div>  </li></ol>
    let(:signature) { FactoryBot.create(:validated_signature) }

    context &quot;when there is no error on the :base attribute&quot; do
      it &quot;returns false&quot; do
        expect(signature.already_unsubscribed?).to be_falsey
      end
    end

    context &quot;when there is an error on the :base attribute&quot; do
      before do
        signature.errors.add(:base, &quot;Already Unsubscribed&quot;)
      end

      it &quot;returns true&quot; do
        expect(signature.already_unsubscribed?).to be_truthy
      end
    end
  end

  describe &quot;#invalid_unsubscribe_token?&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L757" class="js-smell-location">0</a>                  <a href="archived/signature_spec.html#L777" class="js-smell-location">1</a>                  <a href="signature_spec.html#L1823" class="js-smell-location">2</a>                  <a href="signature_spec.html#L1843" class="js-smell-location">3</a>                  </div>  </li></ol>
    let(:signature) { FactoryBot.create(:validated_signature) }

    context &quot;when there is no error on the :base attribute&quot; do
      it &quot;returns false&quot; do
        expect(signature.invalid_unsubscribe_token?).to be_falsey
      end
    end

    context &quot;when there is an error on the :base attribute&quot; do
      before do
        signature.errors.add(:base, &quot;Invalid Unsubscribe Token&quot;)
      end

      it &quot;returns true&quot; do
        expect(signature.invalid_unsubscribe_token?).to be_truthy
      end
    end
  end

  describe &quot;#subscribed?&quot; do
    context &quot;when the signature is pending&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1864" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1890" class="js-smell-location">1</a>                  <a href="signature_spec.html#L1898" class="js-smell-location">2</a>                  </div>  </li></ol>
      let(:signature) { FactoryBot.build(:pending_signature, notify_by_email: true) }

      it &quot;returns false&quot; do
        expect(signature.subscribed?).to eq(false)
      end
    end

    context &quot;when the signature is validated&quot; do
      context &quot;and notify_by_email is true&quot; do
        let(:signature) { FactoryBot.build(:validated_signature, notify_by_email: true) }

        it &quot;returns true&quot; do
          expect(signature.subscribed?).to eq(true)
        end
      end

      context &quot;and notify_by_email is false&quot; do
        let(:signature) { FactoryBot.build(:validated_signature, notify_by_email: false) }

        it &quot;returns false&quot; do
          expect(signature.subscribed?).to eq(false)
        end
      end
    end

    context &quot;when the signature is fraudulent&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1864" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1890" class="js-smell-location">1</a>                  <a href="signature_spec.html#L1898" class="js-smell-location">2</a>                  </div>  </li></ol>
      let(:signature) { FactoryBot.build(:fraudulent_signature, notify_by_email: true) }

      it &quot;returns false&quot; do
        expect(signature.subscribed?).to eq(false)
      end
    end

    context &quot;when the signature is invalidated&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1864" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1890" class="js-smell-location">1</a>                  <a href="signature_spec.html#L1898" class="js-smell-location">2</a>                  </div>  </li></ol>
      let(:signature) { FactoryBot.build(:invalidated_signature, notify_by_email: true) }

      it &quot;returns false&quot; do
        expect(signature.subscribed?).to eq(false)
      end
    end
  end

  describe &quot;#constituency&quot; do
    let(:signature) { FactoryBot.build(:signature, attributes) }
    let(:constituency) { signature.constituency }
    let(:location_code) { &quot;GB&quot; }

    let(:attributes) do
      { postcode: postcode, constituency_id: constituency_id }
    end

    context &quot;when the constituency_id is not set&quot; do
      let(:constituency_id) { nil }

      context &quot;and the signature is not from the UK&quot; do
        let(:postcode) { &quot;12345&quot; }

        it &quot;returns nil&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#constituency)::context(when the constituency_id is not set)::context(and the signature is not from the UK)::it#returns nil has a flog score of 27</span>          </div>  </li></ol>
          expect(signature).to receive(:united_kingdom?).and_return(false)
          expect(Constituency).not_to receive(:find_by_postcode)
          expect(signature.constituency).to be_nil
        end
      end

      context &quot;and the API returns a single result&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1929" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1942" class="js-smell-location">1</a>                  </div>  </li></ol>
        let(:postcode) { &quot;N1 1TY&quot; }

        before do
          stub_api_request_for(&quot;N11TY&quot;).to_return(api_response(:ok, &quot;single&quot;))
        end

        it &quot;returns the correct constituency&quot; do
          expect(Constituency).to receive(:find_by_postcode).with(&quot;N11TY&quot;).and_call_original
          expect(constituency.name).to eq(&quot;Islington South and Finsbury&quot;)
        end
      end

      context &quot;and the API returns multiple result&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1929" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1942" class="js-smell-location">1</a>                  </div>  </li></ol>
        let(:postcode) { &quot;N1&quot; }

        before do
          stub_api_request_for(&quot;N1&quot;).to_return(api_response(:ok, &quot;multiple&quot;))
        end

        it &quot;returns the correct constituency&quot; do
          expect(Constituency).to receive(:find_by_postcode).with(&quot;N1&quot;).and_call_original
          expect(constituency.name).to eq(&quot;Hackney North and Stoke Newington&quot;)
        end
      end


      context &quot;and the API returns no results&quot; do
        let(:postcode) { &quot;SW14 9RQ&quot; }

        before do
          stub_api_request_for(&quot;SW149RQ&quot;).to_return(api_response(:ok, &quot;no_results&quot;))
        end

        it &quot;returns nil&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1963" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1976" class="js-smell-location">1</a>                  </div>  </li></ol>
          expect(Constituency).to receive(:find_by_postcode).with(&quot;SW149RQ&quot;).and_call_original
          expect(constituency).to be_nil
        end
      end

      context &quot;and the API raises an error&quot; do
        let(:postcode) { &quot;N1 1TY&quot; }

        before do
          stub_api_request_for(&quot;N11TY&quot;).to_timeout
        end

        it &quot;returns nil&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L1963" class="js-smell-location">0</a>                  <a href="signature_spec.html#L1976" class="js-smell-location">1</a>                  </div>  </li></ol>
          expect(Constituency).to receive(:find_by_postcode).with(&quot;N11TY&quot;).and_call_original
          expect(constituency).to be_nil
        end
      end
    end

    context &quot;when the constituency_id is set&quot; do
      let(:constituency_id) { &quot;3415&quot; }
      let(:postcode) { &quot;SW1A 1AA&quot; }

      it &quot;searches the database for the constituency&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#constituency)::context(when the constituency_id is set)::it#searches the database for the constituency has a flog score of 26</span>          </div>  </li></ol>
        expect(Constituency).not_to receive(:find_by_postcode)
        expect(Constituency).to receive(:find_by_external_id).with(&quot;3415&quot;).and_call_original
        expect(constituency.name).to eq(&quot;Cities of London and Westminster&quot;)
      end
    end
  end

  describe &quot;#signed_token&quot; do
    let(:signature) { FactoryBot.create(:validated_signature) }

    context &quot;when the underlying column is nil&quot; do
      before do
        signature.update_column(:signed_token, nil)
      end

      it &quot;generates and saves a new token&quot; do
        expect {
          signature.signed_token
        }.to change {
          signature.reload[:signed_token]
        }.from(nil).to(be_present)
      end
    end

    context &quot;when another process has updated the column&quot; do
      let(:token) { Authlogic::Random.friendly_token }

      before do
        signature.update_column(:signed_token, nil)
      end

      it &quot;returns the token from the database&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#signed_token)::context(when another process has updated the column)::it#returns the token from the database has a flog score of 36</span>          </div>  </li></ol>
        expect(signature).to receive(:signed_token?).and_return(true)
        expect(signature).to receive(:read_attribute).with(:signed_token).and_return(token)
        expect(signature.signed_token).to eq(token)
      end
    end
  end

  describe &#39;email sent timestamps&#39; do
    describe &#39;#get_email_sent_at_for&#39; do
      let(:signature) { FactoryBot.create(:validated_signature) }
      let(:the_stored_time) { 6.days.ago }

      [
        %w[government_response government_response_email_at],
        %w[debate_scheduled debate_scheduled_email_at],
        %w[debate_outcome debate_outcome_email_at],
        %w[petition_email petition_email_at]
      ].each do |timestamp, column|

        context &quot;when the timestamp &#39;#{timestamp}&#39; is not set&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L504" class="js-smell-location">0</a>                  <a href="signature_spec.html#L2039" class="js-smell-location">1</a>                  </div>  </li></ol>
          it &quot;returns nil&quot; do
            expect(signature.get_email_sent_at_for(timestamp)).to be_nil
          end
        end

        context &quot;when the timestamp &#39;#{timestamp}&#39; is set&quot; do
          before do
            signature.update_column(column, the_stored_time)
          end

          it &quot;returns the stored timestamp&quot; do
            expect(signature.get_email_sent_at_for(timestamp)).to eq(the_stored_time)
          end
        end

      end
    end

    describe &#39;#set_email_sent_at_for&#39; do
      let(:signature) { FactoryBot.create(:validated_signature) }
      let(:the_stored_time) { 6.days.ago }

      [
        %w[government_response government_response_email_at],
        %w[debate_scheduled debate_scheduled_email_at],
        %w[debate_outcome debate_outcome_email_at],
        %w[petition_email petition_email_at]
      ].each do |timestamp, column|

        context &quot;when a time is supplied for timestamp &#39;#{timestamp}&#39;&quot; do
          it &quot;sets the column to the supplied time&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(email sent timestamps)::describe(#set_email_sent_at_for)::it#sets the column to the supplied time has a flog score of 37</span>          </div>  </li></ol>
            expect {
              signature.set_email_sent_at_for(timestamp, to: the_stored_time)
            }.to change {
              signature.reload[column]
            }.from(nil).to(be_within(0.001.second).of(the_stored_time))
          end
        end

        context &quot;when a time is not supplied for timestamp &#39;#{timestamp}&#39;&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/signature_spec.html#L537" class="js-smell-location">0</a>                  <a href="signature_spec.html#L2079" class="js-smell-location">1</a>                  </div>  </li></ol>
          it &quot;sets the column to the current time&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(email sent timestamps)::describe(#set_email_sent_at_for)::it#sets the column to the current time has a flog score of 35</span>          </div>  </li></ol>
            expect {
              signature.set_email_sent_at_for(timestamp)
            }.to change {
              signature.reload[column]
            }.from(nil).to(be_within(1.second).of(Time.current))
          end
        end

      end
    end

    describe &quot;#need_emailing_for&quot; do
      let!(:a_signature) { FactoryBot.create(:validated_signature) }
      let!(:another_signature) { FactoryBot.create(:validated_signature) }
      let(:since_timestamp) { 5.days.ago }

      subject { Signature.need_emailing_for(&#39;government_response&#39;, since: since_timestamp) }

      it &quot;does not return those that do not want to be emailed&quot; do
        a_signature.update_attribute(:notify_by_email, false)
        expect(subject).not_to include a_signature
      end

      it &quot;does not return unvalidated signatures&quot; do
        another_signature.update_column(:state, Signature::PENDING_STATE)
        expect(subject).not_to include another_signature
      end

      it &quot;does not return signatures that have a sent timestamp newer than the petitions requested receipt&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L2109" class="js-smell-location">0</a>                  <a href="signature_spec.html#L2119" class="js-smell-location">1</a>                  </div>  </li></ol>
        another_signature.set_email_sent_at_for(&#39;government_response&#39;, to: since_timestamp + 1.day)
        expect(subject).not_to include another_signature
      end

      it &quot;does not return signatures that have a sent timestamp equal to the petitions requested receipt&quot; do
        another_signature.set_email_sent_at_for(&#39;government_response&#39;, to: since_timestamp)
        expect(subject).not_to include another_signature
      end

      it &quot;does return signatures that have a sent timestamp older than the petitions requested receipt&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L2109" class="js-smell-location">0</a>                  <a href="signature_spec.html#L2119" class="js-smell-location">1</a>                  </div>  </li></ol>
        another_signature.set_email_sent_at_for(&#39;government_response&#39;, to: since_timestamp - 1.day)
        expect(subject).to include another_signature
      end

      it &quot;returns signatures that have null for the requested timestamp&quot; do
        a_signature.update_column(:government_response_email_at, nil)
        expect(subject).to match_array [a_signature, another_signature]
      end
    end
  end

  describe &quot;#email_count&quot; do
    it &quot;returns 0 for new signatures&quot; do
      signature = FactoryBot.create(:pending_signature)
      expect(signature.email_count).to be(0)
    end
  end

  describe &quot;#email_threshold_reached?&quot; do
    let(:email_count_threshold) { 5 }

    it &quot;returns false when the signature hasn&#39;t reached the threshold&quot; do
      signature = FactoryBot.create(:validated_signature)
      expect(signature.email_threshold_reached?).to be false
    end

    it &quot;returns true when the signature is at the email count threshold&quot; do
      signature = FactoryBot.create(:validated_signature, email_count: email_count_threshold)
      expect(signature.email_threshold_reached?).to be true
    end
  end

  describe &quot;#find_duplicate&quot; do
    let(:petition) { FactoryBot.create(:open_petition) }
    let(:other_petition) { FactoryBot.create(:open_petition) }
    let(:signature) { petition.signatures.build(attributes) }
    let(:name) { &quot;Suzy Signer&quot; }
    let(:postcode) { &quot;SW1A 1AA&quot; }
    let(:email) { &quot;foo@example.com&quot; }

    let(:attributes) do
      {
        name: name,
        email: email,
        postcode: postcode,
        location_code: &quot;GB&quot;,
        uk_citizenship: &quot;1&quot;
      }
    end

    context &quot;when a signature doesn&#39;t already exist with the same email address&quot; do
      it &quot;returns nil&quot; do
        expect(signature.find_duplicate).to be_nil
      end
    end

    context &quot;when a signature already exists with the same email address&quot; do
      before do
        petition.signatures.create!(
          name: &quot;Suzy Signer&quot;,
          email: &quot;foo@example.com&quot;,
          postcode: &quot;SW1A 1AA&quot;,
          location_code: &quot;GB&quot;,
          uk_citizenship: &quot;1&quot;
        )
      end

      context &quot;and the name is the same&quot; do
        it &quot;returns the signature&quot; do
          expect(signature.find_duplicate).to be_present
        end
      end

      context &quot;and the name is the same but different case&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L2193" class="js-smell-location">0</a>                  <a href="signature_spec.html#L2201" class="js-smell-location">1</a>                  <a href="signature_spec.html#L2209" class="js-smell-location">2</a>                  <a href="signature_spec.html#L2217" class="js-smell-location">3</a>                  <a href="signature_spec.html#L2242" class="js-smell-location">4</a>                  <a href="signature_spec.html#L2276" class="js-smell-location">5</a>                  </div>  </li></ol>
        let(:name) { &quot;suzy signer&quot; }

        it &quot;returns the signature&quot; do
          expect(signature.find_duplicate).to be_present
        end
      end

      context &quot;and the name is the same but with extra whitespace&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L2193" class="js-smell-location">0</a>                  <a href="signature_spec.html#L2201" class="js-smell-location">1</a>                  <a href="signature_spec.html#L2209" class="js-smell-location">2</a>                  <a href="signature_spec.html#L2217" class="js-smell-location">3</a>                  <a href="signature_spec.html#L2242" class="js-smell-location">4</a>                  <a href="signature_spec.html#L2276" class="js-smell-location">5</a>                  </div>  </li></ol>
        let(:name) { &quot; Suzy  Signer &quot; }

        it &quot;returns the signature&quot; do
          expect(signature.find_duplicate).to be_present
        end
      end

      context &quot;and the name is different&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L2193" class="js-smell-location">0</a>                  <a href="signature_spec.html#L2201" class="js-smell-location">1</a>                  <a href="signature_spec.html#L2209" class="js-smell-location">2</a>                  <a href="signature_spec.html#L2217" class="js-smell-location">3</a>                  <a href="signature_spec.html#L2242" class="js-smell-location">4</a>                  <a href="signature_spec.html#L2276" class="js-smell-location">5</a>                  </div>  </li></ol>
        let(:name) { &quot;Sam Signer&quot; }

        it &quot;returns nil&quot; do
          expect(signature.find_duplicate).to be_nil
        end
      end

      context &quot;and the postcode is different&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L2193" class="js-smell-location">0</a>                  <a href="signature_spec.html#L2201" class="js-smell-location">1</a>                  <a href="signature_spec.html#L2209" class="js-smell-location">2</a>                  <a href="signature_spec.html#L2217" class="js-smell-location">3</a>                  <a href="signature_spec.html#L2242" class="js-smell-location">4</a>                  <a href="signature_spec.html#L2276" class="js-smell-location">5</a>                  </div>  </li></ol>
        let(:postcode) { &quot;SW1A 1AB&quot; }

        it &quot;returns the signature&quot; do
          expect(signature.find_duplicate).to be_present
        end
      end

      context &quot;and the name and postcode are different&quot; do
        let(:name) { &quot;Sam Signer&quot; }
        let(:postcode) { &quot;SW1A 1AB&quot; }

        it &quot;returns the signature&quot; do
          expect(signature.find_duplicate).to be_present
        end
      end

      context &quot;and the name is the same, but is scoped to a different petition&quot; do
        let(:signature) { other_petition.signatures.build(attributes) }

        it &quot;returns nil&quot; do
          expect(signature.find_duplicate).to be_nil
        end
      end

      context &quot;but the email is a different case&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L2193" class="js-smell-location">0</a>                  <a href="signature_spec.html#L2201" class="js-smell-location">1</a>                  <a href="signature_spec.html#L2209" class="js-smell-location">2</a>                  <a href="signature_spec.html#L2217" class="js-smell-location">3</a>                  <a href="signature_spec.html#L2242" class="js-smell-location">4</a>                  <a href="signature_spec.html#L2276" class="js-smell-location">5</a>                  </div>  </li></ol>
        let(:email) { &quot;FOO@example.com&quot; }

        it &quot;returns the signature&quot; do
          expect(signature.find_duplicate).to be_present
        end
      end
    end

    context &quot;when two signatures already exists with the same email address&quot; do
      before do
        petition.signatures.create!(
          name: &quot;Suzy Signer&quot;,
          email: &quot;foo@example.com&quot;,
          postcode: &quot;SW1A 1AA&quot;,
          location_code: &quot;GB&quot;,
          uk_citizenship: &quot;1&quot;
        )

        petition.signatures.create!(
          name: &quot;Sam Signer&quot;,
          email: &quot;foo@example.com&quot;,
          postcode: &quot;SW1A 1AA&quot;,
          location_code: &quot;GB&quot;,
          uk_citizenship: &quot;1&quot;
        )
      end

      context &quot;and the name is the same&quot; do
        it &quot;returns the signature&quot; do
          expect(signature.find_duplicate).to be_present
        end
      end

      context &quot;and the name is different&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="signature_spec.html#L2193" class="js-smell-location">0</a>                  <a href="signature_spec.html#L2201" class="js-smell-location">1</a>                  <a href="signature_spec.html#L2209" class="js-smell-location">2</a>                  <a href="signature_spec.html#L2217" class="js-smell-location">3</a>                  <a href="signature_spec.html#L2242" class="js-smell-location">4</a>                  <a href="signature_spec.html#L2276" class="js-smell-location">5</a>                  </div>  </li></ol>
        let(:name) { &quot;Sue Signer&quot; }

        it &quot;returns the signature&quot; do
          expect(signature.find_duplicate).to be_present
        end
      end
    end
  end

  describe &quot;#find_duplicate!&quot; do
    let(:petition) { FactoryBot.create(:open_petition) }
    let(:signature) { petition.signatures.build(attributes) }

    let(:attributes) do
      {
        name: &quot;Suzy Signer&quot;,
        email: &quot;foo@example.com&quot;,
        postcode: &quot;SW1A 1AA&quot;,
        location_code: &quot;GB&quot;,
        uk_citizenship: &quot;1&quot;
      }
    end

    context &quot;when a duplicate signature doesn&#39;t exist&quot; do
      it &quot;raises an ActiveRecord::RecordNotFound exception&quot; do
        expect { signature.find_duplicate! }.to raise_exception(ActiveRecord::RecordNotFound)
      end
    end

    context &quot;when a duplicate signature does exist&quot; do
      before do
        petition.signatures.create!(attributes)
      end

      it &quot;returns the signature&quot; do
        expect(signature.find_duplicate!).to be_present
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- JavaScripts -->
    <script src='../../assets/javascripts/jquery.min.js'></script>
    <script src='../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../assets/javascripts/prettify.js'></script>
    <script src='../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../assets/javascripts/application.js'></script>
    <script src='../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>

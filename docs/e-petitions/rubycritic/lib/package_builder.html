<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../overview.html"><img src="../assets/images/logo.png" alt="Ruby Critic Logo" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
      
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-12-12 05:31:19 +0000'>2018-12-12 05:31:19 +0000</time>
        
      </span>
    </div>
    <div>
      <h3><small>lib /</small> package_builder.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating d big">
              D
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">1180</span><small> lines of codes</small></div>
              <div><span class="metric">72</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">5.0</span><small> complexity/method</small></div>
              <div><span class="metric">23</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">362.11</span><small> complexity</small></div>
              <div><span class="metric">0</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                50
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;tmpdir&#39;
require &#39;active_support/core_ext/string/strip&#39;
require &#39;aws-sdk&#39;
require &#39;faraday&#39;
require &#39;slack-notifier&#39;

class PackageBuilder<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>PackageBuilder has no descriptive comment</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Instance-Variables.md" target="_blank"><b>TooManyInstanceVariables</b></a>        </span>      </div>      <span>PackageBuilder has at least 5 instance variables</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Methods.md" target="_blank"><b>TooManyMethods</b></a>        </span>      </div>      <span>PackageBuilder has at least 72 methods</span>          </div>  </li></ol>
  class &lt;&lt; self
    def build!(environment = :staging)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>PackageBuilder has missing safe method 'build!'</span>          </div>  </li></ol>
      new(environment).build!
    end

    def deploy!(environment)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>PackageBuilder has missing safe method 'deploy!'</span>          </div>  </li></ol>
      new(environment).deploy!
    end
  end

  attr_reader :environment, :release, :revision, :tmpdir, :timestamp

  def initialize(enviroment)
    @environment = enviroment.to_s
    @revision    = %x[git rev-parse #{treeish}].strip
    @tmpdir      = Dir.mktmpdir
    @timestamp   = Time.now.getutc
    @release     = @timestamp.strftime(&#39;%Y%m%d%H%M%S&#39;)
  end

  def build!<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>PackageBuilder has missing safe method 'build!'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>PackageBuilder#build! has approx 12 statements</span>          </div>  </li></ol>
    info &quot;Building to #{tmpdir}&quot;

    create_archive
    extract_archive
    remove_archive
    write_appspec
    write_scripts

    Dir.chdir archive_path do
      package_gems unless skip_gems?
      create_revision_file
      remove_artifacts
    end

    build_package

    info &quot;Built package #{package_name}&quot;
  end

  def upload!<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>PackageBuilder has missing safe method 'upload!'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>PackageBuilder#upload! has approx 8 statements</span>          </div>  </li></ol>
    s3 = Aws::S3::Resource.new(region: region, profile: profile)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>PackageBuilder#upload! has the variable name 's3'</span>          </div>  </li></ol>
    bucket = s3.bucket(release_bucket)
    release_obj = bucket.object(release_key)

    info &quot;Uploading package #{package_name} to S3 ...&quot;
    start_time = Time.now<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>PackageBuilder#upload! calls 'Time.now' 2 times</span>              <span>Locations:</span>                  <a href="package_builder.html#L54" class="js-smell-location">0</a>                  <a href="package_builder.html#L58" class="js-smell-location">1</a>                  </div>  </li></ol>

    release_obj.upload_file(package_path)

    duration = Time.now - start_time<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>PackageBuilder#upload! calls 'Time.now' 2 times</span>              <span>Locations:</span>                  <a href="package_builder.html#L54" class="js-smell-location">0</a>                  <a href="package_builder.html#L58" class="js-smell-location">1</a>                  </div>  </li></ol>
    info &quot;Upload completed in #{duration} seconds.&quot;
  end

  def deploy!<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>PackageBuilder has missing safe method 'deploy!'</span>          </div>  </li></ol>
    WebMock.allow_net_connect! if defined? WebMock

    if ci? &amp;&amp; !deploy_build?
      info &quot;Skipping deployment ...&quot;
    else
      unless skip_build?
        build!
        upload!
      end

      create_deployment! if deploy_release?
    end
  end

  private

  def application_name
    &quot;#{ENV.fetch(&#39;AWS_DEPLOYMENT_APP_NAME&#39;, &#39;epetitions&#39;)}-#{environment}&quot;
  end

  def archive_file
    File.join(tmpdir, &quot;#{archive_name}.tar&quot;)
  end

  def archive_name
    &#39;source&#39;
  end

  def archive_path
    File.join(tmpdir, archive_name)
  end

  def build_package<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>PackageBuilder#build_package has approx 8 statements</span>          </div>  </li></ol>
    Dir.mkdir(&#39;pkg&#39;) unless Dir.exist?(&#39;pkg&#39;)

    args = %w[tar]
    args.concat [&#39;-cz&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#build_package refers to 'args' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L99" class="js-smell-location">0</a>                  <a href="package_builder.html#L100" class="js-smell-location">1</a>                  <a href="package_builder.html#L101" class="js-smell-location">2</a>                  <a href="package_builder.html#L102" class="js-smell-location">3</a>                  </div>  </li></ol>
    args.concat [&#39;-f&#39;, package_path]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#build_package refers to 'args' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L99" class="js-smell-location">0</a>                  <a href="package_builder.html#L100" class="js-smell-location">1</a>                  <a href="package_builder.html#L101" class="js-smell-location">2</a>                  <a href="package_builder.html#L102" class="js-smell-location">3</a>                  </div>  </li></ol>
    args.concat [&#39;-C&#39;, tmpdir]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#build_package refers to 'args' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L99" class="js-smell-location">0</a>                  <a href="package_builder.html#L100" class="js-smell-location">1</a>                  <a href="package_builder.html#L101" class="js-smell-location">2</a>                  <a href="package_builder.html#L102" class="js-smell-location">3</a>                  </div>  </li></ol>
    args.concat [&#39;.&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#build_package refers to 'args' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L99" class="js-smell-location">0</a>                  <a href="package_builder.html#L100" class="js-smell-location">1</a>                  <a href="package_builder.html#L101" class="js-smell-location">2</a>                  <a href="package_builder.html#L102" class="js-smell-location">3</a>                  </div>  </li></ol>

    info &quot;Building package ...&quot;
    Kernel.system *args
  end

  def ci?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#ci? doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV.fetch(&#39;CI&#39;, &#39;false&#39;) == &#39;true&#39;
  end

  def create_archive<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>PackageBuilder#create_archive has approx 7 statements</span>          </div>  </li></ol>
    args = %w[git archive]
    args.concat [&#39;--format&#39;, &#39;tar&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#create_archive refers to 'args' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L114" class="js-smell-location">0</a>                  <a href="package_builder.html#L115" class="js-smell-location">1</a>                  <a href="package_builder.html#L116" class="js-smell-location">2</a>                  <a href="package_builder.html#L117" class="js-smell-location">3</a>                  </div>  </li></ol>
    args.concat [&#39;--prefix&#39;, &#39;source/&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#create_archive refers to 'args' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L114" class="js-smell-location">0</a>                  <a href="package_builder.html#L115" class="js-smell-location">1</a>                  <a href="package_builder.html#L116" class="js-smell-location">2</a>                  <a href="package_builder.html#L117" class="js-smell-location">3</a>                  </div>  </li></ol>
    args.concat [&#39;--output&#39;, archive_file]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#create_archive refers to 'args' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L114" class="js-smell-location">0</a>                  <a href="package_builder.html#L115" class="js-smell-location">1</a>                  <a href="package_builder.html#L116" class="js-smell-location">2</a>                  <a href="package_builder.html#L117" class="js-smell-location">3</a>                  </div>  </li></ol>
    args.concat [treeish]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#create_archive refers to 'args' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L114" class="js-smell-location">0</a>                  <a href="package_builder.html#L115" class="js-smell-location">1</a>                  <a href="package_builder.html#L116" class="js-smell-location">2</a>                  <a href="package_builder.html#L117" class="js-smell-location">3</a>                  </div>  </li></ol>

    info &quot;Creating archive ...&quot;
    Kernel.system *args
  end

  def create_deployment!<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>PackageBuilder has missing safe method 'create_deployment!'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>PackageBuilder#create_deployment! has approx 6 statements</span>          </div>  </li></ol>
    client = Aws::CodeDeploy::Client.new(credentials)
    response = client.create_deployment(deployment_config)
    info &quot;Deployment created.&quot;

    track_progress(response.deployment_id) do |deployment_info|
      notify_appsignal
      notify_slack
    end
  end

  def create_revision_file
    File.write(revision_file, revision)
  end

  def credentials
    { region: region, profile: profile }
  end

  def deploy_branch?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#deploy_branch? doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV.fetch(&#39;TRAVIS_BRANCH&#39;, &#39;master&#39;) == &#39;master&#39;
  end

  def deploy_build?
    !pull_request? &amp;&amp; deploy_branch?
  end

  def deployment_config
    {
      application_name: application_name,
      deployment_group_name: deployment_group_name,
      revision: {
        revision_type: &#39;S3&#39;,
        s3_location: {
          bucket: release_bucket,
          key: deployment_key,
          bundle_type: &#39;tgz&#39;
        },
      },
      deployment_config_name: deployment_config_name,
      description: description,
      ignore_application_stop_failures: true
    }
  end

  def deployment_config_name<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#deployment_config_name doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    type = ENV.fetch(&#39;AWS_DEPLOYMENT_CONFIG_NAME&#39;, &#39;0&#39;)

    case type
    when &#39;2&#39;
      &#39;CodeDeployDefault.AllAtOnce&#39;
    when &#39;1&#39;
      &#39;CodeDeployDefault.HalfAtATime&#39;
    else
      &#39;CodeDeployDefault.OneAtATime&#39;
    end
  end

  def deployment_group_name<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#deployment_group_name doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV.fetch(&#39;AWS_DEPLOYMENT_GROUP_NAME&#39;, &#39;RailsAppServers&#39;)
  end

  def deployment_key
    skip_build? ? latest_key : release_key
  end

  def description<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#description doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV.fetch(&#39;AWS_DEPLOYMENT_DESCRIPTION&#39;, &#39;&#39;)
  end

  def extract_archive
    args = %w[tar]
    args.concat [&#39;-C&#39;, tmpdir]
    args.concat [&#39;-xf&#39;, archive_file]

    info &quot;Extracting archive ...&quot;
    Kernel.system *args
  end

  def info(message)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#info doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    $stdout.puts(message)
  end

  def latest_key
    &quot;/latest.tar.gz&quot;
  end

  def package_gems
    args = %w[bundle package --all --all-platforms]

    info &quot;Packaging gems ...&quot;
    Bundler.with_clean_env do
      Kernel.system *args
    end
  end

  def package_name
    &quot;#{timestamp.strftime(&#39;%Y%m%d%H%I%S&#39;)}.tar.gz&quot;
  end

  def package_path
    File.join(&#39;pkg&#39;, package_name)
  end

  def profile<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#profile doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV.fetch(&#39;AWS_PROFILE&#39;, &#39;epetitions&#39;)
  end

  def deploy_release?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#deploy_release? doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV.fetch(&#39;RELEASE&#39;, &#39;1&#39;).to_i.nonzero?
  end

  def notify_appsignal<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>PackageBuilder#notify_appsignal has approx 7 statements</span>          </div>  </li></ol>
    if appsignal_push_api_key
      conn = Faraday.new(url: &quot;https://push.appsignal.com&quot;)

      response = conn.post do |request|
        request.url &#39;/1/markers&#39;

        request.headers[&#39;Content-Type&#39;] = &#39;application/json&#39;

        request.params = {
          api_key: appsignal_push_api_key,
          name: application_name,
          environment: &#39;production&#39;
        }

        request.body = &lt;&lt;-JSON.strip_heredoc
          {
            &quot;revision&quot;: &quot;#{revision}&quot;,
            &quot;repository&quot;: &quot;master&quot;,
            &quot;user&quot;: &quot;#{username}&quot;
          }
        JSON
      end

      if response.success?
        info &quot;Notified AppSignal of deployment of #{revision}&quot;
      end
    end
  end

  def appsignal_push_api_key<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#appsignal_push_api_key doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV.fetch(&#39;APPSIGNAL_PUSH_API_KEY&#39;, nil)
  end

  def username<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#username doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV[&#39;USER&#39;] || ENV[&#39;USERNAME&#39;] || &#39;unknown&#39;
  end

  def notify_slack
    if slack_webhook
      notifier = Slack::Notifier.new(slack_webhook)
      notifier.ping slack_message, slack_options
    end
  end

  def slack_webhook<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#slack_webhook doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV.fetch(&#39;SLACK_WEBHOOK_URL&#39;, nil)
  end

  def slack_message
    &quot;Deployed revision &lt;#{commit_url}|#{short_revision}&gt; to &lt;#{website_url}&gt;&quot;
  end

  def slack_options
    { channel: &#39;#epetitions&#39;, username: &#39;deploy&#39;, icon_emoji: &#39;:tada:&#39; }
  end

  def pull_request?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#pull_request? doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV.fetch(&#39;TRAVIS_PULL_REQUEST&#39;, &#39;false&#39;) != &#39;false&#39;
  end

  def region<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#region doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV.fetch(&#39;AWS_REGION&#39;, &#39;eu-west-1&#39;)
  end

  def release_bucket
    &quot;epetitions-#{environment}-releases&quot;
  end

  def release_key
    &quot;#{release}.tar.gz&quot;
  end

  def remove_archive
    args = %w[rm]
    args.concat [archive_file]

    info &quot;Removing archive ...&quot;
    Kernel.system *args
  end

  def remove_artifacts
    args = %w[rm -rf]
    args.concat %w[.bundle log tmp]

    info &quot;Removing build artifacts ...&quot;
    Kernel.system *args
  end

  def revision_file
    File.join(archive_path, &#39;REVISION&#39;)
  end

  def short_revision
    revision.first(7)
  end

  def commit_url
    &quot;https://github.com/alphagov/e-petitions/commit/#{revision}&quot;
  end

  def website_url
    if environment == &quot;production&quot;
      &quot;https://petition.parliament.uk/&quot;
    else
      &quot;https://#{environment}.epetitions.website/&quot;
    end
  end

  def skip_build?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#skip_build? doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV.fetch(&#39;SKIP_BUILD&#39;, &#39;0&#39;).to_i.nonzero?
  end

  def skip_gems?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#skip_gems? doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV.fetch(&#39;SKIP_GEMS&#39;, &#39;0&#39;).to_i.nonzero?
  end

  def track_progress(deployment_id, &amp;block)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>PackageBuilder#track_progress has a flog score of 28</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>PackageBuilder#track_progress has approx 11 statements</span>          </div>  </li></ol>
    client = Aws::CodeDeploy::Client.new(credentials)
    completed = false

    while !completed do
      response = client.get_deployment(deployment_id: deployment_id)

      if response.successful?
        deployment = response.deployment_info
        status     = deployment.status
        completed  = !deployment.complete_time.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>PackageBuilder#track_progress performs a nil-check</span>          </div>  </li></ol>

        if completed
          deployment_complete(deployment)
        else
          if status == &quot;InProgress&quot;
            deployment_progress(deployment)
          end

          sleep(5)
        end

        yield deployment if status == &quot;Succeeded&quot;
      else
        raise RuntimeError, &quot;Error getting status for deployment: #{deployment_id}&quot;
      end
    end
  end

  def deployment_complete(deployment)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>PackageBuilder#deployment_complete has approx 6 statements</span>          </div>  </li></ol>
    id           = deployment.deployment_id<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#deployment_complete refers to 'deployment' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L382" class="js-smell-location">0</a>                  <a href="package_builder.html#L383" class="js-smell-location">1</a>                  <a href="package_builder.html#L384" class="js-smell-location">2</a>                  <a href="package_builder.html#L386" class="js-smell-location">3</a>                  </div>  </li></ol>
    created_at   = deployment.create_time<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#deployment_complete refers to 'deployment' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L382" class="js-smell-location">0</a>                  <a href="package_builder.html#L383" class="js-smell-location">1</a>                  <a href="package_builder.html#L384" class="js-smell-location">2</a>                  <a href="package_builder.html#L386" class="js-smell-location">3</a>                  </div>  </li></ol>
    completed_at = deployment.complete_time<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#deployment_complete refers to 'deployment' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L382" class="js-smell-location">0</a>                  <a href="package_builder.html#L383" class="js-smell-location">1</a>                  <a href="package_builder.html#L384" class="js-smell-location">2</a>                  <a href="package_builder.html#L386" class="js-smell-location">3</a>                  </div>  </li></ol>
    duration     = completed_at - created_at
    status       = deployment.status.downcase<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#deployment_complete refers to 'deployment' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L382" class="js-smell-location">0</a>                  <a href="package_builder.html#L383" class="js-smell-location">1</a>                  <a href="package_builder.html#L384" class="js-smell-location">2</a>                  <a href="package_builder.html#L386" class="js-smell-location">3</a>                  </div>  </li></ol>

    info (&quot;Deployment %s %s in %0.2f seconds&quot; % [id, status, duration])
  end

  def deployment_progress(deployment)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>PackageBuilder#deployment_progress has approx 6 statements</span>          </div>  </li></ol>
    id           = deployment.deployment_id<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#deployment_progress refers to 'deployment' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L392" class="js-smell-location">0</a>                  <a href="package_builder.html#L393" class="js-smell-location">1</a>                  <a href="package_builder.html#L395" class="js-smell-location">2</a>                  </div>  </li></ol>
    created_at   = deployment.create_time<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#deployment_progress refers to 'deployment' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L392" class="js-smell-location">0</a>                  <a href="package_builder.html#L393" class="js-smell-location">1</a>                  <a href="package_builder.html#L395" class="js-smell-location">2</a>                  </div>  </li></ol>
    duration     = Time.current - created_at
    overview     = deployment.deployment_overview<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>PackageBuilder#deployment_progress refers to 'deployment' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_builder.html#L392" class="js-smell-location">0</a>                  <a href="package_builder.html#L393" class="js-smell-location">1</a>                  <a href="package_builder.html#L395" class="js-smell-location">2</a>                  </div>  </li></ol>
    progress     = &quot;Pending: %d, InProgress: %d, Succeeded: %d, Failed: %d, Skipped: %d&quot; % overview.values

    info (&quot;Deploying %s (%s) in %0.2f seconds&quot; % [id, progress, duration])
  end

  def treeish<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#treeish doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    ENV[&#39;TAG&#39;] || ENV[&#39;BRANCH&#39;] || &#39;HEAD&#39;
  end

  def write_appspec
    File.write(appspec_file, appspec_yaml)
  end

  def write_scripts<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>PackageBuilder#write_scripts has a flog score of 27</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>PackageBuilder#write_scripts has approx 7 statements</span>          </div>  </li></ol>
    Dir.mkdir(scripts_path) unless Dir.exist?(scripts_path)

    write_script(application_start_script_file, application_start_script)
    write_script(application_stop_script_file, application_stop_script)
    write_script(after_install_script_file, after_install_script)
    write_script(common_functions_script_file, common_functions_script)
    write_script(deregister_from_elb_script_file, deregister_from_elb_script)
    write_script(register_with_elb_script_file, register_with_elb_script)
  end

  def write_script(path, script, mode = 0755)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#write_script doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    File.write(path, script)
    File.new(path).chmod(mode)
  end

  def scripts_path
    File.join(tmpdir, &#39;scripts&#39;)
  end

  def appspec_file
    File.join(tmpdir, &#39;appspec.yml&#39;)
  end

  def appspec_yaml
    &lt;&lt;-FILE.strip_heredoc
      version: 0.0
      os: linux
      files:
        - source: ./source
          destination: /home/deploy/epetitions/releases/#{release}

      hooks:
        ApplicationStop:
          - location: scripts/deregister_from_elb
            runas: root
          - location: scripts/application_stop
            runas: root
        AfterInstall:
          - location: scripts/after_install
            runas: root
        ApplicationStart:
          - location: scripts/application_start
            runas: root
          - location: scripts/register_with_elb
            runas: root
    FILE
  end

  def application_start_script_file
    File.join(tmpdir, &#39;scripts&#39;, &#39;application_start&#39;)
  end

  def application_start_script<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#application_start_script doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    &lt;&lt;-SCRIPT.strip_heredoc
      #!/usr/bin/env bash
      /etc/init.d/epetitions start
    SCRIPT
  end

  def application_stop_script_file
    File.join(tmpdir, &#39;scripts&#39;, &#39;application_stop&#39;)
  end

  def application_stop_script<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#application_stop_script doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    &lt;&lt;-SCRIPT.strip_heredoc
      #!/usr/bin/env bash
      /etc/init.d/epetitions stop || true
    SCRIPT
  end

  def after_install_script_file
    File.join(tmpdir, &#39;scripts&#39;, &#39;after_install&#39;)
  end

  def after_install_script
    &lt;&lt;-SCRIPT.strip_heredoc
      #!/usr/bin/env bash
      chown -R deploy:deploy /home/deploy/epetitions/releases/#{release}

      if [ ! -e /home/deploy/epetitions/releases/#{release}/tmp ]; then
        su - deploy -c &#39;mkdir /home/deploy/epetitions/releases/#{release}/tmp&#39;
      fi

      su - deploy -c &#39;ln -nfs /home/deploy/epetitions/shared/log /home/deploy/epetitions/releases/#{release}/log&#39;
      su - deploy -c &#39;ln -nfs /home/deploy/epetitions/shared/bundle /home/deploy/epetitions/releases/#{release}/vendor/bundle&#39;
      su - deploy -c &#39;ln -nfs /home/deploy/epetitions/shared/assets /home/deploy/epetitions/releases/#{release}/public/assets&#39;
      su - deploy -c &#39;ln -s /home/deploy/epetitions/releases/#{release} /home/deploy/epetitions/current_#{release}&#39;
      su - deploy -c &#39;mv -Tf /home/deploy/epetitions/current_#{release} /home/deploy/epetitions/current&#39;
      su - deploy -c &#39;cd /home/deploy/epetitions/current &amp;&amp; bundle install --without development test --deployment --quiet&#39;
      su - deploy -c &#39;cd /home/deploy/epetitions/current &amp;&amp; bundle exec rake db:migrate&#39;
      su - deploy -c &#39;cd /home/deploy/epetitions/current &amp;&amp; bundle exec rake assets:precompile&#39;

      # Run cron jobs only on workers, as webservers autoscale up and down.
      # ${SERVER_TYPE} is pre-populated for the deploy user by the build scripts
      su - deploy -c &#39;if [ ${SERVER_TYPE} = &quot;worker&quot; ] ; then cd /home/deploy/epetitions/current &amp;&amp; bundle exec whenever -w ; else echo not running whenever ; fi&#39;
    SCRIPT
  end

  def common_functions_script_file
    File.join(tmpdir, &#39;scripts&#39;, &#39;common_functions&#39;)
  end

  def deregister_from_elb_script_file
    File.join(tmpdir, &#39;scripts&#39;, &#39;deregister_from_elb&#39;)
  end

  def register_with_elb_script_file
    File.join(tmpdir, &#39;scripts&#39;, &#39;register_with_elb&#39;)
  end

  def common_functions_script<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#common_functions_script doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    &lt;&lt;-SCRIPT.strip_heredoc
      #!/usr/bin/env bash
      #
      # Copyright 2014 Amazon.com, Inc. or its affiliates. All Rights Reserved.
      #
      # Licensed under the Apache License, Version 2.0 (the &quot;License&quot;).
      # You may not use this file except in compliance with the License.
      # A copy of the License is located at
      #
      #  http://aws.amazon.com/apache2.0
      #
      # or in the &quot;license&quot; file accompanying this file. This file is distributed
      # on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
      # express or implied. See the License for the specific language governing
      # permissions and limitations under the License.

      # ELB_LIST defines which Elastic Load Balancers this instance should be part of.
      ELB_LIST=&quot;$ELB_NAME&quot;

      # Under normal circumstances, you shouldn&#39;t need to change anything below this line.
      # -----------------------------------------------------------------------------

      export PATH=&quot;$PATH:/usr/bin:/usr/local/bin&quot;

      # If true, all messages will be printed. If false, only fatal errors are printed.
      DEBUG=true

      # Number of times to check for a resouce to be in the desired state.
      WAITER_ATTEMPTS=100

      # Number of seconds to wait between attempts for resource to be in a state.
      WAITER_INTERVAL=3

      # AutoScaling Standby features at minimum require this version to work.
      MIN_CLI_VERSION=&#39;1.3.25&#39;

      # Usage: get_instance_region
      #
      #   Writes to STDOUT the AWS region as known by the local instance.
      get_instance_region() {
          if [ -z &quot;$AWS_REGION&quot; ]; then
              AWS_REGION=$(curl -s http://169.254.169.254/latest/dynamic/instance-identity/document \
                  | grep -i region \
                  | awk -F&#39;&quot;&#39; &#39;{print $4}&#39;)
          fi

          echo $AWS_REGION
      }

      AWS_CLI=&quot;aws --region $(get_instance_region)&quot;

      # Usage: autoscaling_group_name &lt;EC2 instance ID&gt;
      #
      #    Prints to STDOUT the name of the AutoScaling group this instance is a part of and returns 0. If
      #    it is not part of any groups, then it prints nothing. On error calling autoscaling, returns
      #    non-zero.
      autoscaling_group_name() {
          local instance_id=$1

          # This operates under the assumption that instances are only ever part of a single ASG.
          local autoscaling_name=$($AWS_CLI autoscaling describe-auto-scaling-instances \
              --instance-ids $instance_id \
              --output text \
              --query AutoScalingInstances[0].AutoScalingGroupName)

          if [ $? != 0 ]; then
              return 1
          elif [ &quot;$autoscaling_name&quot; == &quot;None&quot; ]; then
              echo &quot;&quot;
          else
              echo $autoscaling_name
          fi

          return 0
      }

      # Usage: autoscaling_enter_standby &lt;EC2 instance ID&gt; &lt;ASG name&gt;
      #
      #   Move &lt;EC2 instance ID&gt; into the Standby state in AutoScaling group &lt;ASG name&gt;. Doing so will
      #   pull it out of any Elastic Load Balancer that might be in front of the group.
      #
      #   Returns 0 if the instance was successfully moved to standby. Non-zero otherwise.
      autoscaling_enter_standby() {
          local instance_id=$1
          local asg_name=$2

          msg &quot;Checking if this instance has already been moved in the Standby state&quot;
          local instance_state=$(get_instance_state_asg $instance_id)
          if [ $? != 0 ]; then
              msg &quot;Unable to get this instance&#39;s lifecycle state.&quot;
              return 1
          fi

          if [ &quot;$instance_state&quot; == &quot;Standby&quot; ]; then
              msg &quot;Instance is already in Standby; nothing to do.&quot;
              return 0
          fi

          if [ &quot;$instance_state&quot; == &quot;Pending:Wait&quot; ]; then
              msg &quot;Instance is Pending:Wait; nothing to do.&quot;
              return 0
          fi

          msg &quot;Checking to see if ASG $asg_name will let us decrease desired capacity&quot;
          local min_desired=$($AWS_CLI autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-name $asg_name \
              --query &#39;AutoScalingGroups[0].[MinSize, DesiredCapacity]&#39; \
              --output text)

          local min_cap=$(echo $min_desired | awk &#39;{print $1}&#39;)
          local desired_cap=$(echo $min_desired | awk &#39;{print $2}&#39;)

          if [ -z &quot;$min_cap&quot; -o -z &quot;$desired_cap&quot; ]; then
              msg &quot;Unable to determine minimum and desired capacity for ASG $asg_name.&quot;
              msg &quot;Attempting to put this instance into standby regardless.&quot;
          elif [ $min_cap == $desired_cap -a $min_cap -gt 0 ]; then
              local new_min=$(($min_cap - 1))
              msg &quot;Decrementing ASG $asg_name&#39;s minimum size to $new_min&quot;
              msg $($AWS_CLI autoscaling update-auto-scaling-group \
                  --auto-scaling-group-name $asg_name \
                  --min-size $new_min)
              if [ $? != 0 ]; then
                  msg &quot;Failed to reduce ASG $asg_name&#39;s minimum size to $new_min. Cannot put this instance into Standby.&quot;
                  return 1
              fi
          fi

          msg &quot;Putting instance $instance_id into Standby&quot;
          $AWS_CLI autoscaling enter-standby \
              --instance-ids $instance_id \
              --auto-scaling-group-name $asg_name \
              --should-decrement-desired-capacity
          if [ $? != 0 ]; then
              msg &quot;Failed to put instance $instance_id into Standby for ASG $asg_name.&quot;
              return 1
          fi

          msg &quot;Waiting for move to Standby to finish&quot;
          wait_for_state &quot;autoscaling&quot; $instance_id &quot;Standby&quot;
          if [ $? != 0 ]; then
              local wait_timeout=$(($WAITER_INTERVAL * $WAITER_ATTEMPTS))
              msg &quot;Instance $instance_id did not make it to standby after $wait_timeout seconds&quot;
              return 1
          fi

          return 0
      }

      # Usage: autoscaling_exit_standby &lt;EC2 instance ID&gt; &lt;ASG name&gt;
      #
      #   Attempts to move instance &lt;EC2 instance ID&gt; out of Standby and into InService. Returns 0 if
      #   successful.
      autoscaling_exit_standby() {
          local instance_id=$1
          local asg_name=$2

          msg &quot;Checking if this instance has already been moved out of Standby state&quot;
          local instance_state=$(get_instance_state_asg $instance_id)
          if [ $? != 0 ]; then
              msg &quot;Unable to get this instance&#39;s lifecycle state.&quot;
              return 1
          fi

          if [ &quot;$instance_state&quot; == &quot;InService&quot; ]; then
              msg &quot;Instance is already InService; nothing to do.&quot;
              return 0
          fi

          if [ &quot;$instance_state&quot; == &quot;Pending:Wait&quot; ]; then
              msg &quot;Instance is Pending:Wait; nothing to do.&quot;
              return 0
          fi

          msg &quot;Moving instance $instance_id out of Standby&quot;
          $AWS_CLI autoscaling exit-standby \
              --instance-ids $instance_id \
              --auto-scaling-group-name $asg_name
          if [ $? != 0 ]; then
              msg &quot;Failed to put instance $instance_id back into InService for ASG $asg_name.&quot;
              return 1
          fi

          msg &quot;Waiting for exit-standby to finish&quot;
          wait_for_state &quot;autoscaling&quot; $instance_id &quot;InService&quot;
          if [ $? != 0 ]; then
              local wait_timeout=$(($WAITER_INTERVAL * $WAITER_ATTEMPTS))
              msg &quot;Instance $instance_id did not make it to InService after $wait_timeout seconds&quot;
              return 1
          fi

          return 0
      }

      # Usage: get_instance_state_asg &lt;EC2 instance ID&gt;
      #
      #    Gets the state of the given &lt;EC2 instance ID&gt; as known by the AutoScaling group it&#39;s a part of.
      #    Health is printed to STDOUT and the function returns 0. Otherwise, no output and return is
      #    non-zero.
      get_instance_state_asg() {
          local instance_id=$1

          local state=$($AWS_CLI autoscaling describe-auto-scaling-instances \
              --instance-ids $instance_id \
              --query &quot;AutoScalingInstances[?InstanceId == \&#39;$instance_id\&#39;].LifecycleState | [0]&quot; \
              --output text)
          if [ $? != 0 ]; then
              return 1
          else
              echo $state
              return 0
          fi
      }

      reset_waiter_timeout() {
          local elb=$1

          local health_check_values=$($AWS_CLI elb describe-load-balancers \
              --load-balancer-name $elb \
              --query &#39;LoadBalancerDescriptions[0].HealthCheck.[HealthyThreshold, Interval]&#39; \
              --output text)

          WAITER_ATTEMPTS=$(echo $health_check_values | awk &#39;{print $1}&#39;)
          WAITER_INTERVAL=$(echo $health_check_values | awk &#39;{print $2}&#39;)
      }

      # Usage: wait_for_state &lt;service&gt; &lt;EC2 instance ID&gt; &lt;state name&gt; [ELB name]
      #
      #    Waits for the state of &lt;EC2 instance ID&gt; to be in &lt;state&gt; as seen by &lt;service&gt;. Returns 0 if
      #    it successfully made it to that state; non-zero if not. By default, checks $WAITER_ATTEMPTS
      #    times, every $WAITER_INTERVAL seconds. If giving an [ELB name] to check under, these are reset
      #    to that ELB&#39;s HealthThreshold and Interval values.
      wait_for_state() {
          local service=$1
          local instance_id=$2
          local state_name=$3
          local elb=$4

          local instance_state_cmd
          if [ &quot;$service&quot; == &quot;elb&quot; ]; then
              instance_state_cmd=&quot;get_instance_health_elb $instance_id $elb&quot;
              reset_waiter_timeout $elb
          elif [ &quot;$service&quot; == &quot;autoscaling&quot; ]; then
              instance_state_cmd=&quot;get_instance_state_asg $instance_id&quot;
          else
              msg &quot;Cannot wait for instance state; unknown service type, &#39;$service&#39;&quot;
              return 1
          fi

          msg &quot;Checking $WAITER_ATTEMPTS times, every $WAITER_INTERVAL seconds, for instance $instance_id to be in state $state_name&quot;

          local instance_state=$($instance_state_cmd)
          local count=1

          msg &quot;Instance is currently in state: $instance_state&quot;
          while [ &quot;$instance_state&quot; != &quot;$state_name&quot; ]; do
              if [ $count -ge $WAITER_ATTEMPTS ]; then
                  local timeout=$(($WAITER_ATTEMPTS * $WAITER_INTERVAL))
                  msg &quot;Instance failed to reach state, $state_name within $timeout seconds&quot;
                  return 1
              fi

              sleep $WAITER_INTERVAL

              instance_state=$($instance_state_cmd)
              count=$(($count + 1))
              msg &quot;Instance is currently in state: $instance_state&quot;
          done

          return 0
      }

      # Usage: get_instance_health_elb &lt;EC2 instance ID&gt; &lt;ELB name&gt;
      #
      #    Gets the health of the given &lt;EC2 instance ID&gt; as known by &lt;ELB name&gt;. If it&#39;s a valid health
      #    status (one of InService|OutOfService|Unknown), then the health is printed to STDOUT and the
      #    function returns 0. Otherwise, no output and return is non-zero.
      get_instance_health_elb() {
          local instance_id=$1
          local elb_name=$2

          msg &quot;Checking status of instance &#39;$instance_id&#39; in load balancer &#39;$elb_name&#39;&quot;

          # If describe-instance-health for this instance returns an error, then it&#39;s not part of
          # this ELB. But, if the call was successful let&#39;s still double check that the status is
          # valid.
          local instance_status=$($AWS_CLI elb describe-instance-health \
              --load-balancer-name $elb_name \
              --instances $instance_id \
              --query &#39;InstanceStates[].State&#39; \
              --output text 2&gt;/dev/null)

          if [ $? == 0 ]; then
              case &quot;$instance_status&quot; in
                  InService|OutOfService|Unknown)
                      echo -n $instance_status
                      return 0
                      ;;
                  *)
                      msg &quot;Instance &#39;$instance_id&#39; not part of ELB &#39;$elb_name&#39;&quot;
                      return 1
              esac
          fi
      }

      # Usage: validate_elb &lt;EC2 instance ID&gt; &lt;ELB name&gt;
      #
      #    Validates that the Elastic Load Balancer with name &lt;ELB name&gt; exists, is describable, and
      #    contains &lt;EC2 instance ID&gt; as one of its instances.
      #
      #    If any of these checks are false, the function returns non-zero.
      validate_elb() {
          local instance_id=$1
          local elb_name=$2

          # Get the list of active instances for this LB.
          local elb_instances=$($AWS_CLI elb describe-load-balancers \
              --load-balancer-name $elb_name \
              --query &#39;LoadBalancerDescriptions[*].Instances[*].InstanceId&#39; \
              --output text)
          if [ $? != 0 ]; then
              msg &quot;Couldn&#39;t describe ELB instance named &#39;$elb_name&#39;&quot;
              return 1
          fi

          msg &quot;Checking health of &#39;$instance_id&#39; as known by ELB &#39;$elb_name&#39;&quot;
          local instance_health=$(get_instance_health_elb $instance_id $elb_name)
          if [ $? != 0 ]; then
              return 1
          fi

          return 0
      }

      # Usage: get_elb_list &lt;EC2 instance ID&gt;
      #
      #   Finds all the ELBs that this instance is registered to. After execution, the variable
      #   &quot;INSTANCE_ELBS&quot; will contain the list of load balancers for the given instance.
      #
      #   If the given instance ID isn&#39;t found registered to any ELBs, the function returns non-zero
      get_elb_list() {
          local instance_id=$1

          local elb_list=&quot;&quot;

          local all_balancers=$($AWS_CLI elb describe-load-balancers \
              --query LoadBalancerDescriptions[*].LoadBalancerName \
              --output text | sed -e $&#39;s/\t/ /g&#39;)

          for elb in $all_balancers; do
              local instance_health
              instance_health=$(get_instance_health_elb $instance_id $elb)
              if [ $? == 0 ]; then
                  elb_list=&quot;$elb_list $elb&quot;
              fi
          done

          if [ -z &quot;$elb_list&quot; ]; then
              return 1
          else
              msg &quot;Got load balancer list of: $elb_list&quot;
              INSTANCE_ELBS=$elb_list
              return 0
          fi
      }

      # Usage: deregister_instance &lt;EC2 instance ID&gt; &lt;ELB name&gt;
      #
      #   Deregisters &lt;EC2 instance ID&gt; from &lt;ELB name&gt;.
      deregister_instance() {
          local instance_id=$1
          local elb_name=$2

          $AWS_CLI elb deregister-instances-from-load-balancer \
              --load-balancer-name $elb_name \
              --instances $instance_id 1&gt; /dev/null

          return $?
      }

      # Usage: register_instance &lt;EC2 instance ID&gt; &lt;ELB name&gt;
      #
      #   Registers &lt;EC2 instance ID&gt; to &lt;ELB name&gt;.
      register_instance() {
          local instance_id=$1
          local elb_name=$2

          $AWS_CLI elb register-instances-with-load-balancer \
              --load-balancer-name $elb_name \
              --instances $instance_id 1&gt; /dev/null

          return $?
      }

      # Usage: check_cli_version [version-to-check] [desired version]
      #
      #   Without any arguments, checks that the installed version of the AWS CLI is at least at version
      #   $MIN_CLI_VERSION. Returns non-zero if the version is not high enough.
      check_cli_version() {
          if [ -z $1 ]; then
              version=$($AWS_CLI --version 2&gt;&amp;1 | cut -f1 -d&#39; &#39; | cut -f2 -d/)
          else
              version=$1
          fi

          if [ -z &quot;$2&quot; ]; then
              min_version=$MIN_CLI_VERSION
          else
              min_version=$2
          fi

          x=$(echo $version | cut -f1 -d.)
          y=$(echo $version | cut -f2 -d.)
          z=$(echo $version | cut -f3 -d.)

          min_x=$(echo $min_version | cut -f1 -d.)
          min_y=$(echo $min_version | cut -f2 -d.)
          min_z=$(echo $min_version | cut -f3 -d.)

          msg &quot;Checking minimum required CLI version (${min_version}) against installed version ($version)&quot;

          if [ $x -lt $min_x ]; then
              return 1
          elif [ $y -lt $min_y ]; then
              return 1
          elif [ $y -gt $min_y ]; then
              return 0
          elif [ $z -ge $min_z ]; then
              return 0
          else
              return 1
          fi
      }

      # Usage: msg &lt;message&gt;
      #
      #   Writes &lt;message&gt; to STDERR only if $DEBUG is true, otherwise has no effect.
      msg() {
          local message=$1
          $DEBUG &amp;&amp; echo $message 1&gt;&amp;2
      }

      # Usage: error_exit &lt;message&gt;
      #
      #   Writes &lt;message&gt; to STDERR as a &quot;fatal&quot; and immediately exits the currently running script.
      error_exit() {
          local message=$1

          echo &quot;[FATAL] $message&quot; 1&gt;&amp;2
          exit 1
      }

      # Usage: get_instance_id
      #
      #   Writes to STDOUT the EC2 instance ID for the local instance. Returns non-zero if the local
      #   instance metadata URL is inaccessible.
      get_instance_id() {
          curl -s http://169.254.169.254/latest/meta-data/instance-id
          return $?
      }
    SCRIPT
  end

  def deregister_from_elb_script<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#deregister_from_elb_script doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    &lt;&lt;-SCRIPT.strip_heredoc
      #!/usr/bin/env bash
      #
      # Copyright 2014 Amazon.com, Inc. or its affiliates. All Rights Reserved.
      #
      # Licensed under the Apache License, Version 2.0 (the &quot;License&quot;).
      # You may not use this file except in compliance with the License.
      # A copy of the License is located at
      #
      #  http://aws.amazon.com/apache2.0
      #
      # or in the &quot;license&quot; file accompanying this file. This file is distributed
      # on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
      # express or implied. See the License for the specific language governing
      # permissions and limitations under the License.

      if [ &quot;$SERVER_TYPE&quot; == &quot;worker&quot; ]; then
        msg &quot;Workers are not registered with a load balancer&quot;
        exit 0
      fi

      . $(dirname $0)/common_functions

      msg &quot;Running AWS CLI with region: $(get_instance_region)&quot;

      # get this instance&#39;s ID
      INSTANCE_ID=$(get_instance_id)
      if [ $? != 0 -o -z &quot;$INSTANCE_ID&quot; ]; then
          error_exit &quot;Unable to get this instance&#39;s ID; cannot continue.&quot;
      fi

      # Get current time
      msg &quot;Started $(basename $0) at $(/bin/date &quot;+%F %T&quot;)&quot;
      start_sec=$(/bin/date +%s.%N)

      msg &quot;Checking if instance $INSTANCE_ID is part of an AutoScaling group&quot;
      asg=$(autoscaling_group_name $INSTANCE_ID)
      if [ $? == 0 -a -n &quot;$asg&quot; ]; then
          msg &quot;Found AutoScaling group for instance $INSTANCE_ID: $asg&quot;

          msg &quot;Checking that installed CLI version is at least at version required for AutoScaling Standby&quot;
          check_cli_version
          if [ $? != 0 ]; then
              error_exit &quot;CLI must be at least version ${MIN_CLI_X}.${MIN_CLI_Y}.${MIN_CLI_Z} to work with AutoScaling Standby&quot;
          fi

          msg &quot;Attempting to put instance into Standby&quot;
          autoscaling_enter_standby $INSTANCE_ID $asg
          if [ $? != 0 ]; then
              error_exit &quot;Failed to move instance into standby&quot;
          else
              msg &quot;Instance is in standby&quot;
              exit 0
          fi
      fi

      msg &quot;Instance is not part of an ASG, continuing...&quot;

      msg &quot;Checking that user set at least one load balancer&quot;
      if test -z &quot;$ELB_LIST&quot;; then
          error_exit &quot;Must have at least one load balancer to deregister from&quot;
      fi

      # Loop through all LBs the user set, and attempt to deregister this instance from them.
      for elb in $ELB_LIST; do
          msg &quot;Checking validity of load balancer named &#39;$elb&#39;&quot;
          validate_elb $INSTANCE_ID $elb
          if [ $? != 0 ]; then
              msg &quot;Error validating $elb; cannot continue with this LB&quot;
              continue
          fi

          msg &quot;Deregistering $INSTANCE_ID from $elb&quot;
          deregister_instance $INSTANCE_ID $elb

          if [ $? != 0 ]; then
              error_exit &quot;Failed to deregister instance $INSTANCE_ID from ELB $elb&quot;
          fi
      done

      # Wait for all Deregistrations to finish
      msg &quot;Waiting for instance to de-register from its load balancers&quot;
      for elb in $ELB_LIST; do
          wait_for_state &quot;elb&quot; $INSTANCE_ID &quot;OutOfService&quot; $elb
          if [ $? != 0 ]; then
              error_exit &quot;Failed waiting for $INSTANCE_ID to leave $elb&quot;
          fi
      done

      msg &quot;Finished $(basename $0) at $(/bin/date &quot;+%F %T&quot;)&quot;

      end_sec=$(/bin/date +%s.%N)
      elapsed_seconds=$(echo &quot;$end_sec - $start_sec&quot; | /usr/bin/bc)

      msg &quot;Elapsed time: $elapsed_seconds&quot;
    SCRIPT
  end

  def register_with_elb_script<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>PackageBuilder#register_with_elb_script doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    &lt;&lt;-SCRIPT.strip_heredoc
      #!/usr/bin/env bash
      #
      # Copyright 2014 Amazon.com, Inc. or its affiliates. All Rights Reserved.
      #
      # Licensed under the Apache License, Version 2.0 (the &quot;License&quot;).
      # You may not use this file except in compliance with the License.
      # A copy of the License is located at
      #
      #  http://aws.amazon.com/apache2.0
      #
      # or in the &quot;license&quot; file accompanying this file. This file is distributed
      # on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
      # express or implied. See the License for the specific language governing
      # permissions and limitations under the License.

      if [ &quot;$SERVER_TYPE&quot; == &quot;worker&quot; ]; then
        msg &quot;Workers are not registered with a load balancer&quot;
        exit 0
      fi

      . $(dirname $0)/common_functions

      msg &quot;Running AWS CLI with region: $(get_instance_region)&quot;

      # get this instance&#39;s ID
      INSTANCE_ID=$(get_instance_id)
      if [ $? != 0 -o -z &quot;$INSTANCE_ID&quot; ]; then
          error_exit &quot;Unable to get this instance&#39;s ID; cannot continue.&quot;
      fi

      # Get current time
      msg &quot;Started $(basename $0) at $(/bin/date &quot;+%F %T&quot;)&quot;
      start_sec=$(/bin/date +%s.%N)

      msg &quot;Checking if instance $INSTANCE_ID is part of an AutoScaling group&quot;
      asg=$(autoscaling_group_name $INSTANCE_ID)
      if [ $? == 0 -a -n &quot;$asg&quot; ]; then
          msg &quot;Found AutoScaling group for instance $INSTANCE_ID: $asg&quot;

          msg &quot;Checking that installed CLI version is at least at version required for AutoScaling Standby&quot;
          check_cli_version
          if [ $? != 0 ]; then
              error_exit &quot;CLI must be at least version ${MIN_CLI_X}.${MIN_CLI_Y}.${MIN_CLI_Z} to work with AutoScaling Standby&quot;
          fi

          msg &quot;Attempting to move instance out of Standby&quot;
          autoscaling_exit_standby $INSTANCE_ID $asg
          if [ $? != 0 ]; then
              error_exit &quot;Failed to move instance out of standby&quot;
          else
              msg &quot;Instance is no longer in Standby&quot;
              exit 0
          fi
      fi

      msg &quot;Instance is not part of an ASG, continuing...&quot;

      msg &quot;Checking that user set at least one load balancer&quot;
      if test -z &quot;$ELB_LIST&quot;; then
          error_exit &quot;Must have at least one load balancer to deregister from&quot;
      fi

      # Loop through all LBs the user set, and attempt to register this instance to them.
      for elb in $ELB_LIST; do
          msg &quot;Checking validity of load balancer named &#39;$elb&#39;&quot;
          validate_elb $INSTANCE_ID $elb
          if [ $? != 0 ]; then
              msg &quot;Error validating $elb; cannot continue with this LB&quot;
              continue
          fi

          msg &quot;Registering $INSTANCE_ID to $elb&quot;
          register_instance $INSTANCE_ID $elb

          if [ $? != 0 ]; then
              error_exit &quot;Failed to register instance $INSTANCE_ID from ELB $elb&quot;
          fi
      done

      # Wait for all Registrations to finish
      msg &quot;Waiting for instance to register to its load balancers&quot;
      for elb in $ELB_LIST; do
          wait_for_state &quot;elb&quot; $INSTANCE_ID &quot;InService&quot; $elb
          if [ $? != 0 ]; then
              error_exit &quot;Failed waiting for $INSTANCE_ID to return to $elb&quot;
          fi
      done

      msg &quot;Finished $(basename $0) at $(/bin/date &quot;+%F %T&quot;)&quot;

      end_sec=$(/bin/date +%s.%N)
      elapsed_seconds=$(echo &quot;$end_sec - $start_sec&quot; | /usr/bin/bc)

      msg &quot;Elapsed time: $elapsed_seconds&quot;
    SCRIPT
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- JavaScripts -->
    <script src='../assets/javascripts/jquery.min.js'></script>
    <script src='../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../assets/javascripts/jquery.timeago.js'></script>
    <script src='../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../assets/javascripts/prettify.js'></script>
    <script src='../assets/javascripts/bootstrap.min.js'></script>
    <script src='../assets/javascripts/application.js'></script>
    <script src='../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../overview.html"><img src="../../assets/images/logo.png" alt="Ruby Critic Logo" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
      
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2019-07-17 16:30:32 +0100'>2019-07-17 16:30:32 +0100</time>
        
      </span>
    </div>
    <div>
      <h3><small>app/models /</small> petition.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">893</span><small> lines of codes</small></div>
              <div><span class="metric">151</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">5.2</span><small> complexity/method</small></div>
              <div><span class="metric">191</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">786.22</span><small> complexity</small></div>
              <div><span class="metric">83</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                50
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;textacular/searchable&#39;

class Petition &lt; ActiveRecord::Base<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Petition assumes too much for instance variable '@moderation'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Petition has no descriptive comment</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Constants.md" target="_blank"><b>TooManyConstants</b></a>        </span>      </div>      <span>Petition has 23 constants</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Methods.md" target="_blank"><b>TooManyMethods</b></a>        </span>      </div>      <span>Petition has at least 151 methods</span>          </div>  </li></ol>
  include PerishableTokenGenerator

  PENDING_STATE     = &#39;pending&#39;
  VALIDATED_STATE   = &#39;validated&#39;
  SPONSORED_STATE   = &#39;sponsored&#39;
  FLAGGED_STATE     = &#39;flagged&#39;
  OPEN_STATE        = &#39;open&#39;
  CLOSED_STATE      = &#39;closed&#39;
  REJECTED_STATE    = &#39;rejected&#39;
  HIDDEN_STATE      = &#39;hidden&#39;
  STOPPED_STATE     = &#39;stopped&#39;

  STATES            = %w[pending validated sponsored flagged open closed rejected hidden stopped]
  DEBATABLE_STATES  = %w[open closed]
  VISIBLE_STATES    = %w[open closed rejected]
  SHOW_STATES       = %w[pending validated sponsored flagged open closed rejected stopped]
  MODERATED_STATES  = %w[open closed hidden rejected]
  PUBLISHED_STATES  = %w[open closed]
  SELECTABLE_STATES = %w[open closed rejected hidden]
  SEARCHABLE_STATES = %w[open closed rejected]
  STOPPABLE_STATES  = %w[pending validated sponsored flagged]

  IN_MODERATION_STATES       = %w[sponsored flagged]
  TODO_LIST_STATES           = %w[pending validated sponsored flagged]
  COLLECTING_SPONSORS_STATES = %w[pending validated]
  STOP_COLLECTING_STATES     = %w[pending validated sponsored flagged]

  DEBATE_STATES = %w[pending awaiting scheduled debated not_debated]

  has_perishable_token called: &#39;sponsor_token&#39;

  before_save :update_debate_state, if: :scheduled_debate_date_changed?
  before_save :update_moderation_lag, unless: :moderation_lag?
  after_create :update_last_petition_created_at

  extend Searchable(:action, :background, :additional_details)
  include Browseable, Taggable

  facet :all,      -&gt; { by_most_popular }
  facet :open,     -&gt; { open_state.by_most_popular }
  facet :rejected, -&gt; { rejected_state.by_most_recent }
  facet :closed,   -&gt; { closed_state.by_most_popular }
  facet :hidden,   -&gt; { hidden_state.by_most_recent }
  facet :stopped,  -&gt; { stopped_state.by_most_recent }

  facet :awaiting_response,    -&gt; { awaiting_response.by_waiting_for_response_longest }
  facet :with_response,        -&gt; { with_response.by_most_recent_response }

  facet :awaiting_debate,      -&gt; { awaiting_debate.by_most_relevant_debate_date }
  facet :awaiting_debate_date, -&gt; { awaiting_debate_date.by_waiting_for_debate_longest }
  facet :with_debate_outcome,  -&gt; { with_debate_outcome.by_most_recent_debate_outcome }
  facet :with_debated_outcome, -&gt; { with_debated_outcome.by_most_recent_debate_outcome }
  facet :debated,              -&gt; { debated.by_most_recent_debate_outcome }
  facet :not_debated,          -&gt; { not_debated.by_most_recent_debate_outcome }

  facet :collecting_sponsors,  -&gt; { collecting_sponsors.by_most_recent }
  facet :in_moderation,        -&gt; { in_moderation.by_most_recent_moderation_threshold_reached }
  facet :in_debate_queue,      -&gt; { in_debate_queue.by_waiting_for_debate_longest }

  facet :recently_in_moderation,       -&gt; { recently_in_moderation.by_most_recent_moderation_threshold_reached }
  facet :nearly_overdue_in_moderation, -&gt; { nearly_overdue_in_moderation.by_most_recent_moderation_threshold_reached }
  facet :overdue_in_moderation,        -&gt; { overdue_in_moderation.by_most_recent_moderation_threshold_reached }
  facet :tagged_in_moderation,         -&gt; { tagged_in_moderation.by_most_recent_moderation_threshold_reached }
  facet :untagged_in_moderation,       -&gt; { untagged_in_moderation.by_most_recent_moderation_threshold_reached }

  has_one :creator, -&gt; { creator }, class_name: &#39;Signature&#39;
  accepts_nested_attributes_for :creator, update_only: true

  belongs_to :locked_by, class_name: &#39;AdminUser&#39;

  has_one :debate_outcome, dependent: :destroy
  has_one :email_requested_receipt, dependent: :destroy
  has_one :government_response, dependent: :destroy
  has_one :note, dependent: :destroy
  has_one :rejection, dependent: :destroy
  has_one :statistics, dependent: :destroy

  has_many :signatures
  has_many :sponsors, -&gt; { sponsors }, class_name: &#39;Signature&#39;
  has_many :country_petition_journals, dependent: :destroy
  has_many :constituency_petition_journals, dependent: :destroy
  has_many :emails, dependent: :destroy
  has_many :invalidations
  has_many :trending_ips, dependent: :delete_all
  has_many :trending_domains, dependent: :delete_all

  validates :action, presence: true, length: { maximum: 80, allow_blank: true }
  validates :background, presence: true, length: { maximum: 300, allow_blank: true }
  validates :additional_details, length: { maximum: 800, allow_blank: true }
  validates :open_at, presence: true, if: :open?
  validates :creator, presence: true
  validates :state, inclusion: { in: STATES }

  with_options allow_nil: true, prefix: true do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/petition.html#L64" class="js-smell-location">0</a>                  <a href="petition.html#L97" class="js-smell-location">1</a>                  </div>  </li></ol>
    delegate :name, :email, to: :creator
    delegate :code, :details, to: :rejection
    delegate :summary, :details, :created_at, :updated_at, to: :government_response
    delegate :date, :transcript_url, :video_url, :overview, to: :debate_outcome, prefix: :debate
    delegate :debate_pack_url, to: :debate_outcome, prefix: false
  end

  alias_attribute :opened_at, :open_at

  class &lt;&lt; self
    def by_most_popular
      reorder(signature_count: :desc, created_at: :desc)
    end

    def by_most_recent
      reorder(created_at: :desc)
    end

    def by_most_recent_debate_outcome
      reorder(debate_outcome_at: :desc, created_at: :desc)
    end

    def by_most_recent_moderation_threshold_reached
      reorder(moderation_threshold_reached_at: :desc, created_at: :desc)
    end

    def by_most_recent_response
      reorder(government_response_at: :desc, created_at: :desc)
    end

    def by_most_relevant_debate_date
      reorder(&#39;scheduled_debate_date ASC NULLS LAST, debate_threshold_reached_at ASC NULLS FIRST&#39;)
    end

    def by_oldest
      reorder(created_at: :asc)
    end

    def by_waiting_for_debate_longest
      reorder(debate_threshold_reached_at: :asc, created_at: :desc)
    end

    def by_waiting_for_response_longest
      reorder(response_threshold_reached_at: :asc, created_at: :desc)
    end

    def current
      open_state.by_most_recent
    end

    def open_state
      where(state: OPEN_STATE)
    end

    def closed_state
      where(state: CLOSED_STATE)
    end

    def hidden_state
      where(state: HIDDEN_STATE)
    end

    def rejected_state
      where(state: REJECTED_STATE)
    end

    def sponsored_state
      where(state: SPONSORED_STATE)
    end

    def stopped_state
      where(state: STOPPED_STATE)
    end

    def awaiting_debate
      where(debate_state: %w[awaiting scheduled])
    end

    def awaiting_debate_date
      debate_threshold_reached.not_scheduled
    end

    def awaiting_response
      response_threshold_reached.not_responded
    end

    def collecting_sponsors
      where(state: COLLECTING_SPONSORS_STATES)
    end

    def debate_threshold_reached
      where.not(debate_threshold_reached_at: nil)
    end

    def debateable
      where(state: DEBATABLE_STATES)
    end

    def debated
      where(debate_state: &#39;debated&#39;).preload(:debate_outcome)
    end

    def for_state(state)
      where(state: state)
    end

    def in_debate_queue
      where(threshold_for_debate_reached.or(scheduled_for_debate))
    end

    def in_moderation(from: nil, to: nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Petition::in_moderation has a flog score of 27</span>          </div>  </li></ol>
      if from &amp;&amp; to
        where(state: IN_MODERATION_STATES).where(moderation_threshold_reached_at.between(from..to))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#in_moderation calls 'where(state: IN_MODERATION_STATES)' 4 times</span>              <span>Locations:</span>                  <a href="petition.html#L210" class="js-smell-location">0</a>                  <a href="petition.html#L212" class="js-smell-location">1</a>                  <a href="petition.html#L214" class="js-smell-location">2</a>                  <a href="petition.html#L216" class="js-smell-location">3</a>                  </div>  </li></ol>
      elsif from
        where(state: IN_MODERATION_STATES).where(moderation_threshold_reached_at.gt(from))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#in_moderation calls 'where(state: IN_MODERATION_STATES)' 4 times</span>              <span>Locations:</span>                  <a href="petition.html#L210" class="js-smell-location">0</a>                  <a href="petition.html#L212" class="js-smell-location">1</a>                  <a href="petition.html#L214" class="js-smell-location">2</a>                  <a href="petition.html#L216" class="js-smell-location">3</a>                  </div>  </li></ol>
      elsif to
        where(state: IN_MODERATION_STATES).where(moderation_threshold_reached_at.lt(to))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#in_moderation calls 'where(state: IN_MODERATION_STATES)' 4 times</span>              <span>Locations:</span>                  <a href="petition.html#L210" class="js-smell-location">0</a>                  <a href="petition.html#L212" class="js-smell-location">1</a>                  <a href="petition.html#L214" class="js-smell-location">2</a>                  <a href="petition.html#L216" class="js-smell-location">3</a>                  </div>  </li></ol>
      else
        where(state: IN_MODERATION_STATES)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#in_moderation calls 'where(state: IN_MODERATION_STATES)' 4 times</span>              <span>Locations:</span>                  <a href="petition.html#L210" class="js-smell-location">0</a>                  <a href="petition.html#L212" class="js-smell-location">1</a>                  <a href="petition.html#L214" class="js-smell-location">2</a>                  <a href="petition.html#L216" class="js-smell-location">3</a>                  </div>  </li></ol>
      end
    end

    def moderated
      where(state: MODERATED_STATES)
    end

    def not_debated
      where(debate_state: &#39;not_debated&#39;)
    end

    def not_hidden
      where.not(state: HIDDEN_STATE)
    end

    def not_responded
      where(government_response_at: nil)
    end

    def not_scheduled
      where(scheduled_debate_date: nil)
    end

    def respondable
      where(state: RESPONDABLE_STATES)
    end

    def response_threshold_reached
      where.not(response_threshold_reached_at: nil)
    end

    def selectable
      where(state: SELECTABLE_STATES)
    end

    def stoppable
      where(state: STOPPABLE_STATES)
    end

    def show
      where(state: SHOW_STATES)
    end

    def threshold
      where(arel_table[:signature_count].gteq(Site.threshold_for_debate))
    end

    def todo_list
      where(state: TODO_LIST_STATES)
    end

    def visible
      where(state: VISIBLE_STATES)
    end

    def with_debate_outcome
      where.not(debate_outcome_at: nil)
    end

    def with_debated_outcome
      debated.where.not(debate_outcome_at: nil)
    end

    def with_response
      where.not(government_response_at: nil).preload(:government_response)
    end

    def trending(since = 1.hour.ago, limit = 3)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Petition::trending has a flog score of 26</span>          </div>  </li></ol>
      select(&#39;petitions.*, COUNT(signatures.id) AS signature_count_in_period&#39;).
      joins(:signatures).
      where(&#39;petitions.state = ?&#39;, OPEN_STATE).
      where(&#39;petitions.last_signed_at &gt; ?&#39;, since).
      where(&#39;signatures.validated_at &gt; ?&#39;, since).
      where(&#39;signatures.invalidated_at IS NULL&#39;).
      group(&#39;petitions.id&#39;).order(&#39;signature_count_in_period DESC&#39;).
      limit(limit)
    end

    def close_petitions!(time = Time.current)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'close_petitions!'</span>          </div>  </li></ol>
      in_need_of_closing(time).find_each do |petition|
        petition.close!
      end
    end

    def close_petitions_early!(time = Parliament.dissolution_at)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'close_petitions_early!'</span>          </div>  </li></ol>
      open_at_dissolution(time).find_each do |petition|
        petition.close!(time)
      end
    end

    def stop_petitions_early!(time = Parliament.dissolution_at)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'stop_petitions_early!'</span>          </div>  </li></ol>
      in_need_of_stopping.find_each do |petition|
        petition.stop!(time)
      end
    end

    def in_need_of_closing(time = Time.current)
      where(state: OPEN_STATE).where(arel_table[:open_at].lt(Site.opened_at_for_closing(time)))
    end

    def in_need_of_stopping(time = nil)
      scope = preload(:creator)
      time ? scope.stoppable.created_after(time) : scope.stoppable<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#in_need_of_stopping calls 'scope.stoppable' 2 times</span>          </div>  </li></ol>
    end

    def created_after(time)
      where(arel_table[:created_at].gteq(time))
    end

    def open_at_dissolution(dissolution_at = Parliament.dissolution_at)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Petition::open_at_dissolution has a flog score of 45</span>          </div>  </li></ol>
      if dissolution_at
        opened_at_for_closing = Site.opened_at_for_closing(dissolution_at)

        where(
          arel_table[:state].eq(OPEN_STATE).
          and(arel_table[:open_at].gteq(opened_at_for_closing).
          and(arel_table[:closed_at].eq(nil)).<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#open_at_dissolution calls 'arel_table[:closed_at]' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L333" class="js-smell-location">0</a>                  <a href="petition.html#L334" class="js-smell-location">1</a>                  </div>  </li></ol>
          or(arel_table[:closed_at].gteq(dissolution_at)))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#open_at_dissolution calls 'arel_table[:closed_at]' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L333" class="js-smell-location">0</a>                  <a href="petition.html#L334" class="js-smell-location">1</a>                  </div>  </li></ol>
        )
      else
        none
      end
    end

    def popular_in_constituency(constituency_id, count = 50)
      popular_in(constituency_id, count).for_state(OPEN_STATE)
    end

    def all_popular_in_constituency(constituency_id, count = 50)
      popular_in(constituency_id, count).for_state(PUBLISHED_STATES)
    end

    def sanitized_tag(tag)
      &quot;[#{tag.gsub(/[\[\]%]/,&#39;&#39;)}]&quot;
    end

    def in_need_of_marking_as_debated(date = Date.current)
      where(scheduled_debate_state.and(debate_date_in_the_past(date)))
    end

    def mark_petitions_as_debated!(date = Date.current)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'mark_petitions_as_debated!'</span>          </div>  </li></ol>
      in_need_of_marking_as_debated(date).update_all(debate_state: &#39;debated&#39;)
    end

    def unarchived
      where(archived_at: nil)
    end

    def recently_in_moderation
      in_moderation(from: moderation_near_overdue_at)
    end

    def nearly_overdue_in_moderation
      in_moderation(from: moderation_overdue_at, to: moderation_near_overdue_at)
    end

    def overdue_in_moderation
      in_moderation(to: moderation_overdue_at)
    end

    def tagged_in_moderation
      tagged.in_moderation
    end

    def untagged_in_moderation
      untagged.in_moderation
    end

    def signed_since(timestamp)
      where(arel_table[:last_signed_at].gt(timestamp))
    end

    def in_need_of_validating
      where(grouping(last_signed_at.gt(signature_count_validated_at)).eq(true))
    end

    private

    def grouping(expression)
      Arel::Nodes::Grouping.new(expression)
    end

    def last_signed_at
      arel_table[:last_signed_at]
    end

    def signature_count_validated_at
      arel_table[:signature_count_validated_at]
    end

    def moderation_threshold_reached_at
      arel_table[:moderation_threshold_reached_at]
    end

    def moderation_near_overdue_at
      Site.moderation_near_overdue_in_days.ago
    end

    def moderation_overdue_at
      Site.moderation_overdue_in_days.ago
    end

    def popular_in(constituency_id, count)
      klass = ConstituencyPetitionJournal
      constituency_signature_count = klass.arel_table[:signature_count].as(&#39;constituency_signature_count&#39;)
      constituency_signatures_for = klass.with_signatures_for(constituency_id).ordered

      select(arel_table[Arel.star], constituency_signature_count).
      joins(:constituency_petition_journals).
      merge(constituency_signatures_for).
      limit(count)
    end

    def threshold_for_debate_reached
      arel_table[:debate_threshold_reached_at].not_eq(nil)
    end

    def scheduled_for_debate
      arel_table[:scheduled_debate_date].not_eq(nil)
    end

    def awaiting_debate_state
      arel_table[:debate_state].eq(&#39;awaiting&#39;)
    end

    def debate_date_in_the_past(date)
      arel_table[:scheduled_debate_date].lt(date)
    end

    def scheduled_debate_state
      arel_table[:debate_state].eq(&#39;scheduled&#39;)
    end
  end

  def statistics
    super || create_statistics!
  end

  def reset_signature_count!(time = Time.current)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'reset_signature_count!'</span>          </div>  </li></ol>
    update_column(:signature_count_reset_at, time)
    update_signature_count!(time)
    ConstituencyPetitionJournal.reset_signature_counts_for(self)
    CountryPetitionJournal.reset_signature_counts_for(self)
    update_column(:signature_count_reset_at, nil)
  end

  def update_signature_count!(time = Time.current)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'update_signature_count!'</span>          </div>  </li></ol>
    sql = &quot;signature_count = ?, last_signed_at = ?, updated_at = ?&quot;
    count = signatures.validated_count(nil, time)

    if update_all([sql, count, time, time]) &gt; 0
      self.reload
    end
  end

  def increment_signature_count!(time = Time.current)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Petition#increment_signature_count! has a flog score of 35</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'increment_signature_count!'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Petition#increment_signature_count! has approx 14 statements</span>          </div>  </li></ol>
    sql = &quot;signature_count = signature_count + ?, last_signed_at = ?, updated_at = ?&quot;
    count = signatures.validated_count(last_signed_at, time)

    return false if count.zero?

    if result = update_all([sql, count, time, time]) &gt; 0
      self.reload<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#increment_signature_count! calls 'self.reload' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L479" class="js-smell-location">0</a>                  <a href="petition.html#L503" class="js-smell-location">1</a>                  </div>  </li></ol>

      updates = []

      if at_threshold_for_moderation? &amp;&amp; collecting_sponsors?
        updates &lt;&lt; &quot;state = &#39;#{SPONSORED_STATE}&#39;&quot;
        updates &lt;&lt; &quot;moderation_threshold_reached_at = :now&quot;
      elsif pending?
        updates &lt;&lt; &quot;state = &#39;#{VALIDATED_STATE}&#39;&quot;
      end

      if at_threshold_for_response?
        updates &lt;&lt; &quot;response_threshold_reached_at = :now&quot;
      end

      if at_threshold_for_debate?
        updates &lt;&lt; &quot;debate_threshold_reached_at = :now&quot;
        updates &lt;&lt; &quot;debate_state = &#39;awaiting&#39;&quot;
      end

      updates = updates.join(&quot;, &quot;)

      if updates.present?
        if update_all([updates, now: time]) &gt; 0
          self.reload<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#increment_signature_count! calls 'self.reload' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L479" class="js-smell-location">0</a>                  <a href="petition.html#L503" class="js-smell-location">1</a>                  </div>  </li></ol>
        end
      end
    end

    result
  end

  def decrement_signature_count!(time = Time.current)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'decrement_signature_count!'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Petition#decrement_signature_count! has approx 7 statements</span>          </div>  </li></ol>
    updates = &quot;&quot;

    if below_threshold_for_debate?
      updates &lt;&lt; &quot;debate_threshold_reached_at = NULL, &quot;
      updates &lt;&lt; &quot;debate_state = &#39;pending&#39;, &quot;
    end

    if below_threshold_for_response?
      updates &lt;&lt; &quot;response_threshold_reached_at = NULL, &quot;
    end

    updates &lt;&lt; &quot;signature_count = greatest(signature_count - 1, 1), &quot;
    updates &lt;&lt; &quot;updated_at = :now&quot;

    if update_all([updates, now: time]) &gt; 0
      self.reload
    end
  end

  def signature_count_difference
    signature_count - signatures.validated_count(nil, last_signed_at)
  end

  def valid_signature_count?
    signature_count_difference.zero?
  end

  def valid_signature_count!<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'valid_signature_count!'</span>          </div>  </li></ol>
    valid_signature_count? &amp;&amp; touch(:signature_count_validated_at)
  end

  def will_reach_threshold_for_moderation?
    unless moderation_threshold_reached_at?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Petition tests 'moderation_threshold_reached_at?' at least 3 times</span>              <span>Locations:</span>                  <a href="petition.html#L544" class="js-smell-location">0</a>                  <a href="petition.html#L550" class="js-smell-location">1</a>                  <a href="petition.html#L887" class="js-smell-location">2</a>                  </div>  </li></ol>
      signature_count &gt;= Site.threshold_for_moderation
    end
  end

  def at_threshold_for_moderation?
    unless moderation_threshold_reached_at?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Petition tests 'moderation_threshold_reached_at?' at least 3 times</span>              <span>Locations:</span>                  <a href="petition.html#L544" class="js-smell-location">0</a>                  <a href="petition.html#L550" class="js-smell-location">1</a>                  <a href="petition.html#L887" class="js-smell-location">2</a>                  </div>  </li></ol>
      signature_count &gt;= Site.threshold_for_moderation + 1
    end
  end

  def at_threshold_for_response?
    unless response_threshold_reached_at?
      signature_count &gt;= Site.threshold_for_response - 1
    end
  end

  def at_threshold_for_debate?
    unless debate_threshold_reached_at?
      signature_count &gt;= Site.threshold_for_debate - 1
    end
  end

  def below_threshold_for_response?
    if response_threshold_reached_at?
      signature_count &lt;= Site.threshold_for_response
    end
  end

  def below_threshold_for_debate?
    if debate_threshold_reached_at?
      signature_count &lt;= Site.threshold_for_debate
    end
  end

  def signatures_by_country
    country_petition_journals.joins(:location).preload(:location).to_a.sort_by(&amp;:name)
  end

  def signatures_by_constituency
    constituency_petition_journals.preload(:constituency).to_a.sort_by(&amp;:constituency_id)
  end

  def approve?
    moderation == &#39;approve&#39;
  end

  def reject?
    moderation == &#39;reject&#39;
  end

  def flag?
    moderation == &#39;flag&#39;
  end

  def moderation=(value)
    @moderation = value if value.in?(%w[approve reject flag])
  end

  def moderation
    @moderation
  end

  def moderate(params)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Petition#moderate has approx 6 statements</span>          </div>  </li></ol>
    self.moderation = params[:moderation]

    if approve?
      publish
    elsif reject?
      reject(params[:rejection])
    elsif flag?
      flag
    else
      errors.add :moderation, :blank
      false
    end
  end

  def publish(time = Time.current)
    update(state: OPEN_STATE, open_at: time)
  end

  def reject(attributes)
    begin
      build_rejection(attributes) &amp;&amp; rejection.save
    rescue ActiveRecord::RecordNotUnique =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Petition#reject has the variable name 'e'</span>          </div>  </li></ol>
      rejection(true).update(attributes)
    end
  end

  def flag
    update(state: FLAGGED_STATE)
  end

  def rejection(*args)
    super || build_rejection
  end

  def close!(time = deadline)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'close!'</span>          </div>  </li></ol>
    if open?
      update!(state: CLOSED_STATE, closed_at: time)
    else
      raise RuntimeError, &quot;can&#39;t stop a petition that is in the #{state} state&quot;
    end
  end

  def stop!(time = Time.current)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'stop!'</span>          </div>  </li></ol>
    if state.in?(STOPPABLE_STATES)
      update!(state: STOPPED_STATE, stopped_at: time)
    else
      raise RuntimeError, &quot;can&#39;t stop a petition that is in the #{state} state&quot;
    end
  end

  def validate_creator!(now = Time.current)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'validate_creator!'</span>          </div>  </li></ol>
    if pending?
      # Set the validated_at time to 1 second ago so that if
      # the signature count update runs for it then it won&#39;t
      # prevent this signature being missed.
      creator &amp;&amp; creator.validate!(1.second.ago(now)) &amp;&amp; reload
    end
  end

  def count_validated_signatures
    signatures.validated.count
  end

  def collecting_sponsors?
    state.in?(COLLECTING_SPONSORS_STATES)
  end

  def awaiting_moderation?
    state == VALIDATED_STATE
  end

  def in_moderation?
    state.in?(IN_MODERATION_STATES)
  end

  def moderated?
    state.in?(MODERATED_STATES)
  end

  def open?
    state == OPEN_STATE
  end
  alias_method :can_be_signed?, :open?

  def rejected?
    state == REJECTED_STATE
  end

  def hidden?
    state == HIDDEN_STATE
  end

  def closed?
    state == CLOSED_STATE
  end

  def stopped?
    state == STOPPED_STATE
  end

  def flagged?
    state == FLAGGED_STATE
  end

  def pending?
    state == PENDING_STATE
  end

  def validated?
    state == VALIDATED_STATE
  end

  def published?
    state.in?(PUBLISHED_STATES)
  end

  def visible?
    state.in?(VISIBLE_STATES)
  end

  def closed_for_signing?(now = Time.current)
    rejected? || closed_at? &amp;&amp; closed_at &lt; 24.hours.ago(now)
  end

  def archiving?
    archiving_started_at? &amp;&amp; !archived_at?
  end

  def archived?
    archived_at?
  end

  def editing_disabled?
    archiving_started_at? || archived_at?
  end

  def update_lock!(user, now = Time.current)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Petition takes parameters ['now', 'user'] to 3 methods</span>              <span>Locations:</span>                  <a href="petition.html#L744" class="js-smell-location">0</a>                  <a href="petition.html#L750" class="js-smell-location">1</a>                  <a href="petition.html#L760" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'update_lock!'</span>          </div>  </li></ol>
    if locked_by == user<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Control-Parameter.md" target="_blank"><b>ControlParameter</b></a>        </span>      </div>      <span>Petition#update_lock! is controlled by argument 'user'</span>          </div>  </li></ol>
      update!(locked_at: now)
    end
  end

  def checkout!(user, now = Time.current)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/petition.html#L318" class="js-smell-location">0</a>                  <a href="petition.html#L750" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Petition takes parameters ['now', 'user'] to 3 methods</span>              <span>Locations:</span>                  <a href="petition.html#L744" class="js-smell-location">0</a>                  <a href="petition.html#L750" class="js-smell-location">1</a>                  <a href="petition.html#L760" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'checkout!'</span>          </div>  </li></ol>
    with_lock do
      if locked_by.present? &amp;&amp; locked_by != user
        false
      else
        update!(locked_by: user, locked_at: now)
      end
    end
  end

  def force_checkout!(user, now = Time.current)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Petition takes parameters ['now', 'user'] to 3 methods</span>              <span>Locations:</span>                  <a href="petition.html#L744" class="js-smell-location">0</a>                  <a href="petition.html#L750" class="js-smell-location">1</a>                  <a href="petition.html#L760" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'force_checkout!'</span>          </div>  </li></ol>
    update!(locked_by: user, locked_at: now)
  end

  def release!(user)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="archived/petition.html#L332" class="js-smell-location">0</a>                  <a href="petition.html#L764" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'release!'</span>          </div>  </li></ol>
    with_lock do
      if locked_by.present? &amp;&amp; locked_by == user<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Control-Parameter.md" target="_blank"><b>ControlParameter</b></a>        </span>      </div>      <span>Petition#release! is controlled by argument 'user'</span>          </div>  </li></ol>
        update!(locked_by: nil, locked_at: nil)
      end
    end
  end

  def can_have_debate_added?
    state.in?(DEBATABLE_STATES)
  end

  def in_todo_list?
    state.in?(TODO_LIST_STATES)
  end

  def government_response?
    government_response_at? &amp;&amp; government_response
  end

  def debate_outcome?
    debate_outcome_at? &amp;&amp; debate_outcome
  end

  def deadline
    open_at &amp;&amp; (closed_at || Site.closed_at_for_opening(open_at))
  end

  def closing_early_for_dissolution?(dissolution_at = Parliament.dissolution_at)
    open_at &amp;&amp; dissolution_at ? deadline &gt; dissolution_at : false
  end

  def cache_key(*timestamp_names)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Petition#cache_key has a flog score of 33</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Petition#cache_key has approx 9 statements</span>          </div>  </li></ol>
    case
    when new_record?
      &quot;petitions/new&quot;
    when timestamp_names.any?
      timestamp = max_updated_column_timestamp(timestamp_names)
      timestamp = timestamp.change(sec: (timestamp.sec.div(5) * 5))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#cache_key calls 'timestamp.change(sec: (timestamp.sec.div(5) * 5))' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L802" class="js-smell-location">0</a>                  <a href="petition.html#L806" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#cache_key calls 'timestamp.sec' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L802" class="js-smell-location">0</a>                  <a href="petition.html#L806" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#cache_key calls 'timestamp.sec.div(5) * 5' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L802" class="js-smell-location">0</a>                  <a href="petition.html#L806" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#cache_key calls 'timestamp.sec.div(5)' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L802" class="js-smell-location">0</a>                  <a href="petition.html#L806" class="js-smell-location">1</a>                  </div>  </li></ol>
      timestamp = timestamp.utc.to_s(cache_timestamp_format)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#cache_key calls 'timestamp.utc' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L803" class="js-smell-location">0</a>                  <a href="petition.html#L807" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#cache_key calls 'timestamp.utc.to_s(cache_timestamp_format)' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L803" class="js-smell-location">0</a>                  <a href="petition.html#L807" class="js-smell-location">1</a>                  </div>  </li></ol>
      &quot;petitions/#{id}-#{timestamp}&quot;
    when timestamp = max_updated_column_timestamp
      timestamp = timestamp.change(sec: (timestamp.sec.div(5) * 5))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#cache_key calls 'timestamp.change(sec: (timestamp.sec.div(5) * 5))' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L802" class="js-smell-location">0</a>                  <a href="petition.html#L806" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#cache_key calls 'timestamp.sec' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L802" class="js-smell-location">0</a>                  <a href="petition.html#L806" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#cache_key calls 'timestamp.sec.div(5) * 5' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L802" class="js-smell-location">0</a>                  <a href="petition.html#L806" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#cache_key calls 'timestamp.sec.div(5)' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L802" class="js-smell-location">0</a>                  <a href="petition.html#L806" class="js-smell-location">1</a>                  </div>  </li></ol>
      timestamp = timestamp.utc.to_s(cache_timestamp_format)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#cache_key calls 'timestamp.utc' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L803" class="js-smell-location">0</a>                  <a href="petition.html#L807" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Petition#cache_key calls 'timestamp.utc.to_s(cache_timestamp_format)' 2 times</span>              <span>Locations:</span>                  <a href="petition.html#L803" class="js-smell-location">0</a>                  <a href="petition.html#L807" class="js-smell-location">1</a>                  </div>  </li></ol>
      &quot;petitions/#{id}-#{timestamp}&quot;
    else
      &quot;petitions/#{id}&quot;
    end
  end

  def update_last_petition_created_at<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Petition#update_last_petition_created_at doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    Site.last_petition_created_at!
  end

  def has_maximum_sponsors?
    sponsors.validated.count &gt;= Site.maximum_number_of_sponsors
  end

  def update_all(updates)
    self.class.unscoped.where(id: id).update_all(updates)
  end

  def email_requested_receipt!<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Missing-Safe-Method.md" target="_blank"><b>MissingSafeMethod</b></a>        </span>      </div>      <span>Petition has missing safe method 'email_requested_receipt!'</span>          </div>  </li></ol>
    email_requested_receipt || create_email_requested_receipt
  end

  def get_email_requested_at_for(name)
    email_requested_receipt!.get(name)
  end

  def set_email_requested_at_for(name, to: Time.current)
    email_requested_receipt!.set(name, to)
  end

  def signatures_to_email_for(name)
    timestamp = get_email_requested_at_for(name)
    raise ArgumentError if timestamp.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Petition#signatures_to_email_for performs a nil-check</span>          </div>  </li></ol>
    signatures.need_emailing_for(name, since: timestamp)
  end

  def awaiting_debate?
    debate_state.in?(%w[awaiting scheduled])
  end

  def debated?
    debate_state == &#39;debated&#39;
  end

  def not_debated?
    debate_state == &#39;not_debated&#39;
  end

  def update_debate_state
    self.debate_state = evaluate_debate_state
  end

  def evaluate_debate_state
    if scheduled_debate_date?
      scheduled_debate_date &gt; Date.current ? &#39;scheduled&#39; : &#39;debated&#39;
    else
      &#39;awaiting&#39;
    end
  end

  def fraudulent_domains
    @fraudulent_domains ||= signatures.fraudulent_domains
  end

  def fraudulent_domains?
    !fraudulent_domains.empty?
  end

  def closed_early_due_to_election?(dissolution_at = Parliament.dissolution_at)
    closed_at == dissolution_at
  end

  def update_moderation_lag
    if open_at_changed? || rejected_at_changed?
      self.moderation_lag = calculate_moderation_lag(Date.current)
    end
  end

  def calculate_moderation_lag(today)
    if moderation_threshold_reached_at?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Petition tests 'moderation_threshold_reached_at?' at least 3 times</span>              <span>Locations:</span>                  <a href="petition.html#L544" class="js-smell-location">0</a>                  <a href="petition.html#L550" class="js-smell-location">1</a>                  <a href="petition.html#L887" class="js-smell-location">2</a>                  </div>  </li></ol>
      today - moderation_threshold_reached_at.to_date
    else
      0
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- JavaScripts -->
    <script src='../../assets/javascripts/jquery.min.js'></script>
    <script src='../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../assets/javascripts/prettify.js'></script>
    <script src='../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../assets/javascripts/application.js'></script>
    <script src='../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>

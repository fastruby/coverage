<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../overview.html"><img src="../../assets/images/logo.png" alt="Ruby Critic Logo" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
      
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2019-07-17 16:30:32 +0100'>2019-07-17 16:30:32 +0100</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/jobs /</small> update_signature_counts_job_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">336</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">7</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">919.86</span><small> complexity</small></div>
              <div><span class="metric">312</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                18
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;rails_helper&#39;

RSpec.describe UpdateSignatureCountsJob, type: :job do
  let(:current_time) { Time.current.change(usec: 0) }
  let(:interval) { 30 }
  let(:scheduled_time) { interval.seconds.since(current_time) }

  before do
    Site.signature_count_updated_at!(current_time - 60.seconds)
    allow(Site).to receive(:signature_count_interval).and_return(interval)
    allow(ENV).to receive(:[]).and_call_original
    allow(ENV).to receive(:[]).with(&quot;INLINE_UPDATES&quot;).and_return(&quot;false&quot;)
  end

  context &quot;when signature count updating is disabled&quot; do
    before do
      allow(Site).to receive(:update_signature_counts).and_return(false)
    end

    it &quot;doesn&#39;t update Site#signature_count_updated_at&quot; do
      expect {
        described_class.perform_now(current_time.iso8601)
      }.not_to change {
        Site.signature_count_updated_at
      }
    end

    it &quot;doesn&#39;t reschedule another job&quot; do
      expect {
        described_class.perform_now(current_time.iso8601)
      }.not_to have_enqueued_job(described_class)
    end
  end

  context &quot;when signature count updating is enabled&quot; do
    before do
      allow(Site).to receive(:update_signature_counts).and_return(true)
    end

    it &quot;updates Site#signature_count_updated_at&quot; do
      expect {
        described_class.perform_now(current_time.iso8601)
      }.to change {
        Site.signature_count_updated_at
      }.to(current_time - 30.seconds)
    end

    it &quot;reschedules another job&quot; do
      expect {
        described_class.perform_now(current_time.iso8601)
      }.to have_enqueued_job(described_class).on_queue(&quot;highest_priority&quot;).at(scheduled_time)
    end

    describe &quot;updating&quot; do
      let(:location) { FactoryBot.create(:location, code: &quot;AA&quot;, name: &quot;Country 1&quot;) }
      let(:country_journal) { CountryPetitionJournal.for(petition, location.code) }
      let(:constituency_journal) { ConstituencyPetitionJournal.for(petition, &quot;9999&quot;) }

      before do
        # FIXME: reset the signature count to ensure it&#39;s valid because
        # the factories don&#39;t leave the petition in a consistent state.
        petition.update_signature_count!(current_time - 60.seconds)
      end

      context &quot;with an open petition&quot; do
        let(:petition) { FactoryBot.create(:open_petition) }
        let(:attributes) { { petition: petition, location_code: location.code, constituency_id: &quot;9999&quot; } }
        let(:signatures) { FactoryBot.create_list(:pending_signature, 5, attributes) }

        before do
          signatures.each do |signature|
            signature.validate!(current_time - 45.seconds)
          end
        end

        it &quot;updates the signature count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with an open petition)::it#updates the signature count has a flog score of 25</span>          </div>  </li></ol>
          expect {
            described_class.perform_now(current_time.iso8601)
          }.to change {
            petition.reload.signature_count
          }.by(5)
        end

        it &quot;updates the country journal signature_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with an open petition)::it#updates the country journal signature_count has a flog score of 25</span>          </div>  </li></ol>
          expect {
            described_class.perform_now(current_time.iso8601)
          }.to change {
            country_journal.reload.signature_count
          }.by(5)
        end

        it &quot;updates the constituency journal signature_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with an open petition)::it#updates the constituency journal signature_count has a flog score of 25</span>          </div>  </li></ol>
          expect {
            described_class.perform_now(current_time.iso8601)
          }.to change {
            constituency_journal.reload.signature_count
          }.by(5)
        end
      end

      context &quot;with a pending petition&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context#with a pending petition has a flog score of 28</span>          </div>  </li></ol>
        let(:petition) { FactoryBot.create(:pending_petition) }
        let(:attributes) { { petition: petition, location_code: location.code, constituency_id: &quot;9999&quot; } }
        let(:signatures) { FactoryBot.create_list(:pending_signature, 5, attributes) }

        before do
          signatures.each do |signature|
            signature.validate!(current_time - 45.seconds)
          end

          # A new petition won&#39;t have been counted yet so we need
          # to reset last_signed_at back to nil after the FIXME above.
          petition.update_columns(last_signed_at: nil)
          country_journal.update_columns(last_signed_at: nil)
          constituency_journal.update_columns(last_signed_at: nil)
        end

        it &quot;updates the signature count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with a pending petition)::it#updates the signature count has a flog score of 25</span>          </div>  </li></ol>
          # This changes by 6 because the creator is validated by the first signature
          expect {
            described_class.perform_now(current_time.iso8601)
          }.to change {
            petition.reload.signature_count
          }.by(6)
        end

        it &quot;updates the country journal signature_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with a pending petition)::it#updates the country journal signature_count has a flog score of 25</span>          </div>  </li></ol>
          expect {
            described_class.perform_now(current_time.iso8601)
          }.to change {
            country_journal.reload.signature_count
          }.by(5)
        end

        it &quot;updates the constituency journal signature_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with a pending petition)::it#updates the constituency journal signature_count has a flog score of 25</span>          </div>  </li></ol>
          expect {
            described_class.perform_now(current_time.iso8601)
          }.to change {
            constituency_journal.reload.signature_count
          }.by(5)
        end
      end

      context &quot;with a pending petition that&#39;s had its creator validated after the current time window&quot; do
        let(:petition) { FactoryBot.create(:pending_petition, creator_attributes: { location_code: location.code, constituency_id: &quot;9999&quot; }) }

        before do
          # A new petition won&#39;t have been counted yet so we need
          # to reset last_signed_at back to nil after the FIXME above.
          petition.update_columns(last_signed_at: nil)

          # Ensure that the signature falls within the expected window
          travel_to (1.second.ago) do
            petition.validate_creator!
          end
        end

        it &quot;doesn&#39;t update the siganture count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li></ol>
          expect {
            described_class.perform_now(current_time.iso8601)
          }.not_to change {
            petition.reload.signature_count
          }.from(0)
        end

        it &quot;doesn&#39;t update the country journal signature_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li></ol>
          expect {
            described_class.perform_now(current_time.iso8601)
          }.not_to change {
            country_journal.reload.signature_count
          }.from(0)
        end

        it &quot;doesn&#39;t update the constituency journal signature_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li></ol>
          expect {
            described_class.perform_now(current_time.iso8601)
          }.not_to change {
            constituency_journal.reload.signature_count
          }.from(0)
        end

        context &quot;and when the next time window occurs&quot; do
          let(:next_time) { current_time + interval.seconds }

          it &quot;updates the siganture count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L185" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L193" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L201" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with a pending petition that's had its creator validated after the current time window)::context(and when the next time window occurs)::it#updates the siganture count has a flog score of 29</span>          </div>  </li></ol>
            expect {
              described_class.perform_now(next_time.iso8601)
            }.to change {
              petition.reload.signature_count
            }.from(0).to(1)
          end

          it &quot;updates the country journal signature_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L185" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L193" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L201" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with a pending petition that's had its creator validated after the current time window)::context(and when the next time window occurs)::it#updates the country journal signature_count has a flog score of 29</span>          </div>  </li></ol>
            expect {
              described_class.perform_now(next_time.iso8601)
            }.to change {
              country_journal.reload.signature_count
            }.from(0).to(1)
          end

          it &quot;updates the constituency journal signature_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L185" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L193" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L201" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with a pending petition that's had its creator validated after the current time window)::context(and when the next time window occurs)::it#updates the constituency journal signature_count has a flog score of 29</span>          </div>  </li></ol>
            expect {
              described_class.perform_now(next_time.iso8601)
            }.to change {
              constituency_journal.reload.signature_count
            }.from(0).to(1)
          end
        end

        context &quot;and when the next time window occurs after that&quot; do
          let(:next_time) { current_time + interval.seconds }
          let(:third_time) { next_time + interval.seconds }

          before do
            described_class.perform_now(next_time.iso8601)
          end

          it &quot;doesn&#39;t update the siganture count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with a pending petition that's had its creator validated after the current time window)::context(and when the next time window occurs after that)::it#doesn't update the siganture count has a flog score of 26</span>          </div>  </li></ol>
            expect {
              described_class.perform_now(third_time.iso8601)
            }.not_to change {
              petition.reload.signature_count
            }.from(1)
          end

          it &quot;doesn&#39;t update the constituency journal signature_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with a pending petition that's had its creator validated after the current time window)::context(and when the next time window occurs after that)::it#doesn't update the constituency journal signature_count has a flog score of 26</span>          </div>  </li></ol>
            expect {
              described_class.perform_now(third_time.iso8601)
            }.not_to change {
              constituency_journal.reload.signature_count
            }.from(1)
          end

          it &quot;doesn&#39;t update the country journal signature_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with a pending petition that's had its creator validated after the current time window)::context(and when the next time window occurs after that)::it#doesn't update the country journal signature_count has a flog score of 26</span>          </div>  </li></ol>
            expect {
              described_class.perform_now(third_time.iso8601)
            }.not_to change {
              country_journal.reload.signature_count
            }.from(1)
          end
        end
      end

      context &quot;with a validated petition&quot; do
        let(:petition) { FactoryBot.create(:validated_petition) }
        let(:attributes) { { petition: petition, location_code: &quot;AA&quot;, constituency_id: &quot;9999&quot; } }
        let(:signatures) { FactoryBot.create_list(:pending_signature, 5, attributes) }

        before do
          signatures.each do |signature|
            signature.validate!(current_time - 45.seconds)
          end
        end

        it &quot;updates the signature count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with a validated petition)::it#updates the signature count has a flog score of 25</span>          </div>  </li></ol>
          expect {
            described_class.perform_now(current_time.iso8601)
          }.to change {
            petition.reload.signature_count
          }.by(5)
        end

        it &quot;updates the country journal signature_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with a validated petition)::it#updates the country journal signature_count has a flog score of 25</span>          </div>  </li></ol>
          expect {
            described_class.perform_now(current_time.iso8601)
          }.to change {
            country_journal.reload.signature_count
          }.by(5)
        end

        it &quot;updates the constituency journal signature_count&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="update_signature_counts_job_spec.html#L76" class="js-smell-location">0</a>                  <a href="update_signature_counts_job_spec.html#L84" class="js-smell-location">1</a>                  <a href="update_signature_counts_job_spec.html#L92" class="js-smell-location">2</a>                  <a href="update_signature_counts_job_spec.html#L118" class="js-smell-location">3</a>                  <a href="update_signature_counts_job_spec.html#L127" class="js-smell-location">4</a>                  <a href="update_signature_counts_job_spec.html#L135" class="js-smell-location">5</a>                  <a href="update_signature_counts_job_spec.html#L158" class="js-smell-location">6</a>                  <a href="update_signature_counts_job_spec.html#L166" class="js-smell-location">7</a>                  <a href="update_signature_counts_job_spec.html#L174" class="js-smell-location">8</a>                  <a href="update_signature_counts_job_spec.html#L218" class="js-smell-location">9</a>                  <a href="update_signature_counts_job_spec.html#L226" class="js-smell-location">10</a>                  <a href="update_signature_counts_job_spec.html#L234" class="js-smell-location">11</a>                  <a href="update_signature_counts_job_spec.html#L255" class="js-smell-location">12</a>                  <a href="update_signature_counts_job_spec.html#L263" class="js-smell-location">13</a>                  <a href="update_signature_counts_job_spec.html#L271" class="js-smell-location">14</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden="true"></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>context(when signature count updating is enabled)::describe(updating)::context(with a validated petition)::it#updates the constituency journal signature_count has a flog score of 25</span>          </div>  </li></ol>
          expect {
            described_class.perform_now(current_time.iso8601)
          }.to change {
            constituency_journal.reload.signature_count
          }.by(5)
        end
      end

      context &quot;with a petition that&#39;s having its count reset&quot; do
        let(:petition) { FactoryBot.create(:open_petition, signature_count_reset_at: current_time) }
        let(:attributes) { { petition: petition, location_code: &quot;AA&quot;, constituency_id: &quot;9999&quot; } }
        let(:signatures) { FactoryBot.create_list(:pending_signature, 5, attributes) }

        before do
          signatures.each do |signature|
            signature.validate!(current_time - 45.seconds)
          end
        end

        it &quot;doesn&#39;t update the signature count&quot; do
          expect {
            described_class.perform_now(current_time.iso8601)
          }.not_to change {
            petition.reload.signature_count
          }
        end

        it &quot;doesn&#39;t update the country journal signature_count&quot; do
          expect {
            described_class.perform_now(current_time.iso8601)
          }.not_to change {
            country_journal.reload.signature_count
          }
        end

        it &quot;doesn&#39;t update the constituency journal signature_count&quot; do
          expect {
            described_class.perform_now(current_time.iso8601)
          }.not_to change {
            constituency_journal.reload.signature_count
          }
        end
      end

      context &quot;with a petition that&#39;s having its count reset for more than 5 minutes&quot; do
        let(:petition) { FactoryBot.create(:open_petition, signature_count_reset_at: 10.minutes.ago) }
        let(:attributes) { { petition: petition, location_code: &quot;AA&quot;, constituency_id: &quot;9999&quot; } }
        let(:signatures) { FactoryBot.create_list(:pending_signature, 5, attributes) }

        before do
          signatures.each do |signature|
            signature.validate!(current_time - 45.seconds)
          end

          allow(Appsignal).to receive(:send_exception)
        end

        it &quot;notifies Appsignal&quot; do
          described_class.perform_now(current_time.iso8601)
          expect(Appsignal).to have_received(:send_exception).with(an_instance_of(RuntimeError))
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- JavaScripts -->
    <script src='../../assets/javascripts/jquery.min.js'></script>
    <script src='../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../assets/javascripts/prettify.js'></script>
    <script src='../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../assets/javascripts/application.js'></script>
    <script src='../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
